import{a as M}from"./chunk-XHNAPF2T.js";import{a as I}from"./chunk-FQB7FWF7.js";import{T as x,Y as g,g as w,ic as O}from"./chunk-DEIGHZUX.js";import{a as b,b as _,i as c}from"./chunk-P2VZOJAX.js";function y(h){return h.map(E=>`${E.part_number}:${E.qty_per_unit}`).sort().join("|")}var v=(()=>{class h{constructor(t,e,r){this.supabase=t,this.demoMode=e,this.demoData=r,this.templatesSubject=new w([]),this.loadingSubject=new w(!0),this.errorSubject=new w(null),this.subscription=null,this.templates$=this.templatesSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable(),this.fetchTemplates(),this.demoMode.isDemoMode()||this.setupRealtimeSubscription()}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}setupRealtimeSubscription(){this.demoMode.isDemoMode()||(this.subscription=this.supabase.channel("bom-templates-changes").on("postgres_changes",{event:"*",schema:"public",table:"bom_templates"},()=>this.fetchTemplates()).subscribe())}fetchAllRows(t,e){return c(this,null,function*(){let s=[],l=0,p=!0;for(;p;){let o=this.supabase.from(t).select("*");if(e)for(let[a,m]of Object.entries(e))o=o.eq(a,m);o=o.range(l*1e3,(l+1)*1e3-1);let{data:n,error:u}=yield o;if(u)throw u;n&&n.length>0?(s=s.concat(n),p=n.length===1e3,l++):p=!1}return s})}fetchTemplates(){return c(this,null,function*(){try{if(this.loadingSubject.next(!0),this.errorSubject.next(null),this.demoMode.isDemoMode()){let r=this.demoData.getBOMTemplates();this.templatesSubject.next(r),this.loadingSubject.next(!1);return}let{data:t,error:e}=yield this.supabase.from("bom_templates").select("*").order("name");if(e)throw e;this.templatesSubject.next(t||[])}catch(t){this.errorSubject.next(t instanceof Error?t.message:"Failed to fetch BOM templates")}finally{this.loadingSubject.next(!1)}})}getTemplateWithItems(t){return c(this,null,function*(){try{if(this.demoMode.isDemoMode()){let l=this.demoData.getBOMTemplates().find(o=>o.id===t);if(!l)return null;let p=this.demoData.getBOMTemplateItems(t);return _(b({},l),{items:p})}let e=yield this.supabase.from("bom_templates").select("*").eq("id",t).single();if(e.error)throw e.error;let r=yield this.fetchAllRows("bom_template_items",{template_id:t});return _(b({},e.data),{items:r})}catch(e){return this.errorSubject.next(e instanceof Error?e.message:"Failed to fetch template"),null}})}createTemplateFromOrder(t,e,r){return c(this,null,function*(){try{let{data:s,error:l}=yield this.supabase.from("bom_templates").insert({name:t,tool_model:e}).select().single();if(l)throw l;let p=r.map(n=>({template_id:s.id,part_number:n.part_number,description:n.description,location:n.location,qty_per_unit:n.qty_per_unit,assembly_group:n.assembly_group||null})),{error:o}=yield this.supabase.from("bom_template_items").insert(p);if(o)throw o;return yield this.fetchTemplates(),s}catch(s){return this.errorSubject.next(s instanceof Error?s.message:"Failed to create template"),null}})}createTemplate(t,e,r="bom"){return c(this,null,function*(){try{let{data:s,error:l}=yield this.supabase.from("bom_templates").insert({name:t,tool_model:e||null,template_type:r}).select().single();if(l)throw l;return yield this.fetchTemplates(),s}catch(s){return this.errorSubject.next(s instanceof Error?s.message:"Failed to create template"),null}})}updateTemplate(t,e){return c(this,null,function*(){try{let{error:r}=yield this.supabase.from("bom_templates").update(_(b({},e),{updated_at:new Date().toISOString()})).eq("id",t);if(r)throw r;return yield this.fetchTemplates(),!0}catch(r){return this.errorSubject.next(r instanceof Error?r.message:"Failed to update template"),!1}})}deleteTemplate(t){return c(this,null,function*(){try{let{error:e}=yield this.supabase.from("bom_templates").delete().eq("id",t);if(e)throw e;return yield this.fetchTemplates(),!0}catch(e){return this.errorSubject.next(e instanceof Error?e.message:"Failed to delete template"),!1}})}addTemplateItem(t,e){return c(this,null,function*(){try{let{data:r,error:s}=yield this.supabase.from("bom_template_items").insert(b({template_id:t},e)).select().single();if(s)throw s;return r}catch(r){return this.errorSubject.next(r instanceof Error?r.message:"Failed to add template item"),null}})}updateTemplateItem(t,e){return c(this,null,function*(){try{let{error:r}=yield this.supabase.from("bom_template_items").update(e).eq("id",t);if(r)throw r;return!0}catch(r){return this.errorSubject.next(r instanceof Error?r.message:"Failed to update template item"),!1}})}deleteTemplateItem(t){return c(this,null,function*(){try{let{error:e}=yield this.supabase.from("bom_template_items").delete().eq("id",t);if(e)throw e;return!0}catch(e){return this.errorSubject.next(e instanceof Error?e.message:"Failed to delete template item"),!1}})}extractTemplatesFromOrders(){return c(this,null,function*(){let t={created:0,skipped:0,errors:[]};try{let e=yield this.fetchAllRows("orders"),r=yield this.fetchAllRows("line_items"),s={};for(let a of r)s[a.order_id]||(s[a.order_id]=[]),s[a.order_id].push(a);let l=yield this.fetchAllRows("bom_templates"),p=yield this.fetchAllRows("bom_template_items"),o={};for(let a of p)o[a.template_id]||(o[a.template_id]=[]),o[a.template_id].push(a);let n=new Set;for(let a of l){let m=o[a.id]||[];n.add(y(m))}let u={};for(let a of e){let m=s[a.id];if(!m||m.length===0)continue;let d=y(m);u[d]||(u[d]={order:a,lineItems:m})}for(let[a,{order:m,lineItems:d}]of Object.entries(u)){if(n.has(a)){t.skipped++;continue}try{let i=m.tool_model?`${m.tool_model} BOM`:`SO-${m.so_number} BOM`,{data:S,error:T}=yield this.supabase.from("bom_templates").insert({name:i,tool_model:m.tool_model||null}).select().single();if(T)throw T;let F=d.map(f=>({template_id:S.id,part_number:f.part_number,description:f.description,location:f.location,qty_per_unit:f.qty_per_unit,assembly_group:f.assembly_group||null})),{error:j}=yield this.supabase.from("bom_template_items").insert(F);if(j)throw j;n.add(a),t.created++}catch(i){t.errors.push(`Failed to create template for SO-${m.so_number}: ${i instanceof Error?i.message:String(i)}`)}}yield this.fetchTemplates()}catch(e){t.errors.push(e instanceof Error?e.message:"Failed to extract templates")}return t})}autoExtractTemplate(t,e,r){return c(this,null,function*(){try{let s=y(t),l=yield this.fetchAllRows("bom_templates"),p=yield this.fetchAllRows("bom_template_items"),o={};for(let i of p)o[i.template_id]||(o[i.template_id]=[]),o[i.template_id].push(i);for(let i of l){let S=o[i.id]||[];if(y(S)===s)return{matched:!0}}let n=e?`${e} BOM`:`SO-${r} BOM`,{data:u,error:a}=yield this.supabase.from("bom_templates").insert({name:n,tool_model:e||null}).select().single();if(a)throw a;let m=t.map(i=>({template_id:u.id,part_number:i.part_number,description:i.description||null,location:i.location||null,qty_per_unit:i.qty_per_unit,assembly_group:i.assembly_group||null})),{error:d}=yield this.supabase.from("bom_template_items").insert(m);if(d)throw d;return yield this.fetchTemplates(),{matched:!1,templateId:u.id,templateName:n}}catch{return{matched:!0}}})}static{this.\u0275fac=function(e){return new(e||h)(g(O),g(I),g(M))}}static{this.\u0275prov=x({token:h,factory:h.\u0275fac,providedIn:"root"})}}return h})();export{v as a};
