import{T as f,Y as b,g as u,ic as g}from"./chunk-DEIGHZUX.js";import{a as w,b as _,i}from"./chunk-P2VZOJAX.js";var E=(()=>{class l{constructor(t){this.supabase=t,this.partsSubject=new u([]),this.loadingSubject=new u(!0),this.errorSubject=new u(null),this.subscription=null,this.parts$=this.partsSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable(),this.fetchParts(),this.setupRealtimeSubscription()}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}setupRealtimeSubscription(){this.subscription=this.supabase.channel("parts_changes").on("postgres_changes",{event:"*",schema:"public",table:"parts"},()=>this.fetchParts()).subscribe()}fetchParts(){return i(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let{data:t,error:r}=yield this.supabase.from("parts_with_stats").select("*").order("part_number",{ascending:!0});if(r)throw r;this.partsSubject.next(t||[])}catch(t){console.error("Error fetching parts:",t),this.errorSubject.next(t instanceof Error?t.message:"Failed to fetch parts")}finally{this.loadingSubject.next(!1)}})}createPart(t){return i(this,null,function*(){try{let{data:r,error:e}=yield this.supabase.from("parts").insert([t]).select().single();if(e)throw e;return yield this.fetchParts(),r}catch(r){throw console.error("Error creating part:",r),r}})}updatePart(t,r){return i(this,null,function*(){try{let{data:e,error:a}=yield this.supabase.from("parts").update(r).eq("id",t).select().single();if(a)throw a;return yield this.fetchParts(),e}catch(e){throw console.error("Error updating part:",e),e}})}deletePart(t){return i(this,null,function*(){try{let{error:r}=yield this.supabase.from("parts").delete().eq("id",t);if(r)throw r;yield this.fetchParts()}catch(r){throw console.error("Error deleting part:",r),r}})}getPartById(t){return i(this,null,function*(){try{let{data:r,error:e}=yield this.supabase.from("parts").select("*").eq("id",t).single();if(e)throw e;return r}catch(r){return console.error("Error fetching part:",r),null}})}getPartByPartNumber(t){return i(this,null,function*(){try{let{data:r,error:e}=yield this.supabase.from("parts").select("*").eq("part_number",t).single();if(e){if(e.code==="PGRST116")return null;throw e}return r}catch(r){return console.error("Error fetching part by part number:",r),null}})}findOrCreatePart(t,r,e,a){return i(this,null,function*(){let s=yield this.getPartByPartNumber(t);if(s){let o={};r&&!s.description&&(o.description=r),e&&!s.default_location&&(o.default_location=e),a&&!s.classification_type&&(o.classification_type=a),Object.keys(o).length>0&&(s=yield this.updatePart(s.id,o))}else s=yield this.createPart({part_number:t,description:r||null,default_location:e||null,classification_type:a||null,is_assembly:!1,is_modified:!1,base_part_id:null,notes:null});if(!s)throw new Error(`Failed to find or create part: ${t}`);return s})}getPartWithRelationships(t){return i(this,null,function*(){try{let{data:r,error:e}=yield this.supabase.from("parts").select("*").eq("id",t).single();if(e)throw e;let{data:a,error:s}=yield this.supabase.from("part_relationships").select(`
          *,
          part:child_part_id (*)
        `).eq("parent_part_id",t).order("sort_order",{ascending:!0});if(s)throw s;let{data:o,error:n}=yield this.supabase.from("part_relationships").select(`
          *,
          part:parent_part_id (*)
        `).eq("child_part_id",t);if(n)throw n;let c;if(r.base_part_id){let{data:d,error:m}=yield this.supabase.from("parts").select("*").eq("id",r.base_part_id).single();m||(c=d)}let{data:h,error:p}=yield this.supabase.from("parts").select("*").eq("base_part_id",t);if(p)throw p;return _(w({},r),{children:a||[],used_in:o||[],base_part:c,modifications:h||[]})}catch(r){return console.error("Error fetching part with relationships:",r),null}})}getExplodedBOM(t){return i(this,null,function*(){try{let{data:r,error:e}=yield this.supabase.from("parts_exploded_bom").select("*").eq("parent_part_id",t).order("part_number",{ascending:!0});if(e)throw e;return r||[]}catch(r){return console.error("Error fetching exploded BOM:",r),[]}})}getModificationChain(t){return i(this,null,function*(){try{let r=[],e=t,a=0,s=[];for(;e;){let c=yield this.getPartById(e);if(!c||(s.unshift(c),e=c.base_part_id,a++>10))break}s.forEach((c,h)=>{r.push({part:c,level:h})});let o=(c,h)=>i(this,null,function*(){let{data:p}=yield this.supabase.from("parts").select("*").eq("base_part_id",c);if(p)for(let d of p)r.push({part:d,level:h+1}),yield o(d.id,h+1)}),n=s[s.length-1];return n&&(yield o(n.id,s.length-1)),r.sort((c,h)=>c.level-h.level)}catch(r){return console.error("Error getting modification chain:",r),[]}})}refetch(){return this.fetchParts()}static{this.\u0275fac=function(r){return new(r||l)(b(g))}}static{this.\u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"})}}return l})();var k=(()=>{class l{constructor(t){this.supabase=t,this.loadingSubject=new u(!1),this.errorSubject=new u(null),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable()}checkCircularReference(t,r){return i(this,null,function*(){try{let{data:e,error:a}=yield this.supabase.rpc("would_create_cycle",{p_parent_id:t,p_child_id:r});if(a)throw a;return e===!0?{would_cycle:!0,message:"Adding this relationship would create a circular assembly reference. This may cause issues with BOM explosion and inventory tracking."}:{would_cycle:!1,message:""}}catch(e){return console.error("Error checking circular reference:",e),{would_cycle:!0,message:"Unable to verify if this would create a circular reference. Proceed with caution."}}})}createRelationship(t,r,e,a){return i(this,null,function*(){try{if(this.loadingSubject.next(!0),this.errorSubject.next(null),!a?.skipCircularCheck){let n=yield this.checkCircularReference(t,r);if(n.would_cycle)throw new Error(n.message)}let{data:s,error:o}=yield this.supabase.from("part_relationships").insert([{parent_part_id:t,child_part_id:r,quantity:e,reference_designator:a?.referenceDesignator||null,notes:a?.notes||null,sort_order:a?.sortOrder||0}]).select().single();if(o)throw o;return s}catch(s){let o=s instanceof Error?s.message:"Failed to create relationship";throw console.error("Error creating relationship:",s),this.errorSubject.next(o),s}finally{this.loadingSubject.next(!1)}})}updateRelationship(t,r){return i(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let{data:e,error:a}=yield this.supabase.from("part_relationships").update(r).eq("id",t).select().single();if(a)throw a;return e}catch(e){let a=e instanceof Error?e.message:"Failed to update relationship";throw console.error("Error updating relationship:",e),this.errorSubject.next(a),e}finally{this.loadingSubject.next(!1)}})}deleteRelationship(t){return i(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let{error:r}=yield this.supabase.from("part_relationships").delete().eq("id",t);if(r)throw r}catch(r){let e=r instanceof Error?r.message:"Failed to delete relationship";throw console.error("Error deleting relationship:",r),this.errorSubject.next(e),r}finally{this.loadingSubject.next(!1)}})}getRelationshipsByParent(t){return i(this,null,function*(){try{let{data:r,error:e}=yield this.supabase.from("part_relationships").select("*").eq("parent_part_id",t).order("sort_order",{ascending:!0});if(e)throw e;return r||[]}catch(r){return console.error("Error fetching relationships by parent:",r),[]}})}getRelationshipsByChild(t){return i(this,null,function*(){try{let{data:r,error:e}=yield this.supabase.from("part_relationships").select("*").eq("child_part_id",t);if(e)throw e;return r||[]}catch(r){return console.error("Error fetching relationships by child:",r),[]}})}reorderRelationships(t,r){return i(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let e=r.map((a,s)=>({id:a,sort_order:s}));for(let a of e)yield this.supabase.from("part_relationships").update({sort_order:a.sort_order}).eq("id",a.id)}catch(e){let a=e instanceof Error?e.message:"Failed to reorder relationships";throw console.error("Error reordering relationships:",e),this.errorSubject.next(a),e}finally{this.loadingSubject.next(!1)}})}bulkCreateRelationships(t,r,e){return i(this,null,function*(){try{if(this.loadingSubject.next(!0),this.errorSubject.next(null),!e?.skipCircularCheck)for(let n of r){let c=yield this.checkCircularReference(t,n.childId);if(c.would_cycle)throw new Error(`${c.message} (Part: ${n.childId})`)}let a=r.map((n,c)=>({parent_part_id:t,child_part_id:n.childId,quantity:n.quantity,reference_designator:n.referenceDesignator||null,notes:n.notes||null,sort_order:n.sortOrder??c})),{data:s,error:o}=yield this.supabase.from("part_relationships").insert(a).select();if(o)throw o;return s||[]}catch(a){let s=a instanceof Error?a.message:"Failed to create relationships";throw console.error("Error bulk creating relationships:",a),this.errorSubject.next(s),a}finally{this.loadingSubject.next(!1)}})}static{this.\u0275fac=function(r){return new(r||l)(b(g))}}static{this.\u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"})}}return l})();export{E as a,k as b};
