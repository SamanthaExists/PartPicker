import{a as xe}from"./chunk-VFKV6LVJ.js";import{a as Se}from"./chunk-3RS5Y76G.js";import{a as ye}from"./chunk-HWGX3DK4.js";import{a as be}from"./chunk-JMCLK4XY.js";import{a as ae}from"./chunk-KMPFFIFL.js";import{a as Ce}from"./chunk-TIC6WQIR.js";import{e as _e,i as fe}from"./chunk-SJKOT4HS.js";import{a as oe,b as re}from"./chunk-SJCJM33I.js";import{a as ge,b as te,c as ie,f as ne,h as he,m as ve,n as Y}from"./chunk-ACCF75FY.js";import{$a as b,$b as H,Ca as l,Da as L,Sa as y,T as de,Ta as se,Ua as c,Va as Z,Wa as B,Xa as $,Y as le,Za as i,_a as n,ab as ce,ac as J,bb as pe,ca as G,cb as N,db as g,dc as X,eb as m,ka as u,la as _,mb as o,nb as C,ob as E,pb as ue,qb as ee,rb as O,sa as z,sb as V,tb as R,vb as K}from"./chunk-2TFJQIGG.js";import{e as W}from"./chunk-DVOCWXDE.js";function De(a,d){a&1&&(i(0,"div",20)(1,"div",21)(2,"span",22),o(3,"Loading..."),n()(),i(4,"p",23),o(5,"Loading templates..."),n()())}function Oe(a,d){if(a&1&&(i(0,"div",24),b(1,"i",25),i(2,"p",26),o(3),n(),i(4,"p",27),o(5,"Save an order as a template to see it here."),n()()),a&2){let e=m();l(3),C(e.searchQuery?"No templates match your search":"No templates available")}}function Ve(a,d){if(a&1&&(i(0,"span",37),o(1),n()),a&2){let e=m().$implicit;l(),C(e.tool_model)}}function Re(a,d){if(a&1&&(i(0,"span",38),o(1),n()),a&2){let e=m(3);l(),E(" ",e.selectedItemsCount," parts ")}}function Ne(a,d){a&1&&b(0,"i",39)}function Fe(a,d){a&1&&b(0,"i",40)}function Be(a,d){if(a&1){let e=N();i(0,"button",30),g("click",function(){let t=u(e).$implicit,s=m(2);return _(s.selectTemplate(t))}),i(1,"div")(2,"strong"),o(3),n(),y(4,Ve,2,1,"span",31),i(5,"div",32),o(6),n()(),i(7,"div",33),y(8,Re,2,1,"span",34)(9,Ne,1,0,"i",35)(10,Fe,1,0,"i",36),n()()}if(a&2){let e=d.$implicit,r=m(2);B("active",r.selectedTemplateId===e.id),l(3),C(e.name),l(),c("ngIf",e.tool_model),l(2),E(" Created: ",r.formatDate(e.created_at)," "),l(2),c("ngIf",r.selectedTemplateId===e.id&&r.selectedItemsCount>0),l(),c("ngIf",r.selectedTemplateId!==e.id),l(),c("ngIf",r.selectedTemplateId===e.id)}}function We(a,d){if(a&1&&(i(0,"div",28),y(1,Be,11,8,"button",29),n()),a&2){let e=m();l(),c("ngForOf",e.filteredTemplates)}}function Le(a,d){if(a&1&&(i(0,"tr")(1,"td",48),o(2),n(),i(3,"td",49),o(4),n(),i(5,"td",45),o(6),n()()),a&2){let e=d.$implicit;l(2),C(e.part_number),l(2),C(e.description||"-"),l(2),C(e.qty_per_unit)}}function qe(a,d){if(a&1&&(i(0,"p",50),o(1),n()),a&2){let e=m(2);l(),E(" ...and ",e.selectedTemplate.items.length-10," more parts ")}}function Ae(a,d){if(a&1&&(i(0,"div",41)(1,"div",42)(2,"strong"),o(3),n(),i(4,"span",38),o(5),n()(),i(6,"div",43)(7,"table",44)(8,"thead")(9,"tr")(10,"th"),o(11,"Part Number"),n(),i(12,"th"),o(13,"Description"),n(),i(14,"th",45),o(15,"Qty/Unit"),n()()(),i(16,"tbody"),y(17,Le,7,3,"tr",46),n()(),y(18,qe,2,1,"p",47),n()()),a&2){let e=m();l(3),C(e.selectedTemplate.name),l(2),E("",e.selectedTemplate.items.length," parts"),l(12),c("ngForOf",e.selectedTemplate.items.slice(0,10)),l(),c("ngIf",e.selectedTemplate.items.length>10)}}function Ue(a,d){a&1&&b(0,"div",51)}var Ie=(()=>{class a{constructor(e){this.bomTemplatesService=e,this.show=!1,this.showChange=new z,this.templateSelected=new z,this.templates=[],this.loading=!0,this.searchQuery="",this.selectedTemplateId=null,this.selectedTemplate=null,this.selectedItemsCount=0,this.loadingTemplate=!1,this.subscriptions=[]}ngOnInit(){this.subscriptions.push(this.bomTemplatesService.templates$.subscribe(e=>{this.templates=e}),this.bomTemplatesService.loading$.subscribe(e=>{this.loading=e}))}ngOnDestroy(){this.subscriptions.forEach(e=>e.unsubscribe())}get filteredTemplates(){if(!this.searchQuery)return this.templates;let e=this.searchQuery.toLowerCase();return this.templates.filter(r=>r.name.toLowerCase().includes(e)||r.tool_model&&r.tool_model.toLowerCase().includes(e))}selectTemplate(e){return W(this,null,function*(){if(this.selectedTemplateId===e.id)return;this.selectedTemplateId=e.id,this.loadingTemplate=!0;let r=yield this.bomTemplatesService.getTemplateWithItems(e.id);r&&(this.selectedTemplate=r,this.selectedItemsCount=r.items.length),this.loadingTemplate=!1})}formatDate(e){return new Date(e).toLocaleDateString()}close(){this.show=!1,this.showChange.emit(!1),this.selectedTemplateId=null,this.selectedTemplate=null,this.searchQuery=""}confirm(){this.selectedTemplate&&(this.templateSelected.emit(this.selectedTemplate),this.close())}static{this.\u0275fac=function(r){return new(r||a)(L(ae))}}static{this.\u0275cmp=G({type:a,selectors:[["app-template-select-dialog"]],inputs:{show:"show"},outputs:{showChange:"showChange",templateSelected:"templateSelected"},standalone:!0,features:[K],decls:24,vars:14,consts:[["tabindex","-1",1,"modal","fade"],[1,"modal-dialog","modal-lg"],[1,"modal-content"],[1,"modal-header"],[1,"modal-title"],[1,"bi","bi-file-earmark-text","me-2"],["type","button",1,"btn-close",3,"click"],[1,"modal-body"],[1,"text-muted","small","mb-3"],[1,"mb-3"],["type","text","placeholder","Search templates...",1,"form-control",3,"ngModelChange","ngModel"],["class","text-center py-4",4,"ngIf"],["class","text-center py-4 text-muted",4,"ngIf"],["class","list-group","style","max-height: 400px; overflow-y: auto;",4,"ngIf"],["class","mt-3 p-3 border rounded bg-body-secondary",4,"ngIf"],[1,"modal-footer"],["type","button",1,"btn","btn-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click","disabled"],[1,"bi","me-1"],["class","modal-backdrop fade show",4,"ngIf"],[1,"text-center","py-4"],["role","status",1,"spinner-border","spinner-border-sm","text-primary"],[1,"visually-hidden"],[1,"text-muted","small","mt-2","mb-0"],[1,"text-center","py-4","text-muted"],[1,"bi","bi-inbox","display-4","mb-2"],[1,"mb-0"],[1,"small"],[1,"list-group",2,"max-height","400px","overflow-y","auto"],["type","button","class","list-group-item list-group-item-action d-flex justify-content-between align-items-center",3,"active","click",4,"ngFor","ngForOf"],["type","button",1,"list-group-item","list-group-item-action","d-flex","justify-content-between","align-items-center",3,"click"],["class","badge bg-secondary ms-2",4,"ngIf"],[1,"small","text-muted"],[1,"text-end"],["class","badge bg-primary",4,"ngIf"],["class","bi bi-chevron-right text-muted ms-2",4,"ngIf"],["class","bi bi-check-circle-fill text-success ms-2",4,"ngIf"],[1,"badge","bg-secondary","ms-2"],[1,"badge","bg-primary"],[1,"bi","bi-chevron-right","text-muted","ms-2"],[1,"bi","bi-check-circle-fill","text-success","ms-2"],[1,"mt-3","p-3","border","rounded","bg-body-secondary"],[1,"d-flex","justify-content-between","align-items-center","mb-2"],[1,"small","text-muted",2,"max-height","150px","overflow-y","auto"],[1,"table","table-sm","mb-0"],[1,"text-center"],[4,"ngFor","ngForOf"],["class","text-center mt-2 mb-0",4,"ngIf"],[1,"font-monospace"],[1,"text-muted"],[1,"text-center","mt-2","mb-0"],[1,"modal-backdrop","fade","show"]],template:function(r,t){r&1&&(i(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"h5",4),b(5,"i",5),o(6,"Load from BOM Template "),n(),i(7,"button",6),g("click",function(){return t.close()}),n()(),i(8,"div",7)(9,"p",8),o(10," Select a saved BOM template to populate the order with pre-defined parts. "),n(),i(11,"div",9)(12,"input",10),R("ngModelChange",function(p){return V(t.searchQuery,p)||(t.searchQuery=p),p}),n()(),y(13,De,6,0,"div",11)(14,Oe,6,1,"div",12)(15,We,2,1,"div",13)(16,Ae,19,4,"div",14),n(),i(17,"div",15)(18,"button",16),g("click",function(){return t.close()}),o(19,"Cancel"),n(),i(20,"button",17),g("click",function(){return t.confirm()}),b(21,"i",18),o(22),n()()()()(),y(23,Ue,1,0,"div",19)),r&2&&(Z("display",t.show?"block":"none"),B("show",t.show),l(12),O("ngModel",t.searchQuery),l(),c("ngIf",t.loading),l(),c("ngIf",!t.loading&&t.filteredTemplates.length===0),l(),c("ngIf",!t.loading&&t.filteredTemplates.length>0),l(),c("ngIf",t.selectedTemplate),l(4),c("disabled",!t.selectedTemplate||t.loadingTemplate),l(),$(t.loadingTemplate?"bi-arrow-clockwise spin":"bi-check-circle"),l(),E(" ",t.loadingTemplate?"Loading...":"Use Template"," "),l(),c("ngIf",t.show))},dependencies:[X,H,J,Y,te,ie,ne],styles:[".spin[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_spin 1s linear infinite}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}"]})}}return a})();function je(a,d){if(a&1){let e=N();i(0,"tr")(1,"td",25),o(2),n(),i(3,"td"),o(4,"Description"),n(),i(5,"td",26),o(6),n(),i(7,"td",27),o(8),n(),i(9,"td",16)(10,"div",28)(11,"button",29),g("click",function(){u(e);let t=m().$implicit,s=m();return _(s.setAction(t,"keep"))}),o(12," Keep "),n(),i(13,"button",29),g("click",function(){u(e);let t=m().$implicit,s=m();return _(s.setAction(t,"update"))}),o(14," Update "),n()()()()}if(a&2){let e=m().$implicit,r=m();l(),se("rowspan",r.getRowspan(e)),l(),C(e.part_number),l(4),C(e.saved_description||"(empty)"),l(2),C(e.import_description||"(empty)"),l(),se("rowspan",r.getRowspan(e)),l(2),B("btn-outline-secondary",e.action!=="keep")("btn-secondary",e.action==="keep"),l(2),B("btn-outline-primary",e.action!=="update")("btn-primary",e.action==="update")}}function Qe(a,d){if(a&1){let e=N();i(0,"tr")(1,"td",25),o(2),n(),i(3,"td"),o(4,"Location"),n(),i(5,"td",26),o(6),n(),i(7,"td",27),o(8),n(),i(9,"td",16)(10,"div",28)(11,"button",29),g("click",function(){u(e);let t=m().$implicit,s=m();return _(s.setAction(t,"keep"))}),o(12," Keep "),n(),i(13,"button",29),g("click",function(){u(e);let t=m().$implicit,s=m();return _(s.setAction(t,"update"))}),o(14," Update "),n()()()()}if(a&2){let e=m().$implicit;l(2),C(e.part_number),l(4),C(e.saved_location||"(empty)"),l(2),C(e.import_location||"(empty)"),l(3),B("btn-outline-secondary",e.action!=="keep")("btn-secondary",e.action==="keep"),l(2),B("btn-outline-primary",e.action!=="update")("btn-primary",e.action==="update")}}function $e(a,d){if(a&1&&(i(0,"tr")(1,"td"),o(2,"Location"),n(),i(3,"td",26),o(4),n(),i(5,"td",27),o(6),n()()),a&2){let e=m().$implicit;l(4),C(e.saved_location||"(empty)"),l(2),C(e.import_location||"(empty)")}}function Ge(a,d){if(a&1&&(ce(0),y(1,je,15,13,"tr",24)(2,Qe,15,11,"tr",24)(3,$e,7,2,"tr",24),pe()),a&2){let e=d.$implicit;l(),c("ngIf",e.saved_description!==e.import_description),l(),c("ngIf",e.saved_location!==e.import_location&&e.saved_description===e.import_description),l(),c("ngIf",e.saved_description!==e.import_description&&e.saved_location!==e.import_location)}}function ze(a,d){a&1&&b(0,"div",30)}var Ee=(()=>{class a{constructor(){this.show=!1,this.conflicts=[],this.showChange=new z,this.resolved=new z,this.saving=!1}getRowspan(e){let r=0;return e.saved_description!==e.import_description&&r++,e.saved_location!==e.import_location&&r++,Math.max(r,1)}setAction(e,r){e.action=r}setAllActions(e){this.conflicts.forEach(r=>r.action=e)}getKeepCount(){return this.conflicts.filter(e=>e.action==="keep").length}getUpdateCount(){return this.conflicts.filter(e=>e.action==="update").length}getUnresolvedCount(){return this.conflicts.filter(e=>e.action===null).length}close(){this.show=!1,this.showChange.emit(!1)}confirm(){this.getUnresolvedCount()>0||(this.saving=!0,this.resolved.emit([...this.conflicts]),setTimeout(()=>{this.saving=!1,this.close()},500))}static{this.\u0275fac=function(r){return new(r||a)}}static{this.\u0275cmp=G({type:a,selectors:[["app-duplicate-parts-dialog"]],inputs:{show:"show",conflicts:"conflicts"},outputs:{showChange:"showChange",resolved:"resolved"},standalone:!0,features:[K],decls:44,vars:14,consts:[["tabindex","-1",1,"modal","fade"],[1,"modal-dialog","modal-lg"],[1,"modal-content"],[1,"modal-header"],[1,"modal-title"],[1,"bi","bi-exclamation-triangle","text-warning","me-2"],["type","button",1,"btn-close",3,"click"],[1,"modal-body"],[1,"alert","alert-info","small"],[1,"bi","bi-info-circle","me-2"],[1,"d-flex","gap-2","mb-3"],[1,"btn","btn-sm","btn-outline-secondary",3,"click"],[1,"btn","btn-sm","btn-outline-primary",3,"click"],[1,"table-responsive",2,"max-height","400px","overflow-y","auto"],[1,"table","table-sm"],[1,"table-secondary","sticky-top"],[1,"text-center"],[4,"ngFor","ngForOf"],[1,"mt-3","small","text-muted"],[1,"modal-footer"],["type","button",1,"btn","btn-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click","disabled"],[1,"bi","me-1"],["class","modal-backdrop fade show",4,"ngIf"],[4,"ngIf"],[1,"font-monospace"],[1,"small","text-muted"],[1,"small"],[1,"btn-group","btn-group-sm"],[1,"btn",3,"click"],[1,"modal-backdrop","fade","show"]],template:function(r,t){r&1&&(i(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"h5",4),b(5,"i",5),o(6," Part Conflicts Detected "),n(),i(7,"button",6),g("click",function(){return t.close()}),n()(),i(8,"div",7)(9,"div",8),b(10,"i",9),o(11),n(),i(12,"div",10)(13,"button",11),g("click",function(){return t.setAllActions("keep")}),o(14," Keep All Saved "),n(),i(15,"button",12),g("click",function(){return t.setAllActions("update")}),o(16," Update All to Import "),n()(),i(17,"div",13)(18,"table",14)(19,"thead",15)(20,"tr")(21,"th"),o(22,"Part Number"),n(),i(23,"th"),o(24,"Field"),n(),i(25,"th"),o(26,"Saved Value"),n(),i(27,"th"),o(28,"Import Value"),n(),i(29,"th",16),o(30,"Action"),n()()(),i(31,"tbody"),y(32,Ge,4,3,"ng-container",17),n()()(),i(33,"div",18)(34,"strong"),o(35,"Summary:"),n(),o(36),n()(),i(37,"div",19)(38,"button",20),g("click",function(){return t.close()}),o(39,"Cancel"),n(),i(40,"button",21),g("click",function(){return t.confirm()}),b(41,"i",22),o(42),n()()()()(),y(43,ze,1,0,"div",23)),r&2&&(Z("display",t.show?"block":"none"),B("show",t.show),l(11),E(" ",t.conflicts.length," part(s) in the import have different values than what's saved in the Parts Catalog. Choose whether to keep the saved value or update with the imported value for each conflict. "),l(21),c("ngForOf",t.conflicts),l(4),ee(" ",t.getKeepCount()," kept, ",t.getUpdateCount()," will be updated, ",t.getUnresolvedCount()," unresolved "),l(4),c("disabled",t.getUnresolvedCount()>0||t.saving),l(),$(t.saving?"bi-arrow-clockwise spin":"bi-check-circle"),l(),E(" ",t.saving?"Applying...":"Apply Resolutions"," "),l(),c("ngIf",t.show))},dependencies:[X,H,J,Y],styles:[".spin[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_spin 1s linear infinite}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}"]})}}return a})();var Te=(()=>{class a{constructor(e,r){this.partsService=e,this.partRelationshipsService=r}parseBOMCsv(e,r){let t=[],s=e.split(/\r?\n/),p=r.replace(/\.csv$/i,"").trim(),f=-1,P=-1,x=-1,w=-1,I=-1,h=-1;for(let M=0;M<s.length;M++){let v=s[M].trim();if(!v||v.startsWith("#")||v.includes("\u03A3"))continue;let U=this.parseCSVLine(v).map(S=>S.toLowerCase().trim()),q=U.findIndex(S=>S==="level"||S==="lvl"),j=U.findIndex(S=>S==="part number"||S==="part_number"||S==="partnumber"||S==="part no"||S==="part no."||S==="pn"||S==="ref_pn");if(q!==-1&&j!==-1){f=M,P=q,x=j,w=U.findIndex(S=>S==="type"||S==="make/buy"||S==="make_buy"),I=U.findIndex(S=>S==="qty"||S==="quantity"||S==="qty per"||S==="qty/assy"||S==="qty ea"||S==="qty needed"),h=U.findIndex(S=>S==="description"||S==="desc"||S==="name"||S==="part description");break}}if(f===-1)return t.push(`Could not find header row in ${r}`),{toolModel:p,leafParts:[],warnings:t};if(I===-1)return t.push(`No quantity column found in ${r}`),{toolModel:p,leafParts:[],warnings:t};let T=[];for(let M=f+1;M<s.length;M++){let v=s[M].trim();if(!v||v.startsWith("#")||v.includes("\u03A3"))continue;let A=this.parseCSVLine(v),U=A[P]?.trim()||"",q=parseInt(U,10);if(isNaN(q))continue;let j=A[x]?.trim()||"";if(!j)continue;let S=w>=0&&A[w]?.trim()||"",F=A[I]?.trim()||"1",Q=this.parseEuropeanNumber(F),Pe=h>=0&&A[h]?.trim()||"";T.push({level:q,partNumber:j,type:S,qty:Q,description:Pe})}if(T.length===0)return t.push(`No data rows found in ${r}`),{toolModel:p,leafParts:[],warnings:t};let k=new Map,D=[];for(let M=0;M<T.length;M++){let v=T[M],A=M+1<T.length?T[M+1]:null,U=!A||A.level<=v.level,q=1;for(let F=v.level-1;F>=0;F--){let Q=k.get(F);if(Q){q=Q.effectiveQty;break}}let j=v.qty*q;k.set(v.level,{partNumber:v.partNumber,effectiveQty:j});for(let[F]of k)F>v.level&&k.delete(F);let S="";for(let F=1;F>=0;F--){let Q=k.get(F);if(Q){S=Q.partNumber;break}}if(v.level<=1&&(S=v.partNumber),U){let F=Math.max(1,Math.ceil(j));D.push({partNumber:v.partNumber,description:v.description,qty:F,assemblyGroup:S,type:v.type})}}return{toolModel:p,leafParts:D,warnings:t}}mergeMultipleBOMs(e,r){let t=e.map(x=>x.toolModel),s=new Map;for(let x of e){let w=new Map;for(let I of x.leafParts){let h=w.get(I.partNumber);h?h.qty+=I.qty:w.set(I.partNumber,{qty:I.qty,assemblyGroup:I.assemblyGroup,description:I.description})}s.set(x.toolModel,w)}let p=new Set;for(let[,x]of s)for(let w of x.keys())p.add(w);let f=[];for(let x of p){let w=[];for(let T of e){let D=s.get(T.toolModel)?.get(x);D&&w.push({toolModel:T.toolModel,qty:D.qty,assemblyGroup:D.assemblyGroup,description:D.description})}let I=new Map;for(let T of w){let k=I.get(T.qty)||[];k.push(T),I.set(T.qty,k)}let h=w[0];for(let[T,k]of I){let D=k.map(v=>v.toolModel),M=D.length===e.length&&I.size===1;f.push({partNumber:x,description:h.description,assemblyGroup:h.assemblyGroup,qtyPerUnit:T,toolModels:D,isShared:M})}}f.sort((x,w)=>{if(x.isShared!==w.isShared)return x.isShared?-1:1;let I=x.assemblyGroup.localeCompare(w.assemblyGroup);return I!==0?I:x.partNumber.localeCompare(w.partNumber)});let P=f.filter(x=>x.isShared).length;return{lineItems:f,allToolModels:t,stats:{totalParts:f.length,sharedCount:P,toolSpecificCount:f.length-P}}}buildImportedOrder(e,r,t,s){return W(this,null,function*(){let p=new Map;if(s)for(let h of s)p.set(h.part_number,h);let f=new Map;for(let h of t)f.set(h.toolModel,h.toolNumber);let P=t.map(h=>({tool_number:h.toolNumber,tool_model:h.toolModel})),x=new Map;for(let h of e.lineItems){let T=p.get(h.partNumber),k=T?.description||h.description||null,D=T?.default_location||null,M=h.assemblyGroup===h.partNumber;try{let v=yield this.partsService.findOrCreatePart(h.partNumber,k,D,null);M&&!v.is_assembly&&(yield this.partsService.updatePart(v.id,{is_assembly:!0}),v.is_assembly=!0),x.set(h.partNumber,v)}catch(v){console.error(`Error creating/finding part ${h.partNumber}:`,v)}}let w=new Set;for(let h of e.lineItems){let T=h.assemblyGroup;if(!T||T===h.partNumber)continue;let k=x.get(T),D=x.get(h.partNumber);if(k&&D&&k.id!==D.id){let M=`${k.id}:${D.id}`;if(!w.has(M))try{yield this.partRelationshipsService.createRelationship(k.id,D.id,h.qtyPerUnit,{skipCircularCheck:!0}),w.add(M)}catch(v){console.error(`Error creating relationship ${T} -> ${h.partNumber}:`,v)}}}let I=e.lineItems.map(h=>{let T=p.get(h.partNumber),k=T?.description||h.description||void 0,D=T?.default_location||void 0,M=x.get(h.partNumber),v;h.isShared||(v=h.toolModels.map(q=>{let j=f.get(q);return j?`temp-${j}`:void 0}).filter(q=>q!==void 0),v.length===0&&(v=void 0));let A=v?v.length:P.length,U=h.qtyPerUnit*A;return{part_number:h.partNumber,description:k,location:D,qty_per_unit:h.qtyPerUnit,total_qty_needed:U,tool_ids:v,assembly_group:h.assemblyGroup||void 0,part_id:M?.id}});return{so_number:r.soNumber,po_number:r.poNumber,customer_name:r.customerName,order_date:r.purchaseDate,due_date:r.dueDate,estimated_ship_date:r.estimatedShipDate,tools:P,line_items:I}})}parseCSVLine(e){let r=[],t="",s=!1;for(let p=0;p<e.length;p++){let f=e[p];s?f==='"'?p+1<e.length&&e[p+1]==='"'?(t+='"',p++):s=!1:t+=f:f==='"'?s=!0:f===","||f===";"?(r.push(t),t=""):t+=f}return r.push(t),r}parseEuropeanNumber(e){if(!e)return 0;let r=e.trim();if(r.includes(".")&&r.includes(","))r=r.replace(/\./g,"").replace(",",".");else if(r.includes(",")&&!r.includes(".")){let s=r.lastIndexOf(","),p=r.substring(s+1);p.length<=3&&/^\d+$/.test(p)&&(r=r.replace(",","."))}let t=parseFloat(r);return isNaN(t)?0:t}static{this.\u0275fac=function(r){return new(r||a)(le(oe),le(re))}}static{this.\u0275prov=de({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();function Xe(a,d){if(a&1){let e=N();i(0,"div",12)(1,"div",13),b(2,"i",14),i(3,"div")(4,"strong"),o(5,"Unclassified Parts Found"),n(),i(6,"div"),o(7),n()()(),i(8,"div",15)(9,"button",16),g("click",function(){u(e);let t=m();return _(t.navigateToClassifyParts())}),o(10," Classify Now "),n(),i(11,"button",17),g("click",function(){u(e);let t=m();return _(t.showUnclassifiedAlert=!1)}),n()()()}if(a&2){let e=m();l(7),ee("",e.unclassifiedPartsCount," part",e.unclassifiedPartsCount!==1?"s":""," ",e.unclassifiedPartsCount!==1?"were":"was"," imported without classification.")}}function Ye(a,d){if(a&1&&(i(0,"li"),o(1),n()),a&2){let e=d.$implicit;l(),C(e)}}function Ze(a,d){if(a&1&&(i(0,"div",40)(1,"div",41),b(2,"i",42),i(3,"strong"),o(4,"Import Failed"),n()(),i(5,"ul",43),y(6,Ye,2,1,"li",44),n()()),a&2){let e=m(3);l(6),c("ngForOf",e.parseErrors)}}function et(a,d){if(a&1){let e=N();i(0,"div",19)(1,"div",22)(2,"div",31),g("drop",function(t){u(e);let s=m(2);return _(s.onDrop(t))})("dragover",function(t){u(e);let s=m(2);return _(s.onDragOver(t))})("dragleave",function(t){u(e);let s=m(2);return _(s.onDragLeave(t))}),b(3,"i",32),i(4,"p",33),o(5,"Drag and drop your file here"),n(),i(6,"p",34),o(7,"Supports Excel (.xlsx) and CSV files"),n(),i(8,"div",35)(9,"label",36),b(10,"i",7),o(11," Browse Files "),i(12,"input",37),g("change",function(t){u(e);let s=m(2);return _(s.onFileSelect(t))}),n()(),i(13,"button",25),g("click",function(){u(e);let t=m(2);return _(t.showTemplateDialog=!0)}),b(14,"i",38),o(15," Load from Template "),n()()(),y(16,Ze,7,1,"div",39),n()()}if(a&2){let e=m(2);l(2),B("dragover",e.isDragging),l(14),c("ngIf",e.parseErrors.length>0)}}function tt(a,d){a&1&&(i(0,"span",82),o(1,"From Template"),n())}function it(a,d){if(a&1&&(i(0,"li"),o(1),n()),a&2){let e=d.$implicit;l(),C(e)}}function nt(a,d){if(a&1&&(i(0,"div",83)(1,"strong"),o(2,"Warnings"),n(),i(3,"ul",43),y(4,it,2,1,"li",44),n()()),a&2){let e=m(3);l(4),c("ngForOf",e.parseResult.warnings)}}function ot(a,d){if(a&1){let e=N();i(0,"div",84)(1,"div"),b(2,"i",85),i(3,"strong"),o(4),n(),o(5," have different values than the Parts Catalog. "),n(),i(6,"button",86),g("click",function(){u(e);let t=m(3);return _(t.showDuplicatesDialog=!0)}),o(7," Review Conflicts "),n()()}if(a&2){let e=m(3);l(4),E("",e.partConflicts.length," part(s)")}}function rt(a,d){if(a&1&&(i(0,"span"),o(1),n()),a&2){let e=m().$implicit;l(),E(" [",e.tool_model,"]")}}function at(a,d){if(a&1&&(i(0,"span",87),o(1),y(2,rt,2,1,"span",9),n()),a&2){let e=d.$implicit;l(),E(" ",e.tool_number," "),l(),c("ngIf",e.tool_model)}}function lt(a,d){if(a&1&&(i(0,"tr")(1,"td",88),o(2),n(),i(3,"td",89),o(4),n(),i(5,"td"),o(6),n(),i(7,"td",69),o(8),n(),i(9,"td",69),o(10),n()()),a&2){let e=d.$implicit;l(2),C(e.part_number),l(2),C(e.description||"-"),l(2),C(e.location||"-"),l(2),C(e.qty_per_unit),l(2),C(e.total_qty_needed)}}function st(a,d){if(a&1&&(i(0,"p",90),o(1),n()),a&2){let e=m(3);l(),E(" ...and ",e.parseResult.order.line_items.length-50," more items ")}}function mt(a,d){if(a&1){let e=N();i(0,"div",19)(1,"div",45)(2,"div",46),b(3,"i",47),i(4,"span",21),o(5),n(),y(6,tt,2,0,"span",48),n(),i(7,"button",49),g("click",function(){u(e);let t=m(2);return _(t.clearResult())}),b(8,"i",50),n()(),i(9,"div",22),y(10,nt,5,1,"div",51)(11,ot,8,1,"div",52),i(12,"div",53)(13,"h6",54),o(14,"Order Details"),n(),i(15,"div",55)(16,"div",56)(17,"label",57),o(18,"SO Number *"),n(),i(19,"input",58),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.parseResult.order.so_number,t)||(s.parseResult.order.so_number=t),_(t)}),n()(),i(20,"div",56)(21,"label",57),o(22,"PO Number"),n(),i(23,"input",58),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.parseResult.order.po_number,t)||(s.parseResult.order.po_number=t),_(t)}),n()(),i(24,"div",56)(25,"label",57),o(26,"Customer"),n(),i(27,"input",58),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.parseResult.order.customer_name,t)||(s.parseResult.order.customer_name=t),_(t)}),n()(),i(28,"div",56)(29,"label",57),o(30,"Due Date"),n(),i(31,"input",59),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.parseResult.order.due_date,t)||(s.parseResult.order.due_date=t),_(t)}),n()()()(),i(32,"div",53)(33,"div",60)(34,"h6",61),o(35),n(),i(36,"div",62)(37,"label",63),o(38,"Tool Count:"),n(),i(39,"input",64),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.toolCount,t)||(s.toolCount=t),_(t)}),g("change",function(){u(e);let t=m(2);return _(t.regenerateTools())}),n()()(),i(40,"div",24),y(41,at,3,2,"span",65),n()(),i(42,"div",53)(43,"h6",54),o(44),n(),i(45,"div",66)(46,"table",67)(47,"thead",68)(48,"tr")(49,"th"),o(50,"Part Number"),n(),i(51,"th"),o(52,"Description"),n(),i(53,"th"),o(54,"Location"),n(),i(55,"th",69),o(56,"Qty/Unit"),n(),i(57,"th",69),o(58,"Total"),n()()(),i(59,"tbody"),y(60,lt,11,5,"tr",44),n()()(),y(61,st,2,1,"p",70),n(),i(62,"div",71)(63,"h6",54),o(64,"Import Options"),n(),i(65,"div",72)(66,"input",73),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.saveToCatalog,t)||(s.saveToCatalog=t),_(t)}),n(),i(67,"label",74),o(68," Save new parts to Parts Catalog "),i(69,"span",75),o(70,"Parts not already in the catalog will be added automatically"),n()()(),i(71,"div",76)(72,"input",77),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.useLegacyFormat,t)||(s.useLegacyFormat=t),_(t)}),g("change",function(){u(e);let t=m(2);return _(t.reparse())}),n(),i(73,"label",78),o(74," Legacy format (tool columns) "),i(75,"span",75),o(76,'Enable if your file has columns like "3137-1", "3137-2" for per-tool quantities'),n()()()(),i(77,"div",79)(78,"button",25),g("click",function(){u(e);let t=m(2);return _(t.clearResult())}),o(79,"Cancel"),n(),i(80,"button",80),g("click",function(){u(e);let t=m(2);return _(t.handleImport())}),b(81,"i",81),o(82),n()()()()}if(a&2){let e=m(2);l(5),E("Preview: SO-",e.parseResult.order.so_number,""),l(),c("ngIf",e.loadedFromTemplate),l(4),c("ngIf",e.parseResult.warnings.length>0),l(),c("ngIf",e.partConflicts.length>0),l(8),O("ngModel",e.parseResult.order.so_number),l(4),O("ngModel",e.parseResult.order.po_number),l(4),O("ngModel",e.parseResult.order.customer_name),l(4),O("ngModel",e.parseResult.order.due_date),l(4),E("Tools (",e.parseResult.order.tools.length,")"),l(4),O("ngModel",e.toolCount),c("min",1),l(2),c("ngForOf",e.parseResult.order.tools),l(3),E("Line Items (",e.parseResult.order.line_items.length,")"),l(16),c("ngForOf",e.parseResult.order.line_items.slice(0,50)),l(),c("ngIf",e.parseResult.order.line_items.length>50),l(5),O("ngModel",e.saveToCatalog),l(6),O("ngModel",e.useLegacyFormat),l(8),c("disabled",e.isImporting||!e.parseResult.order.so_number),l(),$(e.isImporting?"bi-arrow-clockwise spin":"bi-check-circle"),l(),E(" ",e.isImporting?"Importing...":"Import Order"," ")}}function dt(a,d){if(a&1){let e=N();i(0,"div"),y(1,et,17,3,"div",18)(2,mt,83,21,"div",18),i(3,"div",19)(4,"div",20)(5,"span",21),o(6,"Download Template"),n()(),i(7,"div",22)(8,"p",23),o(9,"Download an Excel template to get started:"),n(),i(10,"div",24)(11,"button",25),g("click",function(){u(e);let t=m();return _(t.downloadTemplate("single"))}),b(12,"i",26),o(13," Single Tool Type "),n(),i(14,"button",25),g("click",function(){u(e);let t=m();return _(t.downloadTemplate("single-bom"))}),b(15,"i",26),o(16," Single Tool Type (BOM) "),n(),i(17,"button",25),g("click",function(){u(e);let t=m();return _(t.downloadTemplate("multi"))}),b(18,"i",26),o(19," Multiple Tool Types "),n()(),i(20,"p",27)(21,"strong"),o(22,"Single Tool Type:"),n(),o(23," All tools share the same parts list."),b(24,"br"),i(25,"strong"),o(26,"Single Tool Type (BOM):"),n(),o(27," Multi-level BOM with hierarchy (Level column)."),b(28,"br"),i(29,"strong"),o(30,"Multiple Tool Types:"),n(),o(31," Different tools have different BOMs. "),n()()(),i(32,"div",28)(33,"div",20)(34,"span",21),o(35,"File Format Guide"),n()(),i(36,"div",22)(37,"div",29)(38,"h6",21),o(39,"Single Tool Type (Simple Format)"),n(),i(40,"p",30),o(41,' Excel file with "Order Info" sheet containing SO Number, PO Number, Customer, Tool Qty, Tool Model. "Parts" sheet with Part Number, Description, Location, Qty/Unit columns. '),n()(),i(42,"div",29)(43,"h6",21),o(44,"Legacy Format (Tool Columns)"),n(),i(45,"p",30),o(46,' Excel file with columns named like "3137-1", "3137-2" for per-tool quantities. Enable "Legacy format" option to use this format. '),n()(),i(47,"div",29)(48,"h6",21),o(49,"Expected Columns"),n(),i(50,"ul",30)(51,"li"),o(52,"Part Number (required)"),n(),i(53,"li"),o(54,"Description (optional)"),n(),i(55,"li"),o(56,"Location/Bin (optional)"),n(),i(57,"li"),o(58,"Quantity per unit or tool-specific quantities"),n()()()()()()}if(a&2){let e=m();l(),c("ngIf",!e.parseResult),l(),c("ngIf",e.parseResult)}}function ct(a,d){if(a&1){let e=N();i(0,"div",111)(1,"div",62),b(2,"i",112),i(3,"div")(4,"span",113),o(5),n(),i(6,"small",114),o(7),n()()(),i(8,"button",49),g("click",function(){let t=u(e).index,s=m(4);return _(s.removeBomFile(t))}),b(9,"i",115),n()()}if(a&2){let e=d.$implicit;l(5),C(e.toolModel),l(2),E("Tool: ",e.toolNumber,"")}}function pt(a,d){if(a&1&&(i(0,"div",108)(1,"h6",109),o(2),n(),y(3,ct,10,2,"div",110),n()),a&2){let e=m(3);l(2),E("Uploaded Files (",e.bomFiles.length,")"),l(),c("ngForOf",e.bomFiles)}}function ut(a,d){if(a&1&&(i(0,"li"),o(1),n()),a&2){let e=d.$implicit;l(),C(e)}}function _t(a,d){if(a&1&&(i(0,"div",116)(1,"div",41),b(2,"i",42),i(3,"strong"),o(4,"Parse Failed"),n()(),i(5,"ul",43),y(6,ut,2,1,"li",44),n()()),a&2){let e=m(3);l(6),c("ngForOf",e.bomParseErrors)}}function ft(a,d){if(a&1){let e=N();i(0,"div",117)(1,"button",118),g("click",function(){u(e);let t=m(3);return _(t.handleParseBOMs())}),o(2,"Parse & Preview"),n()()}}function gt(a,d){if(a&1){let e=N();i(0,"div")(1,"div",19)(2,"div",20)(3,"span",21),o(4,"Order Information"),n()(),i(5,"div",22)(6,"div",92)(7,"div",93)(8,"label",94),o(9,"SO Number *"),n(),i(10,"input",95),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.bomOrderInfo.soNumber,t)||(s.bomOrderInfo.soNumber=t),_(t)}),g("input",function(){u(e);let t=m(2);return _(t.handleBomSoNumberChange())}),n()(),i(11,"div",93)(12,"label",94),o(13,"PO Number"),n(),i(14,"input",96),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.bomOrderInfo.poNumber,t)||(s.bomOrderInfo.poNumber=t),_(t)}),n()(),i(15,"div",93)(16,"label",94),o(17,"Customer Name"),n(),i(18,"input",97),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.bomOrderInfo.customerName,t)||(s.bomOrderInfo.customerName=t),_(t)}),n()(),i(19,"div",93)(20,"label",94),o(21,"Purchase Date"),n(),i(22,"input",59),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.bomOrderInfo.purchaseDate,t)||(s.bomOrderInfo.purchaseDate=t),_(t)}),n()(),i(23,"div",93)(24,"label",94),o(25,"Due Date"),n(),i(26,"input",59),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.bomOrderInfo.dueDate,t)||(s.bomOrderInfo.dueDate=t),_(t)}),n()(),i(27,"div",93)(28,"label",94),o(29,"Est. Ship Date"),n(),i(30,"input",59),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.bomOrderInfo.estimatedShipDate,t)||(s.bomOrderInfo.estimatedShipDate=t),_(t)}),n()()()()(),i(31,"div",19)(32,"div",20)(33,"span",21),o(34,"BOM Files"),n()(),i(35,"div",22)(36,"div",31),g("drop",function(t){u(e);let s=m(2);return _(s.onBomDrop(t))})("dragover",function(t){u(e);let s=m(2);return _(s.onBomDragOver(t))})("dragleave",function(t){u(e);let s=m(2);return _(s.onBomDragLeave(t))}),b(37,"i",98),i(38,"p",99),o(39,"Drop BOM CSV files here"),n(),i(40,"p",100),o(41,"One CSV per tool variation (e.g., 230QR-10002.csv, 230QR-10003.csv)"),n(),i(42,"label",101),b(43,"i",102),o(44," Browse CSV Files "),i(45,"input",103),g("change",function(t){u(e);let s=m(2);return _(s.onBomFileSelect(t))}),n()()(),y(46,pt,4,2,"div",104)(47,_t,7,1,"div",105)(48,ft,3,0,"div",106),n()(),i(49,"div",28)(50,"div",20)(51,"span",21),o(52,"Multi-BOM Format Guide"),n()(),i(53,"div",22)(54,"p",107),o(55,"Use this mode when each tool has its own multi-level BOM (e.g., Sonovision orders where tools are variations of each other)."),n(),i(56,"div",29)(57,"h6",21),o(58,"Expected CSV Format"),n(),i(59,"ul",107)(60,"li"),o(61,"Columns: Level, Part Number, Type, Qty, Description"),n(),i(62,"li"),o(63,"Multi-level hierarchy (Level 0 = root, Level 1 = top assembly, etc.)"),n(),i(64,"li"),o(65,"Only leaf parts (no sub-components) are extracted for picking"),n(),i(66,"li"),o(67,"Quantities are multiplied through the hierarchy"),n()()(),i(68,"div")(69,"h6",21),o(70,"How Merging Works"),n(),i(71,"ul",30)(72,"li"),o(73,"Parts shared across all BOMs at the same qty become shared line items"),n(),i(74,"li"),o(75,"Parts unique to specific tools become tool-specific line items"),n(),i(76,"li"),o(77,"Descriptions and locations are auto-filled from your Parts Catalog"),n()()()()()()}if(a&2){let e=m(2);l(10),O("ngModel",e.bomOrderInfo.soNumber),l(4),O("ngModel",e.bomOrderInfo.poNumber),l(4),O("ngModel",e.bomOrderInfo.customerName),l(4),O("ngModel",e.bomOrderInfo.purchaseDate),l(4),O("ngModel",e.bomOrderInfo.dueDate),l(4),O("ngModel",e.bomOrderInfo.estimatedShipDate),l(6),B("dragover",e.isBomDragging),l(10),c("ngIf",e.bomFiles.length>0),l(),c("ngIf",e.bomParseErrors.length>0),l(),c("ngIf",e.bomFiles.length>0)}}function ht(a,d){if(a&1&&(i(0,"li"),o(1),n()),a&2){let e=d.$implicit;l(),C(e)}}function vt(a,d){if(a&1&&(i(0,"div",83)(1,"strong"),o(2,"Warnings"),n(),i(3,"ul",43),y(4,ht,2,1,"li",44),n()()),a&2){let e=m(3);l(4),c("ngForOf",e.bomParseResult.warnings)}}function bt(a,d){if(a&1&&(i(0,"span"),o(1),n()),a&2){let e=m().$implicit;l(),E(" [",e.tool_model,"]")}}function xt(a,d){if(a&1&&(i(0,"span",87),o(1),y(2,bt,2,1,"span",9),n()),a&2){let e=d.$implicit;l(),E(" ",e.tool_number," "),l(),c("ngIf",e.tool_model)}}function yt(a,d){if(a&1){let e=N();i(0,"div",84)(1,"div"),b(2,"i",85),i(3,"strong"),o(4),n(),o(5," have different values than the Parts Catalog. "),n(),i(6,"button",86),g("click",function(){u(e);let t=m(3);return _(t.showDuplicatesDialog=!0)}),o(7,"Review Conflicts"),n()()}if(a&2){let e=m(3);l(4),E("",e.partConflicts.length," part(s)")}}function Ct(a,d){a&1&&(i(0,"span",133),o(1,"Shared"),n())}function St(a,d){if(a&1&&(i(0,"span",134),o(1),n()),a&2){let e=m().$implicit;l(),ue(" ",e.toolModels.length," tool",e.toolModels.length!==1?"s":""," ")}}function wt(a,d){if(a&1&&(i(0,"tr")(1,"td",88),o(2),n(),i(3,"td",89),o(4),n(),i(5,"td",130),o(6),n(),i(7,"td",69),y(8,Ct,2,0,"span",131)(9,St,2,2,"span",132),n(),i(10,"td",69),o(11),n(),i(12,"td",69),o(13),n()()),a&2){let e=d.$implicit,r=d.index,t=m(3);l(2),C(e.partNumber),l(2),C(t.bomParseResult.order.line_items[r].description||e.description||"-"),l(2),C(e.assemblyGroup||"-"),l(2),c("ngIf",e.isShared),l(),c("ngIf",!e.isShared),l(2),C(e.qtyPerUnit),l(2),C(t.bomParseResult.order.line_items[r].total_qty_needed||"-")}}function It(a,d){if(a&1&&(i(0,"p",90),o(1),n()),a&2){let e=m(3);l(),E(" ...and ",e.bomParseResult.merged.lineItems.length-100," more items ")}}function Et(a,d){if(a&1){let e=N();i(0,"div",28)(1,"div",45)(2,"div",46),b(3,"i",47),i(4,"span",21),o(5),n()(),i(6,"button",49),g("click",function(){u(e);let t=m(2);return _(t.clearBomResult())}),b(7,"i",50),n()(),i(8,"div",22),y(9,vt,5,1,"div",51),i(10,"div",119)(11,"div",120)(12,"div",121)(13,"div",122),o(14),n(),i(15,"small",89),o(16,"Total Parts"),n()()(),i(17,"div",120)(18,"div",123)(19,"div",124),o(20),n(),i(21,"small",89),o(22,"Shared"),n()()(),i(23,"div",120)(24,"div",125)(25,"div",126),o(26),n(),i(27,"small",89),o(28,"Tool-Specific"),n()()()(),i(29,"div",53)(30,"h6",54),o(31),n(),i(32,"div",24),y(33,xt,3,2,"span",65),n()(),y(34,yt,8,1,"div",52),i(35,"div",53)(36,"h6",54),o(37),n(),i(38,"div",127)(39,"table",67)(40,"thead",68)(41,"tr")(42,"th"),o(43,"Part Number"),n(),i(44,"th"),o(45,"Description"),n(),i(46,"th"),o(47,"Assembly"),n(),i(48,"th",69),o(49,"Scope"),n(),i(50,"th",69),o(51,"Qty/Unit"),n(),i(52,"th",69),o(53,"Total"),n()()(),i(54,"tbody"),y(55,wt,14,7,"tr",44),n()()(),y(56,It,2,1,"p",70),n(),i(57,"div",71)(58,"div",72)(59,"input",128),R("ngModelChange",function(t){u(e);let s=m(2);return V(s.saveToCatalog,t)||(s.saveToCatalog=t),_(t)}),n(),i(60,"label",129),o(61,"Save new parts to Parts Catalog"),n()()(),i(62,"div",79)(63,"button",25),g("click",function(){u(e);let t=m(2);return _(t.clearBomResult())}),o(64,"Cancel"),n(),i(65,"button",80),g("click",function(){u(e);let t=m(2);return _(t.handleBomImport())}),b(66,"i",81),o(67),n()()()()}if(a&2){let e=m(2);l(5),E("Preview: SO-",e.bomOrderInfo.soNumber,""),l(4),c("ngIf",e.bomParseResult.warnings.length>0),l(5),C(e.bomParseResult.merged.stats.totalParts),l(6),C(e.bomParseResult.merged.stats.sharedCount),l(6),C(e.bomParseResult.merged.stats.toolSpecificCount),l(5),E("Tools (",e.bomParseResult.order.tools.length,")"),l(2),c("ngForOf",e.bomParseResult.order.tools),l(),c("ngIf",e.partConflicts.length>0),l(3),E("Line Items (",e.bomParseResult.order.line_items.length,")"),l(18),c("ngForOf",e.bomParseResult.merged.lineItems.slice(0,100)),l(),c("ngIf",e.bomParseResult.merged.lineItems.length>100),l(3),O("ngModel",e.saveToCatalog),l(6),c("disabled",e.isImporting),l(),$(e.isImporting?"bi-arrow-clockwise spin":"bi-check-circle"),l(),E(" ",e.isImporting?"Importing...":"Import Order"," ")}}function Tt(a,d){if(a&1&&(i(0,"div"),y(1,gt,78,11,"div",9)(2,Et,68,16,"div",91),n()),a&2){let e=m();l(),c("ngIf",!e.bomParseResult),l(),c("ngIf",e.bomParseResult)}}var ti=(()=>{class a{constructor(e,r,t,s,p,f,P,x,w,I){this.router=e,this.ordersService=r,this.excelService=t,this.partsCatalogService=s,this.bomTemplatesService=p,this.bomParserService=f,this.activityLogService=P,this.settingsService=x,this.partsService=w,this.partRelationshipsService=I,this.isDragging=!1,this.parseResult=null,this.parseErrors=[],this.isImporting=!1,this.loadedFromTemplate=!1,this.showTemplateDialog=!1,this.showDuplicatesDialog=!1,this.partConflicts=[],this.saveToCatalog=!0,this.useLegacyFormat=!1,this.toolCount=1,this.unclassifiedPartsCount=0,this.showUnclassifiedAlert=!1,this.currentFile=null,this.subscriptions=[],this.activeTab="standard",this.isBomDragging=!1,this.bomFiles=[],this.bomOrderInfo={soNumber:"",poNumber:"",customerName:"",purchaseDate:"",dueDate:"",estimatedShipDate:""},this.bomParseResult=null,this.bomParseErrors=[]}ngOnInit(){this.partsCatalogService.fetchParts()}ngOnDestroy(){this.subscriptions.forEach(e=>e.unsubscribe())}navigateToClassifyParts(){this.router.navigate(["/parts"],{queryParams:{filter:"unclassified"}})}onDragOver(e){e.preventDefault(),this.isDragging=!0}onDragLeave(e){e.preventDefault(),this.isDragging=!1}onDrop(e){e.preventDefault(),this.isDragging=!1;let r=e.dataTransfer?.files[0];r&&this.handleFile(r)}onFileSelect(e){let t=e.target.files?.[0];t&&this.handleFile(t)}handleFile(e){return W(this,null,function*(){this.parseResult=null,this.parseErrors=[],this.partConflicts=[],this.loadedFromTemplate=!1,this.currentFile=e;let r=e.name.endsWith(".xlsx")||e.name.endsWith(".xls")||e.type.includes("spreadsheet"),t=e.name.endsWith(".csv")||e.type==="text/csv";if(!r&&!t){this.parseErrors=["Please upload an Excel (.xlsx) or CSV file"];return}let s;r?s=this.useLegacyFormat?yield this.excelService.parseEnhancedExcelFileWithLegacySupport(e):yield this.excelService.parseEnhancedExcelFile(e):s=yield this.excelService.parseCsvFile(e),s.success&&s.order?(this.parseResult={order:s.order,errors:s.errors,warnings:s.warnings},this.toolCount=s.order.tools.length,this.checkForConflicts(s.order.line_items)):this.parseErrors=s.errors})}reparse(){return W(this,null,function*(){this.currentFile&&(yield this.handleFile(this.currentFile))})}checkForConflicts(e){this.partConflicts=this.partsCatalogService.checkForConflicts(e)}regenerateTools(){if(!this.parseResult)return;let e=this.parseResult.order.so_number,r=this.parseResult.order.tools[0]?.tool_model,t=Math.max(1,this.toolCount);this.parseResult.order.tools=[];for(let s=1;s<=t;s++)this.parseResult.order.tools.push({tool_number:`${e}-${s}`,tool_model:r});for(let s of this.parseResult.order.line_items)s.total_qty_needed=s.qty_per_unit*t}handleTemplateSelected(e){let r={so_number:"",tools:[{tool_number:"-1",tool_model:e.tool_model||void 0}],line_items:e.items.map(t=>({part_number:t.part_number,description:t.description||void 0,location:t.location||void 0,qty_per_unit:t.qty_per_unit,total_qty_needed:t.qty_per_unit}))};this.parseResult={order:r,errors:[],warnings:[`Loaded from template: ${e.name}`]},this.loadedFromTemplate=!0,this.toolCount=1,this.currentFile=null,this.checkForConflicts(r.line_items)}handleConflictsResolved(e){return W(this,null,function*(){yield this.partsCatalogService.applyConflictResolutions(e),this.partConflicts=[]})}handleImport(){return W(this,null,function*(){if(this.parseResult?.order){this.isImporting=!0;try{let e=0;this.saveToCatalog&&(e=(yield this.processPartsAndRelationships(this.parseResult.order.line_items)).unclassifiedCount);let r=yield this.ordersService.importOrder(this.parseResult.order);if(r){let t=this.parseResult.order.tools.map(p=>p.tool_number);yield this.activityLogService.logActivity({type:"order_imported",order_id:r.id,so_number:this.parseResult.order.so_number,description:`Order SO-${this.parseResult.order.so_number} imported with ${this.parseResult.order.line_items.length} parts and ${this.parseResult.order.tools.length} tools`,performed_by:this.settingsService.getUserName(),details:{part_count:this.parseResult.order.line_items.length,tool_count:this.parseResult.order.tools.length,tool_numbers:t}});let s=this.parseResult.order.tools[0]?.tool_model||null;yield this.bomTemplatesService.autoExtractTemplate(this.parseResult.order.line_items,s,this.parseResult.order.so_number),e>0&&(this.unclassifiedPartsCount=e,this.showUnclassifiedAlert=!0,setTimeout(()=>{this.showUnclassifiedAlert=!1},2e3)),this.router.navigate(["/orders",r.id])}}catch(e){console.error("Import failed:",e)}finally{this.isImporting=!1}}})}processPartsAndRelationships(e){return W(this,null,function*(){let r=[],t=0,s=new Map;for(let f of e){let P=f.classification_type==="purchased"||f.classification_type==="manufactured"?f.classification_type:null,x=yield this.partsService.findOrCreatePart(f.part_number,f.description,f.location,P);s.set(f.part_number,x.id),x.classification_type||t++}let p=new Map;for(let f of e)if(f.assembly_group){let P=p.get(f.assembly_group)||[];P.push(f),p.set(f.assembly_group,P)}for(let[f,P]of p)try{let x=yield this.partsService.findOrCreatePart(f,`Assembly: ${f}`,null,null),w=P.filter(I=>I.part_number!==f).map(I=>({childId:s.get(I.part_number),quantity:I.qty_per_unit})).filter(I=>I.childId);w.length>0&&(yield this.partRelationshipsService.bulkCreateRelationships(x.id,w,{skipCircularCheck:!0}),x.is_assembly||(yield this.partsService.updatePart(x.id,{is_assembly:!0})))}catch(x){console.error(`Failed to create assembly relationships for ${f}:`,x),r.push(`Could not link assembly "${f}"`)}return{unclassifiedCount:t,warnings:r}})}clearResult(){this.parseResult=null,this.parseErrors=[],this.partConflicts=[],this.loadedFromTemplate=!1,this.currentFile=null}downloadTemplate(e){return W(this,null,function*(){yield this.excelService.downloadImportTemplate(e)})}handleBomSoNumberChange(){for(let e of this.bomFiles)e.toolNumber=this.bomOrderInfo.soNumber?`${this.bomOrderInfo.soNumber}-${e.toolModel}`:e.toolModel}onBomDragOver(e){e.preventDefault(),this.isBomDragging=!0}onBomDragLeave(e){e.preventDefault(),this.isBomDragging=!1}onBomDrop(e){e.preventDefault(),this.isBomDragging=!1;let r=e.dataTransfer?.files;r&&this.addBomFiles(Array.from(r))}onBomFileSelect(e){let r=e.target;r.files&&(this.addBomFiles(Array.from(r.files)),r.value="")}addBomFiles(e){for(let r of e){if(!r.name.endsWith(".csv"))continue;let t=r.name.replace(/\.csv$/i,"").trim(),s=this.bomOrderInfo.soNumber?`${this.bomOrderInfo.soNumber}-${t}`:t;this.bomFiles.some(p=>p.toolModel===t)||this.bomFiles.push({file:r,toolModel:t,toolNumber:s})}}removeBomFile(e){this.bomFiles.splice(e,1)}handleParseBOMs(){return W(this,null,function*(){if(this.bomParseErrors=[],this.bomParseResult=null,!this.bomOrderInfo.soNumber){this.bomParseErrors=["SO Number is required"];return}if(this.bomFiles.length===0){this.bomParseErrors=["Please add at least one BOM file"];return}let e=[],r=[];for(let P of this.bomFiles){let x=yield P.file.text(),w=this.bomParserService.parseBOMCsv(x,P.file.name);e.push(...w.warnings),w.leafParts.length===0&&this.bomParseErrors.push(`No parts found in ${P.file.name}`),r.push(w)}if(this.bomParseErrors.length>0)return;let t=this.bomFiles.map(P=>({toolModel:P.toolModel,toolNumber:P.toolNumber})),s=this.partsCatalogService.getCurrentParts(),p=this.bomParserService.mergeMultipleBOMs(r,t),f=yield this.bomParserService.buildImportedOrder(p,{soNumber:this.bomOrderInfo.soNumber,poNumber:this.bomOrderInfo.poNumber||void 0,customerName:this.bomOrderInfo.customerName||void 0,purchaseDate:this.bomOrderInfo.purchaseDate||void 0,dueDate:this.bomOrderInfo.dueDate||void 0,estimatedShipDate:this.bomOrderInfo.estimatedShipDate||void 0},t,s);this.bomParseResult={merged:p,order:f,warnings:e},this.checkForConflicts(f.line_items)})}handleBomImport(){return W(this,null,function*(){if(this.bomParseResult?.order){this.isImporting=!0;try{let e=0;this.saveToCatalog&&(e=(yield this.processPartsAndRelationships(this.bomParseResult.order.line_items)).unclassifiedCount);let r=yield this.ordersService.importOrder(this.bomParseResult.order);if(r){let t=this.bomParseResult.order.tools.map(p=>p.tool_number);yield this.activityLogService.logActivity({type:"order_imported",order_id:r.id,so_number:this.bomParseResult.order.so_number,description:`Order SO-${this.bomParseResult.order.so_number} imported with ${this.bomParseResult.order.line_items.length} parts and ${this.bomParseResult.order.tools.length} tools`,performed_by:this.settingsService.getUserName(),details:{part_count:this.bomParseResult.order.line_items.length,tool_count:this.bomParseResult.order.tools.length,tool_numbers:t}});let s=this.bomParseResult.order.tools[0]?.tool_model||null;yield this.bomTemplatesService.autoExtractTemplate(this.bomParseResult.order.line_items,s,this.bomParseResult.order.so_number),e>0&&(this.unclassifiedPartsCount=e,this.showUnclassifiedAlert=!0,setTimeout(()=>{this.showUnclassifiedAlert=!1},2e3)),this.router.navigate(["/orders",r.id])}}catch(e){console.error("BOM import failed:",e)}finally{this.isImporting=!1}}})}clearBomResult(){this.bomParseResult=null,this.bomParseErrors=[],this.partConflicts=[]}static{this.\u0275fac=function(r){return new(r||a)(L(_e),L(ye),L(Ce),L(xe),L(ae),L(Te),L(Se),L(be),L(oe),L(re))}}static{this.\u0275cmp=G({type:a,selectors:[["app-import"]],standalone:!0,features:[K],decls:20,vars:10,consts:[[1,"page-header"],[1,"page-title"],[1,"page-subtitle"],["class","alert alert-warning alert-dismissible fade show d-flex align-items-center justify-content-between",4,"ngIf"],[1,"nav","nav-tabs","mb-4"],[1,"nav-item"],["role","button",1,"nav-link",3,"click"],[1,"bi","bi-file-earmark-spreadsheet","me-1"],[1,"bi","bi-files","me-1"],[4,"ngIf"],[3,"showChange","templateSelected","show"],[3,"showChange","resolved","show","conflicts"],[1,"alert","alert-warning","alert-dismissible","fade","show","d-flex","align-items-center","justify-content-between"],[1,"d-flex","align-items-start"],[1,"bi","bi-tag","me-2"],[1,"d-flex","gap-2"],["type","button",1,"btn","btn-sm","btn-outline-warning",3,"click"],["type","button",1,"btn-close",3,"click"],["class","card mb-4",4,"ngIf"],[1,"card","mb-4"],[1,"card-header"],[1,"fw-semibold"],[1,"card-body"],[1,"small","text-muted","mb-3"],[1,"d-flex","flex-wrap","gap-2"],[1,"btn","btn-outline-secondary",3,"click"],[1,"bi","bi-download","me-1"],[1,"small","text-muted","mt-3","mb-0"],[1,"card"],[1,"mb-3"],[1,"small","text-muted","mb-0"],[1,"dropzone",3,"drop","dragover","dragleave"],[1,"bi","bi-upload","display-4","text-muted","mb-3"],[1,"h5","mb-2"],[1,"text-muted","mb-4"],[1,"d-flex","justify-content-center","gap-2","flex-wrap"],[1,"btn","btn-primary"],["type","file","accept",".xlsx,.xls,.csv",1,"d-none",3,"change"],[1,"bi","bi-file-earmark-text","me-1"],["class","alert alert-danger mt-4",4,"ngIf"],[1,"alert","alert-danger","mt-4"],[1,"d-flex","align-items-center","mb-2"],[1,"bi","bi-exclamation-circle","me-2"],[1,"mb-0","ps-3"],[4,"ngFor","ngForOf"],[1,"card-header","d-flex","justify-content-between","align-items-center"],[1,"d-flex","align-items-center"],[1,"bi","bi-check-circle-fill","text-success","me-2"],["class","badge bg-info ms-2",4,"ngIf"],[1,"btn","btn-sm","btn-outline-secondary",3,"click"],[1,"bi","bi-x-lg"],["class","alert alert-warning",4,"ngIf"],["class","alert alert-warning d-flex align-items-center justify-content-between",4,"ngIf"],[1,"mb-4"],[1,"fw-semibold","mb-2"],[1,"row","g-3","small"],[1,"col-6","col-md-3"],[1,"form-label","text-muted","small","mb-1"],["type","text",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],["type","date",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],[1,"d-flex","justify-content-between","align-items-center","mb-2"],[1,"fw-semibold","mb-0"],[1,"d-flex","align-items-center","gap-2"],[1,"form-label","mb-0","small","text-muted"],["type","number",1,"form-control","form-control-sm",2,"width","70px",3,"ngModelChange","change","ngModel","min"],["class","badge bg-secondary",4,"ngFor","ngForOf"],[1,"table-responsive","border","rounded",2,"max-height","300px","overflow-y","auto"],[1,"table","table-sm","mb-0"],[1,"table-secondary","sticky-top"],[1,"text-center"],["class","small text-muted text-center mt-2",4,"ngIf"],[1,"mb-4","p-3","bg-body-secondary","rounded"],[1,"form-check"],["type","checkbox","id","saveToCatalog",1,"form-check-input",3,"ngModelChange","ngModel"],["for","saveToCatalog",1,"form-check-label"],[1,"text-muted","small","d-block"],[1,"form-check","mt-2"],["type","checkbox","id","useLegacyFormat",1,"form-check-input",3,"ngModelChange","change","ngModel"],["for","useLegacyFormat",1,"form-check-label"],[1,"d-flex","justify-content-end","gap-2"],[1,"btn","btn-primary",3,"click","disabled"],[1,"bi","me-1"],[1,"badge","bg-info","ms-2"],[1,"alert","alert-warning"],[1,"alert","alert-warning","d-flex","align-items-center","justify-content-between"],[1,"bi","bi-exclamation-triangle","me-2"],[1,"btn","btn-sm","btn-warning",3,"click"],[1,"badge","bg-secondary"],[1,"font-mono"],[1,"text-muted"],[1,"small","text-muted","text-center","mt-2"],["class","card",4,"ngIf"],[1,"row","g-3"],[1,"col-sm-6","col-lg-4"],[1,"form-label","small"],["type","text","placeholder","e.g., 3930",1,"form-control","form-control-sm",3,"ngModelChange","input","ngModel"],["type","text","placeholder","Optional",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],["type","text","placeholder","e.g., Sonovision",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],[1,"bi","bi-files","display-4","text-muted","mb-3"],[1,"h5","mb-1"],[1,"text-muted","small","mb-3"],[1,"btn","btn-outline-secondary"],[1,"bi","bi-upload","me-1"],["type","file","accept",".csv","multiple","",1,"d-none",3,"change"],["class","mt-3",4,"ngIf"],["class","alert alert-danger mt-3",4,"ngIf"],["class","d-flex justify-content-end mt-3",4,"ngIf"],[1,"small","text-muted"],[1,"mt-3"],[1,"small","fw-semibold","mb-2"],["class","d-flex align-items-center justify-content-between p-3 bg-body-secondary rounded mb-1",4,"ngFor","ngForOf"],[1,"d-flex","align-items-center","justify-content-between","p-3","bg-body-secondary","rounded","mb-1"],[1,"bi","bi-file-earmark-text","text-muted"],[1,"font-mono","small"],[1,"text-muted","d-block"],[1,"bi","bi-trash"],[1,"alert","alert-danger","mt-3"],[1,"d-flex","justify-content-end","mt-3"],[1,"btn","btn-primary",3,"click"],[1,"row","g-3","mb-4"],[1,"col-4"],[1,"p-3","bg-body-secondary","rounded","text-center"],[1,"h4","fw-bold","mb-0"],[1,"p-3","rounded","text-center",2,"background-color","rgba(25, 135, 84, 0.1)"],[1,"h4","fw-bold","mb-0","text-success"],[1,"p-3","rounded","text-center",2,"background-color","rgba(13, 110, 253, 0.1)"],[1,"h4","fw-bold","mb-0","text-primary"],[1,"table-responsive","border","rounded",2,"max-height","400px","overflow-y","auto"],["type","checkbox","id","bomSaveToCatalog",1,"form-check-input",3,"ngModelChange","ngModel"],["for","bomSaveToCatalog",1,"form-check-label"],[1,"font-mono","small","text-muted"],["class","badge bg-success-subtle text-success border border-success",4,"ngIf"],["class","badge bg-primary-subtle text-primary border border-primary",4,"ngIf"],[1,"badge","bg-success-subtle","text-success","border","border-success"],[1,"badge","bg-primary-subtle","text-primary","border","border-primary"]],template:function(r,t){r&1&&(i(0,"div")(1,"div",0)(2,"h1",1),o(3,"Import Order"),n(),i(4,"p",2),o(5,"Upload an Excel or CSV file to import a sales order"),n()(),y(6,Xe,12,3,"div",3),i(7,"ul",4)(8,"li",5)(9,"a",6),g("click",function(){return t.activeTab="standard"}),b(10,"i",7),o(11," Standard Import "),n()(),i(12,"li",5)(13,"a",6),g("click",function(){return t.activeTab="multi-bom"}),b(14,"i",8),o(15," Multi-BOM Import "),n()()(),y(16,dt,59,2,"div",9)(17,Tt,3,2,"div",9),i(18,"app-template-select-dialog",10),R("showChange",function(p){return V(t.showTemplateDialog,p)||(t.showTemplateDialog=p),p}),g("templateSelected",function(p){return t.handleTemplateSelected(p)}),n(),i(19,"app-duplicate-parts-dialog",11),R("showChange",function(p){return V(t.showDuplicatesDialog,p)||(t.showDuplicatesDialog=p),p}),g("resolved",function(p){return t.handleConflictsResolved(p)}),n()()),r&2&&(l(6),c("ngIf",t.showUnclassifiedAlert&&t.unclassifiedPartsCount>0),l(3),B("active",t.activeTab==="standard"),l(4),B("active",t.activeTab==="multi-bom"),l(3),c("ngIf",t.activeTab==="standard"),l(),c("ngIf",t.activeTab==="multi-bom"),l(),O("show",t.showTemplateDialog),l(),O("show",t.showDuplicatesDialog),c("conflicts",t.partConflicts))},dependencies:[X,H,J,fe,Y,te,he,ge,ie,ve,ne,Ie,Ee],styles:[".dropzone[_ngcontent-%COMP%]{border:2px dashed var(--surface-border-strong);border-radius:var(--radius-lg);padding:3rem;text-align:center;transition:all var(--transition-fast)}.dropzone.dragover[_ngcontent-%COMP%]{border-color:var(--brand-primary);background-color:var(--brand-primary-subtle)}.dropzone[_ngcontent-%COMP%]:hover{border-color:var(--text-faint)}.spin[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_spin 1s linear infinite}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.sticky-top[_ngcontent-%COMP%]{position:sticky;top:0;z-index:1}"]})}}return a})();export{ti as ImportComponent};
