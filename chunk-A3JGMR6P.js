import{a as I}from"./chunk-XHNAPF2T.js";import{a as x}from"./chunk-FQB7FWF7.js";import{T as j,Y as v,g as b,ic as D}from"./chunk-DEIGHZUX.js";import{a as w,b as S,i as k}from"./chunk-P2VZOJAX.js";var W=(()=>{class _{constructor(t,r,s){this.supabase=t,this.demoMode=r,this.demoData=s,this.picksSubject=new b([]),this.lineItemsWithPicksSubject=new b([]),this.loadingSubject=new b(!0),this.errorSubject=new b(null),this.subscription=null,this.currentOrderId=null,this.picks$=this.picksSubject.asObservable(),this.lineItemsWithPicks$=this.lineItemsWithPicksSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable()}ngOnDestroy(){this.cleanup()}cleanup(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}loadPicksForOrder(t){return k(this,null,function*(){this.cleanup(),this.currentOrderId=t,yield this.fetchPicks(t),this.demoMode.isDemoMode()||this.setupRealtimeSubscription(t)})}setupRealtimeSubscription(t){this.demoMode.isDemoMode()||(this.subscription=this.supabase.channel(`picks-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"picks"},()=>{this.currentOrderId&&this.fetchPicks(this.currentOrderId)}).subscribe())}fetchPicks(t){return k(this,null,function*(){try{if(this.loadingSubject.next(!0),this.errorSubject.next(null),this.demoMode.isDemoMode()){let i=this.demoData.getLineItems(t),c=i.map(o=>o.id),u=[];c.forEach(o=>{let a=this.demoData.getPicks(o);u.push(...a)}),u.sort((o,a)=>new Date(a.picked_at).getTime()-new Date(o.picked_at).getTime()),this.picksSubject.next(u);let d=new Map;for(let o of u){let a=d.get(o.line_item_id)||[];a.push(o),d.set(o.line_item_id,a)}let h=i.map(o=>{let a=d.get(o.id)||[],g=a.filter(m=>!m.undone_at).reduce((m,P)=>m+P.qty_picked,0);return S(w({},o),{picks:a,total_picked:g,remaining:Math.max(0,o.total_qty_needed-g)})});this.lineItemsWithPicksSubject.next(h),this.loadingSubject.next(!1);return}let{data:r,error:s}=yield this.supabase.from("line_items").select("*").eq("order_id",t).order("part_number");if(s)throw s;let e=(r||[]).map(i=>i.id),n=[];if(e.length>0){let c=0,u=!0;for(;u;){let{data:d,error:h}=yield this.supabase.from("picks").select("*").in("line_item_id",e).order("picked_at",{ascending:!1}).range(c,c+1e3-1);if(h)throw h;d&&d.length>0?(n.push(...d),c+=1e3,u=d.length===1e3):u=!1}}this.picksSubject.next(n);let l=new Map;for(let i of n){let c=l.get(i.line_item_id)||[];c.push(i),l.set(i.line_item_id,c)}let p=(r||[]).map(i=>{let c=l.get(i.id)||[],d=c.filter(h=>!h.undone_at).reduce((h,o)=>h+o.qty_picked,0);return S(w({},i),{picks:c,total_picked:d,remaining:Math.max(0,i.total_qty_needed-d)})});this.lineItemsWithPicksSubject.next(p)}catch(r){this.errorSubject.next(r instanceof Error?r.message:"Failed to fetch picks")}finally{this.loadingSubject.next(!1)}})}recordPick(t,r,s,e,n){return k(this,null,function*(){try{if(this.demoMode.isDemoMode()){let a=this.demoData.getLineItems().find(y=>y.id===t),m=this.demoData.getPicks(t).filter(y=>!y.undone_at).reduce((y,E)=>y+E.qty_picked,0)+s,P=a?.total_qty_needed||0,q=this.demoData.addPick({line_item_id:t,tool_id:r,qty_picked:s,picked_by:e||null,notes:n||null,picked_at:new Date().toISOString(),undone_at:null,undone_by:null});return this.currentOrderId&&(yield this.fetchPicks(this.currentOrderId)),m>P?S(w({},q),{overPickWarning:`Over-picked! ${m} picked but only ${P} needed.`}):q}let{data:l}=yield this.supabase.from("line_items").select("total_qty_needed").eq("id",t).single(),{data:p}=yield this.supabase.from("picks").select("qty_picked").eq("line_item_id",t).is("undone_at",null),c=(p||[]).reduce((o,a)=>o+a.qty_picked,0)+s,u=l?.total_qty_needed||0,{data:d,error:h}=yield this.supabase.from("picks").insert({line_item_id:t,tool_id:r,qty_picked:s,picked_by:e||null,notes:n||null}).select().single();if(h)throw h;return c>u?S(w({},d),{overPickWarning:`Over-picked! ${c} picked but only ${u} needed. Someone may have picked this item at the same time.`}):d}catch(l){return this.errorSubject.next(l instanceof Error?l.message:"Failed to record pick"),null}})}undoPick(t,r){return k(this,null,function*(){try{let e=this.picksSubject.getValue().find(o=>o.id===t);if(!e)throw new Error("Pick not found");let l=this.lineItemsWithPicksSubject.getValue().find(o=>o.id===e.line_item_id),{data:p}=yield this.supabase.from("tools").select("tool_number, order_id").eq("id",e.tool_id).single(),i="",c=l?.order_id||"";if(p){c=c||p.order_id;let{data:o}=yield this.supabase.from("orders").select("so_number").eq("id",p.order_id).single();i=o?.so_number||""}let u=r||"Unknown",{error:d}=yield this.supabase.from("pick_undos").insert({original_pick_id:e.id,line_item_id:e.line_item_id,tool_id:e.tool_id,qty_picked:e.qty_picked,picked_by:e.picked_by,notes:e.notes,picked_at:e.picked_at,part_number:l?.part_number||"",tool_number:p?.tool_number||"",so_number:i,order_id:c,undone_by:u});if(d)throw d;let{error:h}=yield this.supabase.from("picks").update({undone_at:new Date().toISOString(),undone_by:u}).eq("id",t);if(h)throw h;return!0}catch(s){return this.errorSubject.next(s instanceof Error?s.message:"Failed to undo pick"),!1}})}getPicksForTool(t){let r=this.picksSubject.getValue(),s=new Map;for(let e of r)if(e.tool_id===t&&!e.undone_at){let n=s.get(e.line_item_id)||0;s.set(e.line_item_id,n+e.qty_picked)}return s}getPickHistory(t,r){return this.picksSubject.getValue().filter(e=>e.line_item_id===t&&e.tool_id===r).sort((e,n)=>new Date(n.picked_at).getTime()-new Date(e.picked_at).getTime())}getLastPick(t,r){let e=this.getPickHistory(t,r).filter(n=>!n.undone_at);return e.length>0?e[0]:null}getPicksForAllTools(){let t=this.picksSubject.getValue(),r=new Map;for(let s of t)if(!s.undone_at){r.has(s.tool_id)||r.set(s.tool_id,new Map);let e=r.get(s.tool_id),n=e.get(s.line_item_id)||0;e.set(s.line_item_id,n+s.qty_picked)}return r}recordPickForLineItem(t,r,s,e){return k(this,null,function*(){try{let{data:n,error:l}=yield this.supabase.from("line_items").select("order_id").eq("id",t).single();if(l||!n)throw new Error("Line item not found");let{data:p,error:i}=yield this.supabase.from("tools").select("id").eq("order_id",n.order_id).order("tool_number").limit(1);if(i||!p||p.length===0)throw new Error("No tools found for order");let c=p[0].id;return this.recordPick(t,c,r,s,e)}catch(n){return this.errorSubject.next(n instanceof Error?n.message:"Failed to record pick"),null}})}batchUpdateAllocations(t,r,s,e){return k(this,null,function*(){try{let n=this.getPicksForAllTools();for(let[l,p]of r){let c=n.get(l)?.get(t)||0,u=p-c;if(u>0){let{error:d}=yield this.supabase.from("picks").insert({line_item_id:t,tool_id:l,qty_picked:u,picked_by:s||null,notes:e||null});if(d)throw d}else if(u<0){let h=this.getPickHistory(t,l).filter(a=>!a.undone_at),o=Math.abs(u);for(let a of h){if(o<=0)break;if(a.qty_picked<=o){let{error:f}=yield this.supabase.from("picks").update({undone_at:new Date().toISOString(),undone_by:s||"System"}).eq("id",a.id);if(f)throw f;o-=a.qty_picked}else{let f=a.qty_picked-o,{error:g}=yield this.supabase.from("picks").update({undone_at:new Date().toISOString(),undone_by:s||"System"}).eq("id",a.id);if(g)throw g;let{error:m}=yield this.supabase.from("picks").insert({line_item_id:t,tool_id:l,qty_picked:f,picked_by:a.picked_by,notes:a.notes});if(m)throw m;o=0}}}}return!0}catch(n){return this.errorSubject.next(n instanceof Error?n.message:"Failed to update allocations"),!1}})}static{this.\u0275fac=function(r){return new(r||_)(v(D),v(x),v(I))}}static{this.\u0275prov=j({token:_,factory:_.\u0275fac,providedIn:"root"})}}return _})(),A=(()=>{class _{constructor(t){this.supabase=t,this.activitiesSubject=new b([]),this.loadingSubject=new b(!0),this.subscription=null,this.activities$=this.activitiesSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.fetchActivity(),this.setupRealtimeSubscription()}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}setupRealtimeSubscription(){this.subscription=this.supabase.channel("activity-feed").on("postgres_changes",{event:"INSERT",schema:"public",table:"picks"},()=>this.fetchActivity()).on("postgres_changes",{event:"INSERT",schema:"public",table:"pick_undos"},()=>this.fetchActivity()).subscribe()}fetchActivity(){return k(this,null,function*(){try{this.loadingSubject.next(!0);let{data:t,error:r}=yield this.supabase.from("picks").select(`
          id,
          qty_picked,
          picked_by,
          picked_at,
          line_items!inner (
            part_number,
            order_id,
            orders!inner (
              so_number
            )
          )
        `).is("undone_at",null).order("picked_at",{ascending:!1}).limit(20);r&&console.error("Error fetching activity:",r);let s=(t||[]).map(i=>({id:i.id,type:"pick",message:`Picked ${i.qty_picked}x ${i.line_items.part_number}`,timestamp:i.picked_at,user:i.picked_by||"Unknown",order_id:i.line_items.order_id,so_number:i.line_items.orders.so_number})),{data:e,error:n}=yield this.supabase.from("pick_undos").select("*").order("undone_at",{ascending:!1}).limit(20);n&&console.error("Error fetching undo activity:",n);let l=(e||[]).map(i=>({id:i.id,type:"pick_undo",message:`Undid ${i.qty_picked}x ${i.part_number}`,timestamp:i.undone_at,user:i.undone_by||"Unknown",order_id:i.order_id,so_number:i.so_number})),p=[...s,...l].sort((i,c)=>new Date(c.timestamp).getTime()-new Date(i.timestamp).getTime()).slice(0,20);this.activitiesSubject.next(p)}catch(t){console.error("Error fetching activity:",t),this.activitiesSubject.next([])}finally{this.loadingSubject.next(!1)}})}static{this.\u0275fac=function(r){return new(r||_)(v(D))}}static{this.\u0275prov=j({token:_,factory:_.\u0275fac,providedIn:"root"})}}return _})();export{W as a,A as b};
