import{a as ge}from"./chunk-BR5AXGI3.js";import{a as Se}from"./chunk-JMCLK4XY.js";import{a as ye}from"./chunk-TIC6WQIR.js";import{a as le,b as ce,c as de,f as ue,i as pe,j as me,k as fe,n as he}from"./chunk-ACCF75FY.js";import{$a as b,$b as re,Ca as c,Da as D,Sa as C,T as B,Ua as h,Va as ie,Wa as ne,Xa as F,Y as V,Za as n,_a as i,ac as ae,ca as te,cb as $,db as k,dc as oe,eb as P,g as M,ic as W,ka as x,la as w,mb as s,nb as X,ob as A,pb as j,rb as Q,sb as Y,tb as H,vb as se}from"./chunk-2TFJQIGG.js";import{a as K,b as G,e as R}from"./chunk-DVOCWXDE.js";var ve=(()=>{class r{constructor(e){this.supabase=e,this.syncingSubject=new M(!1),this.lastSyncResultSubject=new M(null),this.syncing$=this.syncingSubject.asObservable(),this.lastSyncResult$=this.lastSyncResultSubject.asObservable()}syncInventory(e){return R(this,null,function*(){this.syncingSubject.next(!0);let l=[],t=[],a=0,p=0;try{let d=yield this.parseInventoryFile(e);if(!d.success){let o={success:!1,updatedCount:0,notFoundCount:0,errors:d.errors,notFoundParts:[]};return this.lastSyncResultSubject.next(o),this.syncingSubject.next(!1),o}let L=d.inventory,v=[],N=1e3,y=0,E=!0;for(;E;){let{data:o,error:u}=yield this.supabase.from("line_items").select("id, part_number").range(y,y+N-1);if(u)throw new Error(`Failed to fetch line items: ${u.message}`);o&&o.length>0?(v.push(...o),y+=N,E=o.length===N):E=!1}if(!v||v.length===0){let o={success:!0,updatedCount:0,notFoundCount:0,errors:["No line items found in database"],notFoundParts:[]};return this.lastSyncResultSubject.next(o),this.syncingSubject.next(!1),o}let _=new Map;for(let o of v){let u=o.part_number;_.has(u)||_.set(u,[]),_.get(u).push(o.id)}let f=!0;for(let[o,u]of _){let I=L[o];if(I){let O=!1;if(f){let{error:m}=yield this.supabase.from("line_items").update({location:I.location,qty_available:I.qtyAvailable}).in("id",u);if(m){let T=m.message.toLowerCase();if(T.includes("qty_available")&&(T.includes("does not exist")||T.includes("could not find")||T.includes("schema cache")))f=!1;else{l.push(`Failed to update ${o}: ${m.message}`);continue}}else O=!0,a+=u.length}if(!f&&!O){let{error:m}=yield this.supabase.from("line_items").update({location:I.location}).in("id",u);m?l.push(`Failed to update ${o}: ${m.message}`):a+=u.length}}else p+=u.length,t.includes(o)||t.push(o)}f||l.push("Note: qty_available column not found - only locations were updated. Run the migration SQL in Settings to enable stock tracking.");let g={success:l.length===0,updatedCount:a,notFoundCount:p,errors:l,notFoundParts:t};return this.lastSyncResultSubject.next(g),this.syncingSubject.next(!1),g}catch(d){let L={success:!1,updatedCount:a,notFoundCount:p,errors:[d instanceof Error?d.message:"Unknown error"],notFoundParts:t};return this.lastSyncResultSubject.next(L),this.syncingSubject.next(!1),L}})}parseInventoryFile(e){return R(this,null,function*(){let l=[];try{let t=yield import("./chunk-2E7OKCGY.js"),a=yield e.arrayBuffer(),p=t.read(a,{type:"array"}),d=p.SheetNames[0];if(!d)return{success:!1,inventory:{},totalRecords:0,uniqueParts:0,errors:["No sheets found in workbook"]};let L=p.Sheets[d],v=t.utils.sheet_to_json(L,{header:1,defval:""});if(v.length<2)return{success:!1,inventory:{},totalRecords:0,uniqueParts:0,errors:["Sheet has no data rows"]};let N=v[0],y=this.detectInventoryColumns(N);if(y.productId===-1)return{success:!1,inventory:{},totalRecords:0,uniqueParts:0,errors:["Could not find Product Id column in inventory file"]};let E=[];for(let f=1;f<v.length;f++){let g=v[f];if(!g||g.length===0)continue;let o=g[y.productId],u=o!=null?String(o).trim():"";if(!u)continue;let I=String(g[y.lotId]||""),O=String(g[y.location]||"").trim(),m=this.parseNumber(g[y.qtyAvailable]);!O||["awaiting inspection","receiving","qa","quarantine"].some(q=>O.toLowerCase().includes(q))||E.push({partNumber:u,location:O,qtyAvailable:m,lotId:I})}let _={};for(let f of E){let g=_[f.partNumber];(!g||f.lotId>g.lotId)&&(_[f.partNumber]={location:f.location,qtyAvailable:f.qtyAvailable,lotId:f.lotId})}return{success:!0,inventory:_,totalRecords:E.length,uniqueParts:Object.keys(_).length,errors:l}}catch(t){return{success:!1,inventory:{},totalRecords:0,uniqueParts:0,errors:[`Failed to parse inventory file: ${t instanceof Error?t.message:"Unknown error"}`]}}})}detectInventoryColumns(e){let l={productId:-1,lotId:-1,location:-1,qtyAvailable:-1};for(let t=0;t<e.length;t++){let a=String(e[t]||"").toLowerCase().trim();(a.includes("product")&&a.includes("id")||a==="product id"||a==="productid"||a==="part number"||a==="part_number")&&(l.productId=t),(a.includes("lot")&&a.includes("id")||a==="lot id"||a==="lotid")&&(l.lotId=t),(a==="location"||a==="loc"||a==="bin")&&(l.location=t),(a.includes("qty")&&a.includes("available")||a==="qty available"||a==="qtyavailable"||a==="available")&&(l.qtyAvailable=t)}return l}parseNumber(e){if(typeof e=="number")return Math.max(0,Math.round(e));if(typeof e=="string"){let l=e.replace(/[^\d.-]/g,""),t=parseFloat(l);return isNaN(t)?0:Math.max(0,Math.round(t))}return 0}static{this.\u0275fac=function(l){return new(l||r)(V(W))}}static{this.\u0275prov=B({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var _e=(()=>{class r{constructor(e){this.supabase=e,this.syncingSubject=new M(!1),this.lastSyncResultSubject=new M(null),this.syncing$=this.syncingSubject.asObservable(),this.lastSyncResult$=this.lastSyncResultSubject.asObservable()}syncPartList(e){return R(this,null,function*(){this.syncingSubject.next(!0);let l=[],t=[],a=0,p=0;try{let d=yield this.parsePartListFile(e);if(!d.success){let o={success:!1,updatedCount:0,notFoundCount:0,errors:d.errors,notFoundParts:[]};return this.lastSyncResultSubject.next(o),this.syncingSubject.next(!1),o}let L=d.partList,v=[],N=1e3,y=0,E=!0;for(;E;){let{data:o,error:u}=yield this.supabase.from("line_items").select("id, part_number").range(y,y+N-1);if(u)throw new Error(`Failed to fetch line items: ${u.message}`);o&&o.length>0?(v.push(...o),y+=N,E=o.length===N):E=!1}if(!v||v.length===0){let o={success:!0,updatedCount:0,notFoundCount:0,errors:["No line items found in database"],notFoundParts:[]};return this.lastSyncResultSubject.next(o),this.syncingSubject.next(!1),o}let _=new Map;for(let o of v){let u=o.part_number;_.has(u)||_.set(u,[]),_.get(u).push(o.id)}let f=!0;for(let[o,u]of _){let I=L[o];if(I){let O=!1,m={};if(I.location!==null&&(m.location=I.location),I.description!==null&&(m.description=I.description),m.qty_available=I.qtyAvailable,f){let{error:T}=yield this.supabase.from("line_items").update(G(K({},m),{qty_on_order:I.qtyOnOrder})).in("id",u);if(T){let q=T.message.toLowerCase();if(q.includes("qty_on_order")&&(q.includes("does not exist")||q.includes("could not find")||q.includes("schema cache")))f=!1;else{l.push(`Failed to update ${o}: ${T.message}`);continue}}else O=!0,a+=u.length}if(!f&&!O){let{error:T}=yield this.supabase.from("line_items").update(m).in("id",u);T?l.push(`Failed to update ${o}: ${T.message}`):a+=u.length}}else p+=u.length,t.includes(o)||t.push(o)}f||l.push('Note: qty_on_order column not found - run the migration SQL in Settings to enable "Qty On Order" tracking.');let g={success:l.filter(o=>!o.startsWith("Note:")).length===0,updatedCount:a,notFoundCount:p,errors:l,notFoundParts:t};return this.lastSyncResultSubject.next(g),this.syncingSubject.next(!1),g}catch(d){let L={success:!1,updatedCount:a,notFoundCount:p,errors:[d instanceof Error?d.message:"Unknown error"],notFoundParts:t};return this.lastSyncResultSubject.next(L),this.syncingSubject.next(!1),L}})}parsePartListFile(e){return R(this,null,function*(){let l=[];try{let t=yield import("./chunk-2E7OKCGY.js"),a=yield e.arrayBuffer(),p=t.read(a,{type:"array"}),d=p.SheetNames[0];if(!d)return{success:!1,partList:{},totalRecords:0,uniqueParts:0,errors:["No sheets found in workbook"]};let L=p.Sheets[d],v=t.utils.sheet_to_json(L,{header:1,defval:""});if(v.length<2)return{success:!1,partList:{},totalRecords:0,uniqueParts:0,errors:["Sheet has no data rows"]};let N=v[0],y=this.detectPartListColumns(N);if(y.productId===-1)return{success:!1,partList:{},totalRecords:0,uniqueParts:0,errors:['Could not find Product Id column in Part List file. Expected column names: "Product Id", "Part Number"']};let E={},_=0;for(let f=1;f<v.length;f++){let g=v[f];if(!g||g.length===0)continue;let o=g[y.productId],u=o!=null?String(o).trim():"";if(!u)continue;let I=y.location!==-1?this.normalizeString(g[y.location]):null,O=this.parseNumber(g[y.qtyAvailable]),m=this.parseNumber(g[y.qtyOnOrder]),T=y.description!==-1?this.normalizeString(g[y.description]):null;_++,E[u]={partNumber:u,location:I,qtyAvailable:O,qtyOnOrder:m,description:T}}return{success:!0,partList:E,totalRecords:_,uniqueParts:Object.keys(E).length,errors:l}}catch(t){return{success:!1,partList:{},totalRecords:0,uniqueParts:0,errors:[`Failed to parse Part List file: ${t instanceof Error?t.message:"Unknown error"}`]}}})}detectPartListColumns(e){let l={productId:-1,location:-1,qtyAvailable:-1,qtyOnOrder:-1,description:-1};for(let t=0;t<e.length;t++){let a=String(e[t]||"").toLowerCase().trim();(a.includes("product")&&a.includes("id")||a==="product id"||a==="productid"||a==="part number"||a==="part_number"||a==="partnumber")&&(l.productId=t),(a==="location"||a==="locations"||a==="location(s)"||a==="loc"||a==="bin")&&(l.location=t),(a.includes("qty")&&a.includes("available")||a==="qty available"||a==="qtyavailable"||a==="available"||a==="qty avail")&&(l.qtyAvailable=t),(a.includes("qty")&&a.includes("order")||a==="qty on order"||a==="qtyonorder"||a==="on order"||a==="qty ordered")&&(l.qtyOnOrder=t),(a==="description"||a==="desc"||a==="part description")&&(l.description=t)}return l}normalizeString(e){if(e==null||e==="")return null;let l=String(e).trim();return l===""?null:l}parseNumber(e){if(typeof e=="number")return Math.max(0,Math.round(e));if(typeof e=="string"){let l=e.replace(/[^\d.-]/g,""),t=parseFloat(l);return isNaN(t)?0:Math.max(0,Math.round(t))}return 0}static{this.\u0275fac=function(l){return new(l||r)(V(W))}}static{this.\u0275prov=B({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var Te="5eaaffe8-b522-45af-a78d-e59763f0d9ce",Ee=30,Ce=500,xe=(()=>{class r{constructor(e){this.supabase=e,this.syncingSubject=new M(!1),this.progressSubject=new M(null),this.lastSyncResultSubject=new M(null),this.syncing$=this.syncingSubject.asObservable(),this.progress$=this.progressSubject.asObservable(),this.lastSyncResult$=this.lastSyncResultSubject.asObservable()}syncFromApi(){return R(this,null,function*(){this.syncingSubject.next(!0),this.progressSubject.next({currentBatch:0,totalBatches:0,status:"Fetching line items..."});let e=[],l=[],t=0,a=0;try{let p=[],L=0,v=!0;for(;v;){let{data:o,error:u}=yield this.supabase.from("line_items").select("id, part_number").range(L,L+1e3-1);if(u)throw new Error(`Failed to fetch line items: ${u.message}`);o&&o.length>0?(p.push(...o),L+=1e3,v=o.length===1e3):v=!1}if(!p||p.length===0){let o={success:!0,updatedCount:0,notFoundCount:0,notFoundParts:[],errors:["No line items found in database"]};return this.lastSyncResultSubject.next(o),o}let N=new Map;for(let o of p){let u=N.get(o.part_number)||[];u.push(o.id),N.set(o.part_number,u)}let y=Array.from(N.keys()),E=[];for(let o=0;o<y.length;o+=Ee)E.push(y.slice(o,o+Ee));let _=E.length;this.progressSubject.next({currentBatch:0,totalBatches:_,status:`Processing 0 of ${_} batches...`});let f=!0;for(let o=0;o<E.length;o++){let u=E[o];this.progressSubject.next({currentBatch:o+1,totalBatches:_,status:`Processing batch ${o+1} of ${_}...`});let I;try{let m=yield fetch("/api/proxy/product/searchproducts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({UserId:Te,ProductIdList:u})});if(!m.ok){e.push(`Batch ${o+1}: API returned ${m.status} ${m.statusText}`);continue}I=yield m.json()}catch(m){e.push(`Batch ${o+1}: Network error - ${m instanceof Error?m.message:"Unknown error"}`);continue}let O=new Map;for(let m of I)O.set(m.ProductId,m);for(let m of u){let T=O.get(m),q=N.get(m)||[];if(!T){a+=q.length,l.includes(m)||l.push(m);continue}let J={qty_available:T.QuantityOnHand,description:T.Description},ee=!1;if(f){let{error:U}=yield this.supabase.from("line_items").update(G(K({},J),{qty_on_order:T.QuantityOnOrder})).in("id",q);if(U){let z=U.message.toLowerCase();if(z.includes("qty_on_order")&&(z.includes("does not exist")||z.includes("could not find")||z.includes("schema cache")))f=!1;else{e.push(`Failed to update ${m}: ${U.message}`);continue}}else ee=!0,t+=q.length}if(!f&&!ee){let{error:U}=yield this.supabase.from("line_items").update(J).in("id",q);U?e.push(`Failed to update ${m}: ${U.message}`):t+=q.length}}o<E.length-1&&(yield new Promise(m=>setTimeout(m,Ce)))}f||e.push('Note: qty_on_order column not found - run the migration SQL in Settings to enable "Qty On Order" tracking.');let g={success:e.filter(o=>!o.startsWith("Note:")).length===0,updatedCount:t,notFoundCount:a,notFoundParts:l,errors:e};return this.lastSyncResultSubject.next(g),g}catch(p){let d={success:!1,updatedCount:t,notFoundCount:a,notFoundParts:l,errors:[p instanceof Error?p.message:"Unknown error"]};return this.lastSyncResultSubject.next(d),d}finally{this.syncingSubject.next(!1),this.progressSubject.next(null)}})}static{this.\u0275fac=function(l){return new(l||r)(V(W))}}static{this.\u0275prov=B({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();function Le(r,S){if(r&1){let e=$();n(0,"button",68),k("click",function(){x(e);let t=P();return w(t.syncOfflineQueue())}),b(1,"i",69),s(2),i()}if(r&2){let e=P();h("disabled",e.isSyncing||!e.isOnline),c(),ne("spin",e.isSyncing),c(),A(" ",e.isSyncing?"Syncing...":"Sync Offline Picks"," ")}}function Ae(r,S){r&1&&(n(0,"div",15),s(1," App is already installed or not installable in this browser "),i())}function Ne(r,S){if(r&1){let e=$();n(0,"div",70)(1,"div",71)(2,"button",43),k("click",function(){x(e);let t=P();return w(t.copySchema())}),b(3,"i",44),s(4),i()(),n(5,"pre",72),s(6),i()()}if(r&2){let e=P();c(3),F(e.schemaCopied?"bi-check-lg":"bi-clipboard"),c(),A(" ",e.schemaCopied?"Copied!":"Copy to Clipboard"," "),c(2),X(e.schemaSql)}}function Re(r,S){if(r&1&&(n(0,"li"),s(1),i()),r&2){let e=S.$implicit;c(),X(e)}}function ke(r,S){if(r&1&&(n(0,"div",77)(1,"div",74),s(2,"Errors:"),i(),n(3,"ul",78),C(4,Re,2,1,"li",79),i()()),r&2){let e=P(2);c(4),h("ngForOf",e.inventorySyncResult.errors)}}function Oe(r,S){if(r&1&&(n(0,"code"),s(1),i()),r&2){let e=S.$implicit,l=S.last;c(),j(" ",e,"",l?"":", "," ")}}function Fe(r,S){if(r&1&&(n(0,"div",82),C(1,Oe,2,2,"code",79),i()),r&2){let e=P(3);c(),h("ngForOf",e.inventorySyncResult.notFoundParts)}}function qe(r,S){if(r&1){let e=$();n(0,"div")(1,"button",80),k("click",function(){x(e);let t=P(2);return w(t.showNotFoundParts=!t.showNotFoundParts)}),s(2),i(),C(3,Fe,2,1,"div",81),i()}if(r&2){let e=P(2);c(2),j(" ",e.showNotFoundParts?"Hide":"Show"," ",e.inventorySyncResult.notFoundParts.length," not found parts "),c(),h("ngIf",e.showNotFoundParts)}}function Me(r,S){if(r&1&&(n(0,"div",70)(1,"div",73)(2,"div",74),s(3),i(),n(4,"div"),s(5),i(),n(6,"div"),s(7),i()(),C(8,ke,5,1,"div",75)(9,qe,4,3,"div",76),i()),r&2){let e=P();c(),F(e.inventorySyncResult.success?"alert alert-success":"alert alert-warning"),c(2),A(" ",e.inventorySyncResult.success?"Sync Complete":"Sync Completed with Issues"," "),c(2),A("Updated: ",e.inventorySyncResult.updatedCount," line items"),c(2),A("Not found: ",e.inventorySyncResult.notFoundCount," line items"),c(),h("ngIf",e.inventorySyncResult.errors.length>0),c(),h("ngIf",e.inventorySyncResult.notFoundParts.length>0)}}function je(r,S){if(r&1&&(n(0,"li"),s(1),i()),r&2){let e=S.$implicit;c(),X(e)}}function De(r,S){if(r&1&&(n(0,"div",77)(1,"div",74),s(2,"Errors:"),i(),n(3,"ul",78),C(4,je,2,1,"li",79),i()()),r&2){let e=P(2);c(4),h("ngForOf",e.partListSyncResult.errors)}}function Ue(r,S){if(r&1&&(n(0,"div",70)(1,"div",73)(2,"div",74),s(3),i(),n(4,"div"),s(5),i(),n(6,"div"),s(7),i()(),C(8,De,5,1,"div",75),i()),r&2){let e=P();c(),F(e.partListSyncResult.success?"alert alert-success":"alert alert-warning"),c(2),A(" ",e.partListSyncResult.success?"Sync Complete":"Sync Completed with Issues"," "),c(2),A("Updated: ",e.partListSyncResult.updatedCount," line items"),c(2),A("Not found: ",e.partListSyncResult.notFoundCount," line items"),c(),h("ngIf",e.partListSyncResult.errors.length>0)}}function Be(r,S){if(r&1&&(n(0,"div",12)(1,"div",83)(2,"span",84),s(3),i(),n(4,"span",23),s(5),i()(),n(6,"div",85),b(7,"div",86),i()()),r&2){let e=P();c(3),X(e.apiProgress.status),c(2),j("",e.apiProgress.currentBatch," / ",e.apiProgress.totalBatches,""),c(2),ie("width",e.apiProgress.totalBatches>0?e.apiProgress.currentBatch/e.apiProgress.totalBatches*100:0,"%")}}function Ve(r,S){if(r&1&&(n(0,"div",88),s(1),i()),r&2){let e=P(2);c(),j(" Not found in API: ",e.apiSyncResult.notFoundCount," line items (",e.apiSyncResult.notFoundParts.length," unique parts) ")}}function $e(r,S){if(r&1&&(n(0,"li"),s(1),i()),r&2){let e=S.$implicit;c(),X(e)}}function Xe(r,S){if(r&1&&(n(0,"div",77)(1,"div",74),s(2,"Errors:"),i(),n(3,"ul",78),C(4,$e,2,1,"li",79),i()()),r&2){let e=P(2);c(4),h("ngForOf",e.apiSyncResult.errors)}}function We(r,S){if(r&1&&(n(0,"code"),s(1),i()),r&2){let e=S.$implicit,l=S.last;c(),j(" ",e,"",l?"":", "," ")}}function Qe(r,S){if(r&1&&(n(0,"div",82),C(1,We,2,2,"code",79),i()),r&2){let e=P(3);c(),h("ngForOf",e.apiSyncResult.notFoundParts)}}function Ye(r,S){if(r&1){let e=$();n(0,"div")(1,"button",80),k("click",function(){x(e);let t=P(2);return w(t.showApiNotFoundParts=!t.showApiNotFoundParts)}),s(2),i(),C(3,Qe,2,1,"div",81),i()}if(r&2){let e=P(2);c(2),j(" ",e.showApiNotFoundParts?"Hide":"Show"," ",e.apiSyncResult.notFoundParts.length," not found parts "),c(),h("ngIf",e.showApiNotFoundParts)}}function He(r,S){if(r&1&&(n(0,"div",70)(1,"div",73)(2,"div",74),s(3),i(),n(4,"div"),s(5),i(),C(6,Ve,2,2,"div",87),i(),C(7,Xe,5,1,"div",75)(8,Ye,4,3,"div",76),i()),r&2){let e=P();c(),F(e.apiSyncResult.success?"alert alert-success":"alert alert-warning"),c(2),A(" ",e.apiSyncResult.success?"API Sync Complete":"API Sync Failed"," "),c(2),A("Updated: ",e.apiSyncResult.updatedCount," line items"),c(),h("ngIf",e.apiSyncResult.notFoundCount>0),c(),h("ngIf",e.apiSyncResult.errors.length>0),c(),h("ngIf",e.apiSyncResult.notFoundParts.length>0&&e.apiSyncResult.notFoundParts.length<=20)}}function ze(r,S){r&1&&(n(0,"div",89),b(1,"i",90),s(2," Backup exported successfully! "),i())}var ct=(()=>{class r{get isApiPasswordCorrect(){return this.apiPassword===this.API_SYNC_PASSWORD}constructor(e,l,t,a,p,d){this.settingsService=e,this.inventorySyncService=l,this.partListSyncService=t,this.apiSyncService=a,this.excelService=p,this.offlineService=d,this.userName="",this.theme="system",this.tagPrintingEnabled=!1,this.isOnline=navigator.onLine,this.offlineQueueCount=0,this.isSyncing=!1,this.canInstallPwa=!1,this.deferredPrompt=null,this.inventoryFile=null,this.inventorySyncing=!1,this.inventorySyncResult=null,this.showNotFoundParts=!1,this.partListFile=null,this.partListSyncing=!1,this.partListSyncResult=null,this.apiPassword="",this.apiSyncing=!1,this.apiProgress=null,this.apiSyncResult=null,this.showApiNotFoundParts=!1,this.API_SYNC_PASSWORD="33214551",this.showSchema=!1,this.schemaCopied=!1,this.schemaSql=`-- Sales Orders
CREATE TABLE IF NOT EXISTS orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  so_number TEXT NOT NULL UNIQUE,
  po_number TEXT,
  customer_name TEXT,
  order_date DATE,
  due_date DATE,
  estimated_ship_date DATE,
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'complete', 'cancelled')),
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tools (units being built within an order)
CREATE TABLE IF NOT EXISTS tools (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
  tool_number TEXT NOT NULL,
  serial_number TEXT,
  tool_model TEXT,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'in-progress', 'complete')),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Line Items (parts to pick)
CREATE TABLE IF NOT EXISTS line_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
  part_number TEXT NOT NULL,
  description TEXT,
  location TEXT,
  qty_per_unit INTEGER NOT NULL,
  total_qty_needed INTEGER NOT NULL,
  qty_available INTEGER,
  tool_ids UUID[],
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Pick Records (actual picks - append-only for conflict-free sync)
CREATE TABLE IF NOT EXISTS picks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  line_item_id UUID REFERENCES line_items(id) ON DELETE CASCADE,
  tool_id UUID REFERENCES tools(id) ON DELETE CASCADE,
  qty_picked INTEGER NOT NULL,
  picked_by TEXT,
  notes TEXT,
  picked_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable Row Level Security (allow all for now - can be tightened later)
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE tools ENABLE ROW LEVEL SECURITY;
ALTER TABLE line_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE picks ENABLE ROW LEVEL SECURITY;

-- Policies for anonymous access (development)
CREATE POLICY "Allow all operations on orders" ON orders FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all operations on tools" ON tools FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all operations on line_items" ON line_items FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all operations on picks" ON picks FOR ALL USING (true) WITH CHECK (true);

-- Enable realtime
ALTER PUBLICATION supabase_realtime ADD TABLE orders;
ALTER PUBLICATION supabase_realtime ADD TABLE tools;
ALTER PUBLICATION supabase_realtime ADD TABLE line_items;
ALTER PUBLICATION supabase_realtime ADD TABLE picks;

-- Index for performance
CREATE INDEX IF NOT EXISTS idx_tools_order_id ON tools(order_id);
CREATE INDEX IF NOT EXISTS idx_line_items_order_id ON line_items(order_id);
CREATE INDEX IF NOT EXISTS idx_picks_line_item_id ON picks(line_item_id);
CREATE INDEX IF NOT EXISTS idx_picks_tool_id ON picks(tool_id);
CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
CREATE INDEX IF NOT EXISTS idx_line_items_part_number ON line_items(part_number);`,this.exportingBackup=!1,this.backupExported=!1,this.subscriptions=[]}ngOnInit(){this.subscriptions.push(this.settingsService.settings$.subscribe(e=>{this.userName=e.user_name,this.theme=e.theme,this.tagPrintingEnabled=e.tagPrintingEnabled===!0}),this.offlineService.isOnline$.subscribe(e=>{this.isOnline=e}),this.offlineService.queue$.subscribe(e=>{this.offlineQueueCount=e.length}),this.offlineService.isSyncing$.subscribe(e=>{this.isSyncing=e}),this.inventorySyncService.syncing$.subscribe(e=>{this.inventorySyncing=e}),this.inventorySyncService.lastSyncResult$.subscribe(e=>{this.inventorySyncResult=e}),this.partListSyncService.syncing$.subscribe(e=>{this.partListSyncing=e}),this.partListSyncService.lastSyncResult$.subscribe(e=>{this.partListSyncResult=e}),this.apiSyncService.syncing$.subscribe(e=>{this.apiSyncing=e}),this.apiSyncService.progress$.subscribe(e=>{this.apiProgress=e}),this.apiSyncService.lastSyncResult$.subscribe(e=>{this.apiSyncResult=e})),window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.deferredPrompt=e,this.canInstallPwa=!0}),window.addEventListener("online",()=>this.isOnline=!0),window.addEventListener("offline",()=>this.isOnline=!1)}ngOnDestroy(){this.subscriptions.forEach(e=>e.unsubscribe())}saveUserName(){this.settingsService.setUserName(this.userName)}saveTheme(){this.settingsService.setTheme(this.theme)}saveTagPrinting(){this.settingsService.setTagPrintingEnabled(this.tagPrintingEnabled)}onInventoryFileSelected(e){let l=e.target;l.files&&l.files.length>0&&(this.inventoryFile=l.files[0],this.inventorySyncResult=null)}syncInventory(){return R(this,null,function*(){this.inventoryFile&&(yield this.inventorySyncService.syncInventory(this.inventoryFile))})}onPartListFileSelected(e){let l=e.target;l.files&&l.files.length>0&&(this.partListFile=l.files[0],this.partListSyncResult=null)}syncPartList(){return R(this,null,function*(){this.partListFile&&(yield this.partListSyncService.syncPartList(this.partListFile))})}syncFromApi(){return R(this,null,function*(){this.isApiPasswordCorrect&&(yield this.apiSyncService.syncFromApi())})}exportBackup(){return R(this,null,function*(){this.exportingBackup=!0,this.backupExported=!1;try{yield this.excelService.exportFullBackupToExcel(),this.backupExported=!0,setTimeout(()=>this.backupExported=!1,5e3)}catch(e){console.error("Failed to export backup:",e)}finally{this.exportingBackup=!1}})}copySchema(){return R(this,null,function*(){try{yield navigator.clipboard.writeText(this.schemaSql),this.schemaCopied=!0,setTimeout(()=>this.schemaCopied=!1,2e3)}catch(e){console.error("Failed to copy schema:",e)}})}syncOfflineQueue(){return R(this,null,function*(){console.log("Sync offline queue triggered")})}installPwa(){return R(this,null,function*(){if(!this.deferredPrompt)return;this.deferredPrompt.prompt();let{outcome:e}=yield this.deferredPrompt.userChoice;e==="accepted"&&(this.canInstallPwa=!1),this.deferredPrompt=null})}static{this.\u0275fac=function(l){return new(l||r)(D(Se),D(ve),D(_e),D(xe),D(ye),D(ge))}}static{this.\u0275cmp=te({type:r,selectors:[["app-settings"]],standalone:!0,features:[se],decls:210,vars:41,consts:[["inventoryFileInput",""],["partListFileInput",""],[1,"page-header"],[1,"page-title"],[1,"page-subtitle"],[1,"row"],[1,"col-lg-6"],[1,"card","mb-4"],[1,"card-header"],[1,"fw-semibold"],[1,"bi","bi-person","me-2"],[1,"card-body"],[1,"mb-3"],[1,"form-label"],["type","text","placeholder","Enter your name",1,"form-control",3,"ngModelChange","blur","ngModel"],[1,"form-text"],[1,"bi","bi-palette","me-2"],[1,"form-select",3,"ngModelChange","change","ngModel"],["value","light"],["value","dark"],["value","system"],[1,"bi","bi-printer","me-2"],[1,"d-flex","align-items-center","justify-content-between","mb-3"],[1,"fw-medium"],[1,"form-check","form-switch"],["type","checkbox","role","switch",1,"form-check-input",3,"ngModelChange","change","ngModel"],[1,"small","text-muted"],[1,"fw-medium","text-body","mb-2"],[1,"ps-3","mb-2"],[1,"alert","alert-light","small","py-2","mb-0"],[1,"bi","bi-lightbulb","me-1"],[1,"bi","bi-wifi","me-2"],[1,"badge"],["class","btn btn-warning w-100 mb-3",3,"disabled","click",4,"ngIf"],[1,"d-flex","align-items-center","justify-content-between"],[1,"btn","btn-sm","btn-outline-primary",3,"click","disabled"],[1,"bi","bi-download","me-1"],["class","form-text",4,"ngIf"],[1,"card"],[1,"bi","bi-info-circle","me-2"],[1,"mb-2"],[1,"text-muted","small","mb-2"],[1,"text-muted","small","mb-3"],[1,"btn","btn-sm","btn-outline-secondary",3,"click"],[1,"bi","me-1"],["class","mt-3",4,"ngIf"],[1,"bi","bi-box-seam","me-2"],[1,"small","text-muted","mb-3"],["type","file","accept",".xlsx,.xls",1,"form-control",3,"change"],[1,"btn","btn-primary","w-100",3,"click","disabled"],[1,"bi","me-2"],[1,"bi","bi-list-check","me-2"],[1,"bi","bi-globe","me-2"],[1,"form-label","small"],[1,"bi","bi-lock","me-1"],[1,"d-flex","gap-2"],["type","password","placeholder","Enter sync password",1,"form-control",3,"ngModelChange","ngModel"],[1,"btn","btn-primary","flex-shrink-0",3,"click","disabled"],["class","mb-3",4,"ngIf"],[1,"small","text-muted","mt-3"],[1,"fw-medium","text-body","mb-1"],[1,"mb-1","ps-3"],[1,"small"],[1,"bi","bi-database","me-2"],[1,"btn","btn-outline-primary","w-100",3,"click","disabled"],["class","alert alert-success small mt-3 mb-0",4,"ngIf"],[1,"bi","bi-lightbulb","me-2"],[1,"small","text-muted","mb-0"],[1,"btn","btn-warning","w-100","mb-3",3,"click","disabled"],[1,"bi","bi-cloud-upload","me-2"],[1,"mt-3"],[1,"d-flex","justify-content-end","mb-2"],[1,"bg-body-secondary","p-3","rounded","small",2,"max-height","400px","overflow-y","auto","white-space","pre-wrap"],[1,"small","mb-2"],[1,"fw-semibold","mb-1"],["class","alert alert-danger small mb-2",4,"ngIf"],[4,"ngIf"],[1,"alert","alert-danger","small","mb-2"],[1,"mb-0","ps-3"],[4,"ngFor","ngForOf"],["type","button",1,"btn","btn-sm","btn-outline-secondary",3,"click"],["class","mt-2 p-2 bg-body-secondary rounded small","style","max-height: 150px; overflow-y: auto;",4,"ngIf"],[1,"mt-2","p-2","bg-body-secondary","rounded","small",2,"max-height","150px","overflow-y","auto"],[1,"d-flex","justify-content-between","small","mb-1"],[1,"text-muted"],[1,"progress"],["role","progressbar",1,"progress-bar"],["class","text-warning",4,"ngIf"],[1,"text-warning"],[1,"alert","alert-success","small","mt-3","mb-0"],[1,"bi","bi-check-circle","me-2"]],template:function(l,t){if(l&1){let a=$();n(0,"div")(1,"div",2)(2,"h1",3),s(3,"Settings"),i(),n(4,"p",4),s(5,"Configure your preferences and manage data"),i()(),n(6,"div",5)(7,"div",6)(8,"div",7)(9,"div",8)(10,"span",9),b(11,"i",10),s(12,"User Settings "),i()(),n(13,"div",11)(14,"div",12)(15,"label",13),s(16,"Your Name"),i(),n(17,"input",14),H("ngModelChange",function(d){return x(a),Y(t.userName,d)||(t.userName=d),w(d)}),k("blur",function(){return x(a),w(t.saveUserName())}),i(),n(18,"div",15),s(19,"This name will be recorded when you pick items"),i()()()(),n(20,"div",7)(21,"div",8)(22,"span",9),b(23,"i",16),s(24,"Appearance "),i()(),n(25,"div",11)(26,"div",12)(27,"label",13),s(28,"Theme"),i(),n(29,"select",17),H("ngModelChange",function(d){return x(a),Y(t.theme,d)||(t.theme=d),w(d)}),k("change",function(){return x(a),w(t.saveTheme())}),n(30,"option",18),s(31,"Light"),i(),n(32,"option",19),s(33,"Dark"),i(),n(34,"option",20),s(35,"System (auto)"),i()(),n(36,"div",15),s(37,"Choose your preferred color scheme"),i()()()(),n(38,"div",7)(39,"div",8)(40,"span",9),b(41,"i",21),s(42,"Tag Printing "),i()(),n(43,"div",11)(44,"div",22)(45,"div")(46,"div",23),s(47,"Enable Tag Printing"),i(),n(48,"div",15),s(49,"Show print dialog after picking parts"),i()(),n(50,"div",24)(51,"input",25),H("ngModelChange",function(d){return x(a),Y(t.tagPrintingEnabled,d)||(t.tagPrintingEnabled=d),w(d)}),k("change",function(){return x(a),w(t.saveTagPrinting())}),i()()(),n(52,"div",26)(53,"div",27),s(54,"Printer Setup:"),i(),n(55,"ul",28)(56,"li")(57,"strong"),s(58,"Printer:"),i(),s(59," Brother P-Touch QL500"),i(),n(60,"li")(61,"strong"),s(62,"Label Size:"),i(),s(63,' 0.66" x 3.4" (landscape)'),i(),n(64,"li"),s(65,"Each part/tool combination gets one tag"),i()(),n(66,"div",29),b(67,"i",30),s(68," Tip: Set the Brother QL500 as your default printer for faster printing. "),i()()()(),n(69,"div",7)(70,"div",8)(71,"span",9),b(72,"i",31),s(73,"App Status "),i()(),n(74,"div",11)(75,"div",22)(76,"span"),s(77,"Connection Status"),i(),n(78,"span"),b(79,"i"),s(80),i()(),n(81,"div",22)(82,"span"),s(83,"Offline Queue"),i(),n(84,"span",32),s(85),i()(),C(86,Le,3,4,"button",33),n(87,"div",34)(88,"span"),s(89,"Install as App"),i(),n(90,"button",35),k("click",function(){return x(a),w(t.installPwa())}),b(91,"i",36),s(92," Install "),i()(),C(93,Ae,2,0,"div",37),i()(),n(94,"div",38)(95,"div",8)(96,"span",9),b(97,"i",39),s(98,"About "),i()(),n(99,"div",11)(100,"p",40)(101,"strong"),s(102,"Tool Pick List Tracker v1.0.0"),i()(),n(103,"p",41),s(104," A comprehensive application for managing pick lists and tracking picking progress for sales orders. "),i(),n(105,"p",42),s(106," Built with Angular and Bootstrap. Data stored in Supabase. "),i(),n(107,"button",43),k("click",function(){return x(a),w(t.showSchema=!t.showSchema)}),b(108,"i",44),s(109),i(),C(110,Ne,7,4,"div",45),i()()(),n(111,"div",6)(112,"div",7)(113,"div",8)(114,"span",9),b(115,"i",46),s(116,"Inventory Sync "),i()(),n(117,"div",11)(118,"p",47),s(119," Upload an inventory Excel file to update stock quantities and locations. Expected columns: Product ID, Lot ID, Location, Qty Available. "),i(),n(120,"div",12)(121,"input",48,0),k("change",function(d){return x(a),w(t.onInventoryFileSelected(d))}),i()(),n(123,"button",49),k("click",function(){return x(a),w(t.syncInventory())}),b(124,"i",50),s(125),i(),C(126,Me,10,7,"div",45),i()(),n(127,"div",7)(128,"div",8)(129,"span",9),b(130,"i",51),s(131,"Part List Sync "),i()(),n(132,"div",11)(133,"p",47),s(134," Upload a Part List Excel file to update locations, descriptions, and quantities. Expected columns: Product ID, Location, Qty Available, Qty On Order, Description. "),i(),n(135,"div",12)(136,"input",48,1),k("change",function(d){return x(a),w(t.onPartListFileSelected(d))}),i()(),n(138,"button",49),k("click",function(){return x(a),w(t.syncPartList())}),b(139,"i",50),s(140),i(),C(141,Ue,9,6,"div",45),i()(),n(142,"div",7)(143,"div",8)(144,"span",9),b(145,"i",52),s(146,"API Sync "),i()(),n(147,"div",11)(148,"p",47),s(149," Sync qty available, qty on order, and descriptions directly from the Andrews Tool API. "),i(),n(150,"div",12)(151,"label",53),b(152,"i",54),s(153,"Password Required "),i(),n(154,"div",55)(155,"input",56),H("ngModelChange",function(d){return x(a),Y(t.apiPassword,d)||(t.apiPassword=d),w(d)}),i(),n(156,"button",57),k("click",function(){return x(a),w(t.syncFromApi())}),b(157,"i",44),s(158),i()()(),C(159,Be,8,5,"div",58)(160,He,9,7,"div",45),n(161,"div",59)(162,"div",60),s(163,"What gets updated:"),i(),n(164,"ul",61)(165,"li")(166,"strong"),s(167,"Qty Available"),i(),s(168," - Current stock on hand"),i(),n(169,"li")(170,"strong"),s(171,"Qty On Order"),i(),s(172," - Quantity on order"),i(),n(173,"li")(174,"strong"),s(175,"Description"),i(),s(176," - Part description"),i()(),n(177,"div",62),s(178," Pick counts, locations, and quantities needed are NOT affected. Parts are synced in batches of 30. "),i()()()(),n(179,"div",7)(180,"div",8)(181,"span",9),b(182,"i",63),s(183,"Data Backup "),i()(),n(184,"div",11)(185,"p",47),s(186," Export all application data to an Excel file for backup or migration purposes. Includes: Orders, Tools, Line Items, Picks, Issues, Parts Catalog, and BOM Templates. "),i(),n(187,"button",64),k("click",function(){return x(a),w(t.exportBackup())}),b(188,"i",50),s(189),i(),C(190,ze,3,0,"div",65),i()(),n(191,"div",38)(192,"div",8)(193,"span",9),b(194,"i",66),s(195,"Tips "),i()(),n(196,"div",11)(197,"ul",67)(198,"li",40),s(199,"Use the search bar to quickly find orders by SO#, PO#, or customer name"),i(),n(200,"li",40),s(201,"Click on any order to view details and start picking"),i(),n(202,"li",40),s(203,"The Dashboard shows orders that are due soon or overdue"),i(),n(204,"li",40),s(205,"Import Excel files to quickly create orders with their parts lists"),i(),n(206,"li",40),s(207,"Sync inventory regularly to keep stock quantities up to date"),i(),n(208,"li"),s(209,"Export backups periodically to prevent data loss"),i()()()()()()()}l&2&&(c(17),Q("ngModel",t.userName),c(12),Q("ngModel",t.theme),c(22),Q("ngModel",t.tagPrintingEnabled),c(27),F(t.isOnline?"badge bg-success":"badge bg-danger"),c(),F(t.isOnline?"bi bi-wifi me-1":"bi bi-wifi-off me-1"),c(),A(" ",t.isOnline?"Online":"Offline"," "),c(4),F(t.offlineQueueCount>0?"bg-warning text-dark":"bg-secondary"),c(),j(" ",t.offlineQueueCount," pending ",t.offlineQueueCount===1?"pick":"picks"," "),c(),h("ngIf",t.offlineQueueCount>0),c(4),h("disabled",!t.canInstallPwa),c(3),h("ngIf",!t.canInstallPwa),c(15),F(t.showSchema?"bi-chevron-up":"bi-code-square"),c(),A(" ",t.showSchema?"Hide":"Show"," Database Schema "),c(),h("ngIf",t.showSchema),c(13),h("disabled",!t.inventoryFile||t.inventorySyncing),c(),F(t.inventorySyncing?"bi-arrow-clockwise spin":"bi-cloud-upload"),c(),A(" ",t.inventorySyncing?"Syncing...":"Sync Inventory"," "),c(),h("ngIf",t.inventorySyncResult),c(12),h("disabled",!t.partListFile||t.partListSyncing),c(),F(t.partListSyncing?"bi-arrow-clockwise spin":"bi-cloud-upload"),c(),A(" ",t.partListSyncing?"Syncing...":"Sync Part List"," "),c(),h("ngIf",t.partListSyncResult),c(14),Q("ngModel",t.apiPassword),c(),h("disabled",!t.isApiPasswordCorrect||t.apiSyncing),c(),F(t.apiSyncing?"bi-arrow-clockwise spin":"bi-globe"),c(),A(" ",t.apiSyncing?"Syncing...":"Sync from API"," "),c(),h("ngIf",t.apiSyncing&&t.apiProgress),c(),h("ngIf",t.apiSyncResult&&!t.apiSyncing),c(27),h("disabled",t.exportingBackup),c(),F(t.exportingBackup?"bi-arrow-clockwise spin":"bi-download"),c(),A(" ",t.exportingBackup?"Exporting...":"Export Full Backup"," "),c(),h("ngIf",t.backupExported))},dependencies:[oe,re,ae,he,me,fe,ce,le,pe,de,ue],styles:[".spin[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_spin 1s linear infinite}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}"]})}}return r})();export{ct as SettingsComponent};
