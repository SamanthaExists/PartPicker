import{T as _,Y as p,g as d,ic as f}from"./chunk-2TFJQIGG.js";import{a as b,b as m,e as i}from"./chunk-DVOCWXDE.js";var y=(()=>{class l{constructor(r){this.supabase=r,this.ordersSubject=new d([]),this.loadingSubject=new d(!0),this.errorSubject=new d(null),this.subscription=null,this.orders$=this.ordersSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable(),this.fetchOrders(),this.setupRealtimeSubscription()}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}setupRealtimeSubscription(){this.subscription=this.supabase.channel("orders-changes").on("postgres_changes",{event:"*",schema:"public",table:"orders"},()=>this.fetchOrders()).on("postgres_changes",{event:"*",schema:"public",table:"picks"},()=>this.fetchOrders()).subscribe()}fetchOrders(){return i(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let{data:r,error:e}=yield this.supabase.from("orders").select(`
          *,
          tools (*),
          order_progress (total_items, picked_items, progress_percent)
        `).order("created_at",{ascending:!1});if(e)throw e;let t=(r||[]).map(a=>{let s=a.order_progress?.[0];return m(b({},a),{tools:a.tools||[],total_items:s?.total_items??0,picked_items:s?.picked_items??0,progress_percent:s?.progress_percent??0})});this.ordersSubject.next(t)}catch(r){this.errorSubject.next(r instanceof Error?r.message:"Failed to fetch orders")}finally{this.loadingSubject.next(!1)}})}createOrder(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabase.from("orders").insert({so_number:r.so_number,po_number:r.po_number||null,customer_name:r.customer_name||null,order_date:r.order_date||null,due_date:r.due_date||null,status:r.status||"active",notes:r.notes||null}).select().single();if(t)throw t;return e}catch(e){return this.errorSubject.next(e instanceof Error?e.message:"Failed to create order"),null}})}importOrder(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabase.from("orders").insert({so_number:r.so_number,po_number:r.po_number||null,customer_name:r.customer_name||null,order_date:r.order_date||null,due_date:r.due_date||null,estimated_ship_date:r.estimated_ship_date||null,status:"active"}).select().single();if(t)throw t;let a=[];if(r.tools.length>0){let s=r.tools.map(o=>({order_id:e.id,tool_number:o.tool_number,serial_number:o.serial_number||null,tool_model:o.tool_model||null,status:"pending"})),{data:n,error:u}=yield this.supabase.from("tools").insert(s).select("id, tool_number");if(u)throw u;a=n||[]}if(r.line_items.length>0){let s=new Map;for(let o of a)s.set(`temp-${o.tool_number}`,o.id);let n=r.line_items.map(o=>{let c=null;return o.tool_ids&&o.tool_ids.length>0&&(c=o.tool_ids.map(h=>s.get(h)).filter(h=>h!==void 0),c.length===0&&(c=null)),{order_id:e.id,part_number:o.part_number,description:o.description||null,location:o.location||null,qty_per_unit:o.qty_per_unit,total_qty_needed:o.total_qty_needed,tool_ids:c,assembly_group:o.assembly_group||null}}),{error:u}=yield this.supabase.from("line_items").insert(n);if(u)throw u}return yield this.fetchOrders(),e}catch(e){return this.errorSubject.next(e instanceof Error?e.message:"Failed to import order"),null}})}updateOrder(r,e){return i(this,null,function*(){try{let{error:t}=yield this.supabase.from("orders").update(m(b({},e),{updated_at:new Date().toISOString()})).eq("id",r);if(t)throw t;return!0}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to update order"),!1}})}deleteOrder(r){return i(this,null,function*(){try{let{error:e}=yield this.supabase.from("orders").delete().eq("id",r);if(e)throw e;return yield this.fetchOrders(),!0}catch(e){return this.errorSubject.next(e instanceof Error?e.message:"Failed to delete order"),!1}})}getOrder(r){return i(this,null,function*(){try{let[e,t,a]=yield Promise.all([this.supabase.from("orders").select("*").eq("id",r).single(),this.supabase.from("tools").select("*").eq("order_id",r).order("tool_number"),this.supabase.from("line_items").select("*").eq("order_id",r).order("part_number")]);if(e.error)throw e.error;if(t.error)throw t.error;if(a.error)throw a.error;return{order:e.data,tools:t.data||[],lineItems:a.data||[]}}catch(e){return this.errorSubject.next(e instanceof Error?e.message:"Failed to fetch order"),{order:null,tools:[],lineItems:[]}}})}addTool(r,e,t,a){return i(this,null,function*(){try{let{data:s,error:n}=yield this.supabase.from("tools").insert({order_id:r,tool_number:e,serial_number:t||null,tool_model:a||null,status:"pending"}).select().single();if(n)throw n;return s}catch(s){return this.errorSubject.next(s instanceof Error?s.message:"Failed to add tool"),null}})}deleteTool(r){return i(this,null,function*(){try{let{error:e}=yield this.supabase.from("tools").delete().eq("id",r);if(e)throw e;return!0}catch(e){return this.errorSubject.next(e instanceof Error?e.message:"Failed to delete tool"),!1}})}generateNextToolNumber(r,e){let t=e.map(s=>{let n=s.tool_number.match(/-(\d+)$/);return n?parseInt(n[1],10):0}).filter(s=>!isNaN(s)),a=t.length>0?Math.max(...t)+1:1;return`${r}-${a}`}static{this.\u0275fac=function(e){return new(e||l)(p(f))}}static{this.\u0275prov=_({token:l,factory:l.\u0275fac,providedIn:"root"})}}return l})();export{y as a};
