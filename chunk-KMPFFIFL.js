import{T as j,Y as x,g as _,ic as I}from"./chunk-2TFJQIGG.js";import{a as b,b as y,e as c}from"./chunk-DVOCWXDE.js";function w(h){return h.map(S=>`${S.part_number}:${S.qty_per_unit}`).sort().join("|")}var R=(()=>{class h{constructor(e){this.supabase=e,this.templatesSubject=new _([]),this.loadingSubject=new _(!0),this.errorSubject=new _(null),this.subscription=null,this.templates$=this.templatesSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable(),this.fetchTemplates(),this.setupRealtimeSubscription()}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}setupRealtimeSubscription(){this.subscription=this.supabase.channel("bom-templates-changes").on("postgres_changes",{event:"*",schema:"public",table:"bom_templates"},()=>this.fetchTemplates()).subscribe()}fetchAllRows(e,t){return c(this,null,function*(){let s=[],m=0,p=!0;for(;p;){let o=this.supabase.from(e).select("*");if(t)for(let[a,l]of Object.entries(t))o=o.eq(a,l);o=o.range(m*1e3,(m+1)*1e3-1);let{data:n,error:u}=yield o;if(u)throw u;n&&n.length>0?(s=s.concat(n),p=n.length===1e3,m++):p=!1}return s})}fetchTemplates(){return c(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let{data:e,error:t}=yield this.supabase.from("bom_templates").select("*").order("name");if(t)throw t;this.templatesSubject.next(e||[])}catch(e){this.errorSubject.next(e instanceof Error?e.message:"Failed to fetch BOM templates")}finally{this.loadingSubject.next(!1)}})}getTemplateWithItems(e){return c(this,null,function*(){try{let t=yield this.supabase.from("bom_templates").select("*").eq("id",e).single();if(t.error)throw t.error;let r=yield this.fetchAllRows("bom_template_items",{template_id:e});return y(b({},t.data),{items:r})}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to fetch template"),null}})}createTemplateFromOrder(e,t,r){return c(this,null,function*(){try{let{data:s,error:m}=yield this.supabase.from("bom_templates").insert({name:e,tool_model:t}).select().single();if(m)throw m;let p=r.map(n=>({template_id:s.id,part_number:n.part_number,description:n.description,location:n.location,qty_per_unit:n.qty_per_unit,assembly_group:n.assembly_group||null})),{error:o}=yield this.supabase.from("bom_template_items").insert(p);if(o)throw o;return yield this.fetchTemplates(),s}catch(s){return this.errorSubject.next(s instanceof Error?s.message:"Failed to create template"),null}})}createTemplate(e,t,r="bom"){return c(this,null,function*(){try{let{data:s,error:m}=yield this.supabase.from("bom_templates").insert({name:e,tool_model:t||null,template_type:r}).select().single();if(m)throw m;return yield this.fetchTemplates(),s}catch(s){return this.errorSubject.next(s instanceof Error?s.message:"Failed to create template"),null}})}updateTemplate(e,t){return c(this,null,function*(){try{let{error:r}=yield this.supabase.from("bom_templates").update(y(b({},t),{updated_at:new Date().toISOString()})).eq("id",e);if(r)throw r;return yield this.fetchTemplates(),!0}catch(r){return this.errorSubject.next(r instanceof Error?r.message:"Failed to update template"),!1}})}deleteTemplate(e){return c(this,null,function*(){try{let{error:t}=yield this.supabase.from("bom_templates").delete().eq("id",e);if(t)throw t;return yield this.fetchTemplates(),!0}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to delete template"),!1}})}addTemplateItem(e,t){return c(this,null,function*(){try{let{data:r,error:s}=yield this.supabase.from("bom_template_items").insert(b({template_id:e},t)).select().single();if(s)throw s;return r}catch(r){return this.errorSubject.next(r instanceof Error?r.message:"Failed to add template item"),null}})}updateTemplateItem(e,t){return c(this,null,function*(){try{let{error:r}=yield this.supabase.from("bom_template_items").update(t).eq("id",e);if(r)throw r;return!0}catch(r){return this.errorSubject.next(r instanceof Error?r.message:"Failed to update template item"),!1}})}deleteTemplateItem(e){return c(this,null,function*(){try{let{error:t}=yield this.supabase.from("bom_template_items").delete().eq("id",e);if(t)throw t;return!0}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to delete template item"),!1}})}extractTemplatesFromOrders(){return c(this,null,function*(){let e={created:0,skipped:0,errors:[]};try{let t=yield this.fetchAllRows("orders"),r=yield this.fetchAllRows("line_items"),s={};for(let a of r)s[a.order_id]||(s[a.order_id]=[]),s[a.order_id].push(a);let m=yield this.fetchAllRows("bom_templates"),p=yield this.fetchAllRows("bom_template_items"),o={};for(let a of p)o[a.template_id]||(o[a.template_id]=[]),o[a.template_id].push(a);let n=new Set;for(let a of m){let l=o[a.id]||[];n.add(w(l))}let u={};for(let a of t){let l=s[a.id];if(!l||l.length===0)continue;let f=w(l);u[f]||(u[f]={order:a,lineItems:l})}for(let[a,{order:l,lineItems:f}]of Object.entries(u)){if(n.has(a)){e.skipped++;continue}try{let i=l.tool_model?`${l.tool_model} BOM`:`SO-${l.so_number} BOM`,{data:g,error:E}=yield this.supabase.from("bom_templates").insert({name:i,tool_model:l.tool_model||null}).select().single();if(E)throw E;let O=f.map(d=>({template_id:g.id,part_number:d.part_number,description:d.description,location:d.location,qty_per_unit:d.qty_per_unit,assembly_group:d.assembly_group||null})),{error:T}=yield this.supabase.from("bom_template_items").insert(O);if(T)throw T;n.add(a),e.created++}catch(i){e.errors.push(`Failed to create template for SO-${l.so_number}: ${i instanceof Error?i.message:String(i)}`)}}yield this.fetchTemplates()}catch(t){e.errors.push(t instanceof Error?t.message:"Failed to extract templates")}return e})}autoExtractTemplate(e,t,r){return c(this,null,function*(){try{let s=w(e),m=yield this.fetchAllRows("bom_templates"),p=yield this.fetchAllRows("bom_template_items"),o={};for(let i of p)o[i.template_id]||(o[i.template_id]=[]),o[i.template_id].push(i);for(let i of m){let g=o[i.id]||[];if(w(g)===s)return{matched:!0}}let n=t?`${t} BOM`:`SO-${r} BOM`,{data:u,error:a}=yield this.supabase.from("bom_templates").insert({name:n,tool_model:t||null}).select().single();if(a)throw a;let l=e.map(i=>({template_id:u.id,part_number:i.part_number,description:i.description||null,location:i.location||null,qty_per_unit:i.qty_per_unit,assembly_group:i.assembly_group||null})),{error:f}=yield this.supabase.from("bom_template_items").insert(l);if(f)throw f;return yield this.fetchTemplates(),{matched:!1,templateId:u.id,templateName:n}}catch{return{matched:!0}}})}static{this.\u0275fac=function(t){return new(t||h)(x(I))}}static{this.\u0275prov=j({token:h,factory:h.\u0275fac,providedIn:"root"})}}return h})();export{R as a};
