import{a as I}from"./chunk-XHNAPF2T.js";import{a as _}from"./chunk-FQB7FWF7.js";import{T as g,Y as m,g as h,ic as j}from"./chunk-DEIGHZUX.js";import{a as l,b as d,i as a}from"./chunk-P2VZOJAX.js";var M=(()=>{class u{constructor(e,s,i){this.supabase=e,this.demoMode=s,this.demoData=i,this.issuesSubject=new h([]),this.loadingSubject=new h(!0),this.errorSubject=new h(null),this.subscription=null,this.currentOrderId=null,this.issues$=this.issuesSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable()}ngOnDestroy(){this.cleanup()}cleanup(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}loadIssuesForOrder(e){return a(this,null,function*(){this.cleanup(),this.currentOrderId=e,yield this.fetchIssues(e),this.demoMode.isDemoMode()||this.setupRealtimeSubscription(e)})}loadAllIssues(){return a(this,null,function*(){this.cleanup(),this.currentOrderId=null,yield this.fetchAllIssues(),this.demoMode.isDemoMode()||this.setupGlobalRealtimeSubscription()})}setupRealtimeSubscription(e){this.demoMode.isDemoMode()||(this.subscription=this.supabase.channel(`issues-${e}`).on("postgres_changes",{event:"*",schema:"public",table:"issues",filter:`order_id=eq.${e}`},()=>{this.currentOrderId&&this.fetchIssues(this.currentOrderId)}).subscribe())}setupGlobalRealtimeSubscription(){this.demoMode.isDemoMode()||(this.subscription=this.supabase.channel("all-issues").on("postgres_changes",{event:"*",schema:"public",table:"issues"},()=>{this.fetchAllIssues()}).subscribe())}fetchIssues(e){return a(this,null,function*(){try{if(this.loadingSubject.next(!0),this.errorSubject.next(null),this.demoMode.isDemoMode()){let r=this.demoData.getIssues(e).map(n=>{let b=this.demoData.getLineItems(e),f=this.demoData.getOrders(),p=b.find(S=>S.id===n.line_item_id),c=f.find(S=>S.id===n.order_id);return d(l({},n),{line_item:p,order:c})});this.issuesSubject.next(r),this.loadingSubject.next(!1);return}let{data:s,error:i}=yield this.supabase.from("issues").select(`
          *,
          line_items (*),
          orders (*)
        `).eq("order_id",e).order("created_at",{ascending:!1});if(i)throw i;let t=(s||[]).map(o=>d(l({},o),{line_item:o.line_items,order:o.orders}));this.issuesSubject.next(t)}catch(s){this.errorSubject.next(s instanceof Error?s.message:"Failed to fetch issues")}finally{this.loadingSubject.next(!1)}})}fetchAllIssues(){return a(this,null,function*(){try{if(this.loadingSubject.next(!0),this.errorSubject.next(null),this.demoMode.isDemoMode()){let o=this.demoData.getIssues().map(r=>{let n=this.demoData.getLineItems(),b=this.demoData.getOrders(),f=n.find(c=>c.id===r.line_item_id),p=b.find(c=>c.id===r.order_id);return d(l({},r),{line_item:f,order:p})});this.issuesSubject.next(o),this.loadingSubject.next(!1);return}let{data:e,error:s}=yield this.supabase.from("issues").select(`
          *,
          line_items (*),
          orders (*)
        `).order("created_at",{ascending:!1});if(s)throw s;let i=(e||[]).map(t=>d(l({},t),{line_item:t.line_items,order:t.orders}));this.issuesSubject.next(i)}catch(e){this.errorSubject.next(e instanceof Error?e.message:"Failed to fetch issues")}finally{this.loadingSubject.next(!1)}})}reportIssue(e,s,i,t,o){return a(this,null,function*(){try{let{data:r,error:n}=yield this.supabase.from("issues").insert({line_item_id:e,order_id:s,issue_type:i,description:t||null,reported_by:o||null,status:"open"}).select().single();if(n)throw n;return r}catch(r){return this.errorSubject.next(r instanceof Error?r.message:"Failed to report issue"),null}})}resolveIssue(e,s,i){return a(this,null,function*(){try{let{error:t}=yield this.supabase.from("issues").update({status:"resolved",resolved_at:new Date().toISOString(),resolved_by:s||null,resolution_notes:i||null}).eq("id",e);if(t)throw t;return!0}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to resolve issue"),!1}})}reopenIssue(e){return a(this,null,function*(){try{let{error:s}=yield this.supabase.from("issues").update({status:"open",resolved_at:null,resolved_by:null}).eq("id",e);if(s)throw s;return!0}catch(s){return this.errorSubject.next(s instanceof Error?s.message:"Failed to reopen issue"),!1}})}hasOpenIssue(e){return this.issuesSubject.getValue().some(i=>i.line_item_id===e&&i.status==="open")}static{this.\u0275fac=function(s){return new(s||u)(m(j),m(_),m(I))}}static{this.\u0275prov=g({token:u,factory:u.\u0275fac,providedIn:"root"})}}return u})();export{M as a};
