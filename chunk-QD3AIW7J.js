import{a as pe}from"./chunk-YHPIB4V5.js";import{a as le}from"./chunk-AZ5JV5M2.js";import{f as ie,i as ne}from"./chunk-UUC3DEYY.js";import{a as re,b as ae,c as oe,f as se,n as de}from"./chunk-LKIX2EBI.js";import{$a as b,$b as X,Ca as n,Cb as F,Da as Q,Db as j,Sa as h,Ua as m,Wa as B,Xa as U,Za as a,_a as r,ab as O,ac as J,bb as A,ca as G,cb as I,cc as ee,db as P,dc as te,eb as _,ic as ce,ka as w,la as S,mb as c,nb as y,ob as g,pb as Y,rb as D,sb as E,tb as T,vb as Z,xb as K}from"./chunk-DEIGHZUX.js";import"./chunk-SZXJF6TW.js";import{i as N}from"./chunk-P2VZOJAX.js";var fe=i=>["/orders",i];function xe(i,u){if(i&1){let e=I();a(0,"button",38),P("click",function(){let o=w(e).$implicit,l=_();return S(l.applyPreset(o))}),c(1),r()}if(i&2){let e=u.$implicit;n(),g(" ",e.label," ")}}function ve(i,u){if(i&1){let e=I();a(0,"button",39),P("click",function(){w(e);let o=_();return S(o.exportToExcel())}),b(1,"i",40),c(2),r()}if(i&2){let e=_();m("disabled",e.exporting),n(),B("spin",e.exporting),n(),g(" ",e.exporting?"Exporting...":"Export Picks to Excel"," ")}}function Ce(i,u){if(i&1&&(a(0,"div",41),b(1,"i",42),a(2,"div")(3,"strong"),c(4,"Error loading data"),r(),a(5,"p",43),c(6),r()()()),i&2){let e=_();n(6),y(e.error)}}function ke(i,u){if(i&1){let e=I();a(0,"button",60),P("click",function(){w(e);let o=_(2);return S(o.searchQuery="")}),b(1,"i",61),r()}}function we(i,u){i&1&&(a(0,"div",62),b(1,"i",63),r())}function Se(i,u){if(i&1&&(a(0,"div",64),c(1),r()),i&2){let e=_(2);n(),g(" ",e.searchQuery?"No activities match your search":"No activities found in this date range"," ")}}function Pe(i,u){if(i&1&&(a(0,"span",92),c(1),r()),i&2){let e=_().$implicit;n(),g(" ",e.qty_picked,"x ")}}function Ie(i,u){if(i&1&&(a(0,"span",93),c(1),r()),i&2){let e=_().$implicit;n(),g(" ",e.qty_picked,"x ")}}function De(i,u){i&1&&(a(0,"span",94),c(1," Deleted "),r())}function Ee(i,u){if(i&1&&(a(0,"span",95),c(1),r()),i&2){let e=_().$implicit;n(),g(" ",e.qty_picked,"x ")}}function Te(i,u){if(i&1&&(a(0,"span",96),c(1),r()),i&2){let e=_().$implicit;n(),g(" ",e.tool_number," ")}}function Me(i,u){if(i&1&&(a(0,"span",96),c(1),r()),i&2){let e=_().$implicit;n(),g(" ",e.tool_number," ")}}function He(i,u){if(i&1&&(a(0,"span",57),c(1),r()),i&2){let e=_(2).$implicit;n(),g(" - ",e.description,"")}}function Le(i,u){if(i&1&&(a(0,"span",102),c(1),r()),i&2){let e=_(2).$implicit;n(),g(" - deleted by ",e.undone_by||"Unknown","")}}function Ue(i,u){if(i&1){let e=I();O(0),a(1,"span",97),c(2),r(),a(3,"button",98),P("click",function(o){w(e);let l=_().$implicit,p=_(4);return S(p.copyPartNumber(l.part_number,o))}),b(4,"i",99),r(),h(5,He,2,1,"span",100)(6,Le,2,1,"span",101),A()}if(i&2){let e=_().$implicit,t=_(4);n(),B("text-decoration-line-through",e.undone_at)("text-muted",e.undone_at),n(),y(e.part_number),n(2),U(t.copiedPartNumber===e.part_number?"bi-check-lg text-success":"bi-copy"),n(),m("ngIf",e.description&&!e.undone_at),n(),m("ngIf",e.undone_at)}}function Oe(i,u){if(i&1){let e=I();O(0),a(1,"span",103),c(2),r(),a(3,"button",98),P("click",function(o){w(e);let l=_().$implicit,p=_(4);return S(p.copyPartNumber(l.part_number,o))}),b(4,"i",99),r(),a(5,"span",57),c(6),r(),A()}if(i&2){let e=_().$implicit,t=_(4);n(2),y(e.part_number),n(2),U(t.copiedPartNumber===e.part_number?"bi-check-lg text-success":"bi-copy"),n(2),g(" - originally picked by ",e.picked_by||"Unknown","")}}function Ae(i,u){if(i&1){let e=I();a(0,"button",98),P("click",function(o){w(e);let l=_(2).$implicit,p=_(4);return S(p.copyPartNumber(l.part_number,o))}),b(1,"i",99),r()}if(i&2){let e=_(2).$implicit,t=_(4);n(),U(t.copiedPartNumber===e.part_number?"bi-check-lg text-success":"bi-copy")}}function Ve(i,u){if(i&1&&(O(0),a(1,"span",97),c(2),r(),h(3,Ae,2,2,"button",104),A()),i&2){let e=_().$implicit;n(2),y(e.part_number),n(),m("ngIf",e.part_number)}}function qe(i,u){if(i&1&&(a(0,"span",57),c(1),r()),i&2){let e=_(2).$implicit;n(),y(e.description)}}function We(i,u){if(i&1&&(O(0),h(1,qe,2,1,"span",100),A()),i&2){let e=_().$implicit;n(),m("ngIf",e.description)}}function $e(i,u){if(i&1){let e=I();O(0),a(1,"span",97),c(2),r(),a(3,"button",98),P("click",function(o){w(e);let l=_().$implicit,p=_(4);return S(p.copyPartNumber(l.part_number,o))}),b(4,"i",99),r(),a(5,"span",57),c(6),r(),A()}if(i&2){let e=_().$implicit,t=_(4);n(2),y(e.part_number),n(2),U(t.copiedPartNumber===e.part_number?"bi-check-lg text-success":"bi-copy"),n(2),g(" - ",e.issue_type.replace("_"," "),"")}}function Ne(i,u){if(i&1&&(a(0,"p",105),c(1),r()),i&2){let e=_().$implicit;n(),g(" Location: ",e.location," ")}}function Qe(i,u){if(i&1&&(a(0,"p",106),c(1),r()),i&2){let e=_().$implicit;n(),g(" Note: ",e.notes," ")}}function Be(i,u){if(i&1&&(a(0,"p",106),c(1),r()),i&2){let e=_().$implicit;n(),g(" ",e.description," ")}}function Fe(i,u){if(i&1&&(a(0,"p",106),c(1),r()),i&2){let e=_().$implicit;n(),g(" ",e.description," ")}}function je(i,u){if(i&1&&(a(0,"div",76)(1,"div",77),b(2,"i"),r(),a(3,"div",78)(4,"div",79)(5,"span",80),b(6,"i",81),c(7),r(),a(8,"span"),c(9),r(),h(10,Pe,2,1,"span",82)(11,Ie,2,1,"span",83)(12,De,2,0,"span",84)(13,Ee,2,1,"span",85),a(14,"a",86),c(15),r(),h(16,Te,2,1,"span",87)(17,Me,2,1,"span",87),r(),a(18,"p",88),h(19,Ue,7,9,"ng-container",37)(20,Oe,7,4,"ng-container",37)(21,Ve,4,2,"ng-container",37)(22,We,2,1,"ng-container",37)(23,$e,7,4,"ng-container",37),r(),h(24,Ne,2,1,"p",89)(25,Qe,2,1,"p",90)(26,Be,2,1,"p",90)(27,Fe,2,1,"p",90),r(),a(28,"div",91),c(29),r()()),i&2){let e=u.$implicit,t=_(4);n(2),U(t.getActivityIconClassForRecord(e)),n(5),g(" ",t.getActivityUser(e)," "),n(),U(t.getActivityBadgeClass(e.type)),n(),g(" ",t.getActivityBadgeText(e.type)," "),n(),m("ngIf",e.type==="pick"&&!e.undone_at),n(),m("ngIf",e.type==="pick"&&e.undone_at),n(),m("ngIf",e.type==="pick"&&e.undone_at),n(),m("ngIf",e.type==="undo"),n(),m("routerLink",K(24,fe,e.order_id)),n(),g(" SO-",e.so_number," "),n(),m("ngIf",e.type==="pick"),n(),m("ngIf",e.type==="undo"),n(2),m("ngIf",e.type==="pick"),n(),m("ngIf",e.type==="undo"),n(),m("ngIf",e.type==="part_added"||e.type==="part_removed"),n(),m("ngIf",e.type==="order_imported"),n(),m("ngIf",e.type==="issue_created"||e.type==="issue_resolved"),n(),m("ngIf",e.type==="pick"&&e.location),n(),m("ngIf",e.type==="pick"&&e.notes),n(),m("ngIf",(e.type==="issue_created"||e.type==="issue_resolved")&&e.description),n(),m("ngIf",(e.type==="part_added"||e.type==="part_removed")&&e.description),n(2),g(" ",t.formatTime(t.getActivityTimestamp(e))," ")}}function ze(i,u){if(i&1&&(a(0,"div",71)(1,"h6",72)(2,"span"),c(3),r(),a(4,"span",73),c(5),r()(),a(6,"div",74),h(7,je,30,26,"div",75),r()()),i&2){let e=u.$implicit,t=_(3);n(3),y(t.formatDateHeader(e)),n(2),g("",t.groupedActivities[e].length," records"),n(2),m("ngForOf",t.groupedActivities[e])}}function Re(i,u){if(i&1){let e=I();a(0,"div"),h(1,ze,8,3,"div",65),a(2,"div",66)(3,"button",67),P("click",function(){w(e);let o=_(2);return S(o.prevPage())}),b(4,"i",68),c(5," Previous "),r(),a(6,"span",69),c(7),r(),a(8,"button",67),P("click",function(){w(e);let o=_(2);return S(o.nextPage())}),c(9," Next "),b(10,"i",70),r()()()}if(i&2){let e=_(2);n(),m("ngForOf",e.groupedDates),n(2),m("disabled",e.page===0||e.loading),n(4),Y(" Page ",e.page+1," of ",e.totalPages," "),n(),m("disabled",!e.hasMore||e.loading)}}function Ge(i,u){if(i&1){let e=I();O(0),a(1,"div",44)(2,"div",45)(3,"div",46)(4,"div",47)(5,"div",48),c(6),F(7,"number"),r(),a(8,"div",49),c(9,"Picks"),r()()()(),a(10,"div",45)(11,"div",46)(12,"div",47)(13,"div",48),c(14),F(15,"number"),r(),a(16,"div",49),c(17,"Qty Picked"),r()()()(),a(18,"div",45)(19,"div",46)(20,"div",47)(21,"div",48),c(22),r(),a(23,"div",49),c(24,"Unique Parts"),r()()()(),a(25,"div",45)(26,"div",46)(27,"div",47)(28,"div",48),c(29),r(),a(30,"div",49),c(31,"Users"),r()()()(),a(32,"div",45)(33,"div",46)(34,"div",47)(35,"div",48),c(36),r(),a(37,"div",49),c(38,"Issues"),r()()()(),a(39,"div",45)(40,"div",46)(41,"div",47)(42,"div",50),c(43),r(),a(44,"div",49),c(45,"Undos"),r()()()(),a(46,"div",45)(47,"div",46)(48,"div",47)(49,"div",48),c(50),r(),a(51,"div",49),c(52,"Part Changes"),r()()()(),a(53,"div",45)(54,"div",46)(55,"div",47)(56,"div",51),c(57),r(),a(58,"div",49),c(59,"Imports"),r()()()()(),a(60,"div",5)(61,"div",9)(62,"div",52),b(63,"i",53),a(64,"input",54),T("ngModelChange",function(o){w(e);let l=_();return E(l.searchQuery,o)||(l.searchQuery=o),S(o)}),r(),h(65,ke,2,0,"button",55),r()()(),a(66,"div",5)(67,"div",6)(68,"h5",7),b(69,"i",56),c(70," Activity Records "),r(),a(71,"small",57),c(72),F(73,"number"),r()(),a(74,"div",9),h(75,we,2,0,"div",58)(76,Se,2,1,"div",59)(77,Re,11,5,"div",37),r()(),A()}if(i&2){let e=_();n(6),y(j(7,14,e.summaryStats.pickCount)),n(8),y(j(15,16,e.summaryStats.totalQty)),n(8),y(e.summaryStats.uniqueParts),n(7),y(e.summaryStats.uniqueUsers),n(7),y(e.summaryStats.issueCount),n(7),y(e.summaryStats.undoCount),n(7),y(e.summaryStats.partChangesCount),n(7),y(e.summaryStats.importsCount),n(7),D("ngModel",e.searchQuery),n(),m("ngIf",e.searchQuery),n(7),g(" ",j(73,18,e.filteredActivities.length)," records found "),n(3),m("ngIf",e.loading),n(),m("ngIf",!e.loading&&e.filteredActivities.length===0),n(),m("ngIf",!e.loading&&e.filteredActivities.length>0)}}var W=50,ot=(()=>{class i{constructor(e,t,o){this.supabase=e,this.excelService=t,this.utils=o,this.picks=[],this.issues=[],this.undos=[],this.activityLogs=[],this.loading=!1,this.searchQuery="",this.page=0,this.hasMore=!0,this.totalPickCount=0,this.totalQtyPicked=0,this.allUniqueParts=0,this.allUniqueUsers=0,this.activePickCount=0,this.totalDeletedPickCount=0,this.totalIssueCount=0,this.totalUndoCount=0,this.totalPartChangesCount=0,this.totalImportsCount=0,this.hasSearched=!1,this.exporting=!1,this.error=null,this.showPicks=!0,this.showIssues=!0,this.showUndos=!0,this.showPartChanges=!0,this.showImports=!0,this.startDate="",this.endDate="",this.copiedPartNumber=null,this.datePresets=[{label:"Today",getValue:()=>({start:this.startOfDay(new Date),end:this.endOfDay(new Date)})},{label:"Yesterday",getValue:()=>{let l=new Date;return l.setDate(l.getDate()-1),{start:this.startOfDay(l),end:this.endOfDay(l)}}},{label:"This Week",getValue:()=>({start:this.startOfWeek(new Date),end:this.endOfWeek(new Date)})},{label:"Last 7 Days",getValue:()=>{let l=new Date;return l.setDate(l.getDate()-6),{start:this.startOfDay(l),end:this.endOfDay(new Date)}}},{label:"This Month",getValue:()=>({start:this.startOfMonth(new Date),end:this.endOfMonth(new Date)})},{label:"Last 30 Days",getValue:()=>{let l=new Date;return l.setDate(l.getDate()-29),{start:this.startOfDay(l),end:this.endOfDay(new Date)}}}]}ngOnInit(){let e=new Date;this.startDate=this.formatDateTimeLocal(this.startOfDay(e)),this.endDate=this.formatDateTimeLocal(this.endOfDay(e)),this.fetchData()}get allActivities(){let e=[];return this.showPicks&&e.push(...this.picks),this.showIssues&&this.page===0&&e.push(...this.issues),this.showUndos&&this.page===0&&e.push(...this.undos),this.page===0&&(this.showPartChanges&&e.push(...this.activityLogs.filter(t=>t.type==="part_added"||t.type==="part_removed")),this.showImports&&e.push(...this.activityLogs.filter(t=>t.type==="order_imported"))),e.sort((t,o)=>{let l=this.getActivityTimestamp(t),p=this.getActivityTimestamp(o);return new Date(p).getTime()-new Date(l).getTime()}),e}get filteredActivities(){if(!this.searchQuery)return this.allActivities;let e=this.searchQuery.toLowerCase();return this.allActivities.filter(t=>t.type==="pick"?t.picked_by&&t.picked_by.toLowerCase().includes(e)||t.part_number.toLowerCase().includes(e)||t.so_number.toLowerCase().includes(e)||t.tool_number.toLowerCase().includes(e)||t.description&&t.description.toLowerCase().includes(e)||t.location&&t.location.toLowerCase().includes(e):t.type==="undo"?t.undone_by.toLowerCase().includes(e)||t.picked_by&&t.picked_by.toLowerCase().includes(e)||t.part_number.toLowerCase().includes(e)||t.so_number.toLowerCase().includes(e)||t.tool_number.toLowerCase().includes(e):t.type==="part_added"||t.type==="part_removed"||t.type==="order_imported"?t.performed_by&&t.performed_by.toLowerCase().includes(e)||t.part_number&&t.part_number.toLowerCase().includes(e)||t.so_number.toLowerCase().includes(e)||t.description&&t.description.toLowerCase().includes(e):t.type==="issue_created"||t.type==="issue_resolved"?t.user&&t.user.toLowerCase().includes(e)||t.part_number.toLowerCase().includes(e)||t.so_number.toLowerCase().includes(e)||t.issue_type.toLowerCase().includes(e)||t.description&&t.description.toLowerCase().includes(e):!1)}get groupedActivities(){let e={};for(let t of this.filteredActivities){let o=this.getActivityTimestamp(t),l=new Date(o),p=l.getFullYear(),v=String(l.getMonth()+1).padStart(2,"0"),C=String(l.getDate()).padStart(2,"0"),f=`${p}-${v}-${C}`;e[f]||(e[f]=[]),e[f].push(t)}return e}get groupedDates(){return Object.keys(this.groupedActivities).sort((e,t)=>t.localeCompare(e))}get summaryStats(){if(!this.searchQuery)return{totalQty:this.totalQtyPicked,uniqueParts:this.allUniqueParts,uniqueUsers:this.allUniqueUsers,pickCount:this.activePickCount,issueCount:this.totalIssueCount,undoCount:this.totalUndoCount,partChangesCount:this.totalPartChangesCount,importsCount:this.totalImportsCount,deletedPickCount:this.totalDeletedPickCount};let e=this.filteredActivities.filter(d=>d.type==="pick"),t=e.filter(d=>!d.undone_at),o=e.filter(d=>d.undone_at),l=this.filteredActivities.filter(d=>d.type==="issue_created"||d.type==="issue_resolved"),p=this.filteredActivities.filter(d=>d.type==="undo"),v=this.filteredActivities.filter(d=>d.type==="part_added"||d.type==="part_removed"||d.type==="order_imported"),C=t.reduce((d,x)=>d+x.qty_picked,0),f=new Set(t.map(d=>d.part_number)).size,M=new Set([...t.filter(d=>d.picked_by).map(d=>d.picked_by),...l.filter(d=>d.user).map(d=>d.user),...p.map(d=>d.undone_by),...v.filter(d=>d.performed_by).map(d=>d.performed_by)]).size,H=p.length+o.length,V=v.filter(d=>d.type==="part_added"||d.type==="part_removed").length,L=v.filter(d=>d.type==="order_imported").length;return{totalQty:C,uniqueParts:f,uniqueUsers:M,pickCount:t.length,issueCount:l.length,undoCount:H,partChangesCount:V,importsCount:L,deletedPickCount:o.length}}get totalPages(){return Math.ceil(this.totalPickCount/W)||1}applyPreset(e){let{start:t,end:o}=e.getValue();this.startDate=this.formatDateTimeLocal(t),this.endDate=this.formatDateTimeLocal(o),this.page=0,this.fetchData()}onSearch(){this.page=0,this.fetchData()}copyPartNumber(e,t){return N(this,null,function*(){t.stopPropagation(),(yield this.utils.copyToClipboard(e))&&(this.copiedPartNumber=e,setTimeout(()=>{this.copiedPartNumber===e&&(this.copiedPartNumber=null)},2e3))})}fetchData(){return N(this,null,function*(){try{this.loading=!0,this.hasSearched=!0,this.error=null;let e=[],t=new Date(this.startDate).toISOString(),o=new Date(this.endDate).toISOString(),{data:l,error:p,count:v}=yield this.supabase.from("picks").select(`
          id,
          qty_picked,
          picked_by,
          picked_at,
          notes,
          undone_at,
          undone_by,
          line_items!inner (
            part_number,
            description,
            location,
            order_id,
            orders!inner (
              so_number
            )
          ),
          tools!inner (
            tool_number
          )
        `,{count:"exact"}).gte("picked_at",t).lte("picked_at",o).order("picked_at",{ascending:!1}).range(this.page*W,(this.page+1)*W-1);p&&(console.error("Error fetching picks:",p),e.push(`Picks: ${p.message}`)),this.picks=(l||[]).map(s=>({id:s.id,type:"pick",qty_picked:s.qty_picked,picked_by:s.picked_by,picked_at:s.picked_at,notes:s.notes,part_number:s.line_items.part_number,description:s.line_items.description,location:s.line_items.location,tool_number:s.tools.tool_number,so_number:s.line_items.orders.so_number,order_id:s.line_items.order_id,undone_at:s.undone_at,undone_by:s.undone_by})),this.totalPickCount=v||0,this.hasMore=(l?.length||0)===W,this.hasMore=(l?.length||0)===W;let C=1e3,f=[],M=0,H=!0;for(;H;){let{data:s}=yield this.supabase.from("picks").select(`
            qty_picked,
            picked_by,
            undone_at,
            undone_by,
            line_items!inner (
              part_number
            )
          `).gte("picked_at",t).lte("picked_at",o).range(M*C,(M+1)*C-1);s&&s.length>0?(f=f.concat(s),H=s.length===C,M++):H=!1}if(f.length>0){let s=f.filter(k=>!k.undone_at),q=f.filter(k=>k.undone_at);this.activePickCount=s.length,this.totalDeletedPickCount=q.length,this.totalQtyPicked=s.reduce((k,he)=>k+(he.qty_picked||0),0),this.allUniqueParts=new Set(s.map(k=>k.line_items?.part_number).filter(Boolean)).size;let $=new Set(s.map(k=>k.picked_by).filter(Boolean)),be=new Set(q.map(k=>k.undone_by).filter(Boolean)),ye=new Set([...$,...be]);this.allUniqueUsers=ye.size}else this.activePickCount=0,this.totalDeletedPickCount=0,this.totalQtyPicked=0,this.allUniqueParts=0,this.allUniqueUsers=0;let{data:V,error:L}=yield this.supabase.from("issues").select(`
          id,
          issue_type,
          description,
          reported_by,
          status,
          created_at,
          resolved_at,
          resolved_by,
          line_items!inner (
            part_number,
            order_id,
            orders!inner (
              so_number
            )
          )
        `);L&&(console.error("Error fetching issues:",L),e.push(`Issues: ${L.message}`));let d=[],x=new Set;for(let s of V||[]){let q=new Date(s.created_at);if(q>=new Date(this.startDate)&&q<=new Date(this.endDate)&&(d.push({id:`issue-created-${s.id}`,type:"issue_created",issue_type:s.issue_type,description:s.description,user:s.reported_by,timestamp:s.created_at,part_number:s.line_items.part_number,so_number:s.line_items.orders.so_number,order_id:s.line_items.order_id}),s.reported_by&&x.add(s.reported_by)),s.status==="resolved"&&s.resolved_at){let $=new Date(s.resolved_at);$>=new Date(this.startDate)&&$<=new Date(this.endDate)&&(d.push({id:`issue-resolved-${s.id}`,type:"issue_resolved",issue_type:s.issue_type,description:s.description,user:s.resolved_by,timestamp:s.resolved_at,part_number:s.line_items.part_number,so_number:s.line_items.orders.so_number,order_id:s.line_items.order_id}),s.resolved_by&&x.add(s.resolved_by))}}this.issues=d,this.totalIssueCount=d.length;let{data:_e,error:z}=yield this.supabase.from("pick_undos").select("*").gte("undone_at",t).lte("undone_at",o).order("undone_at",{ascending:!1});z&&(console.error("Error fetching undos:",z),e.push(`Undos: ${z.message}`));let me=new Set;this.undos=(_e||[]).map(s=>(s.undone_by&&me.add(s.undone_by),{id:s.id,type:"undo",qty_picked:s.qty_picked,picked_by:s.picked_by,undone_by:s.undone_by,undone_at:s.undone_at,picked_at:s.picked_at,part_number:s.part_number,tool_number:s.tool_number,so_number:s.so_number,order_id:s.order_id})),this.totalUndoCount=this.undos.length+this.totalDeletedPickCount;let{data:ue,error:R}=yield this.supabase.from("activity_log").select("*").gte("created_at",t).lte("created_at",o).order("created_at",{ascending:!1});R&&(console.error("Error fetching activity logs:",R),e.push(`Activity Log: ${R.message}`));let ge=new Set;this.activityLogs=(ue||[]).map(s=>(s.performed_by&&ge.add(s.performed_by),{id:s.id,type:s.type,so_number:s.so_number,part_number:s.part_number,description:s.description,performed_by:s.performed_by,details:s.details,created_at:s.created_at,order_id:s.order_id})),this.totalPartChangesCount=this.activityLogs.filter(s=>s.type==="part_added"||s.type==="part_removed").length,this.totalImportsCount=this.activityLogs.filter(s=>s.type==="order_imported").length;let Ye=this.allUniqueUsers;e.length>0&&(this.error=e.join(" | "))}catch(e){console.error("Error fetching data:",e),this.error=e instanceof Error?e.message:"An unexpected error occurred while fetching data",this.picks=[],this.issues=[],this.undos=[],this.activityLogs=[]}finally{this.loading=!1}})}prevPage(){this.page>0&&(this.page--,this.fetchData())}nextPage(){this.hasMore&&(this.page++,this.fetchData())}exportToExcel(){return N(this,null,function*(){try{this.exporting=!0;let e=new Date(this.startDate).toISOString(),t=new Date(this.endDate).toISOString(),o=1e3,l=[],p=0,v=!0;for(;v;){let{data:d,error:x}=yield this.supabase.from("picks").select(`
            id,
            qty_picked,
            picked_by,
            picked_at,
            notes,
            undone_at,
            undone_by,
            line_items!inner (
              part_number,
              orders!inner (
                so_number
              )
            ),
            tools!inner (
              tool_number
            )
          `).gte("picked_at",e).lte("picked_at",t).order("picked_at",{ascending:!1}).range(p,p+o-1);if(x){console.error("Error fetching picks for export:",x);return}l=[...l,...d||[]],v=(d?.length||0)===o,p+=o}let C=l;if(this.searchQuery){let d=this.searchQuery.toLowerCase();C=C.filter(x=>x.picked_by&&x.picked_by.toLowerCase().includes(d)||x.line_items.part_number.toLowerCase().includes(d)||x.line_items.orders.so_number.toLowerCase().includes(d)||x.tools.tool_number.toLowerCase().includes(d))}let f=C.map(d=>({picked_at:d.picked_at,picked_by:d.picked_by,qty_picked:d.qty_picked,notes:d.notes,part_number:d.line_items.part_number,tool_number:d.tools.tool_number,so_number:d.line_items.orders.so_number,status:d.undone_at?"Deleted":"Active",undone_at:d.undone_at||"",undone_by:d.undone_by||""})),{data:M}=yield this.supabase.from("pick_undos").select("*").gte("undone_at",e).lte("undone_at",t).order("undone_at",{ascending:!1}),H=(M||[]).map(d=>({undone_at:d.undone_at,undone_by:d.undone_by,picked_at:d.picked_at,picked_by:d.picked_by,qty_picked:d.qty_picked,part_number:d.part_number,tool_number:d.tool_number,so_number:d.so_number})),{data:V}=yield this.supabase.from("activity_log").select("*").gte("created_at",e).lte("created_at",t).order("created_at",{ascending:!1}),L=(V||[]).map(d=>({created_at:d.created_at,type:d.type,performed_by:d.performed_by,so_number:d.so_number,part_number:d.part_number,description:d.description}));yield this.excelService.exportPickHistoryToExcel(f,this.startDate,this.endDate,H,L)}catch(e){console.error("Export failed:",e)}finally{this.exporting=!1}})}formatDateHeader(e){let[t,o,l]=e.split("-").map(Number);return new Date(t,o-1,l).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}formatTime(e){return new Date(e).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}getActivityUser(e){return e.type==="pick"?e.picked_by||"Unknown":e.type==="undo"?e.undone_by||"Unknown":e.type==="part_added"||e.type==="part_removed"||e.type==="order_imported"?e.performed_by||"Unknown":(e.type==="issue_created"||e.type==="issue_resolved")&&e.user||"Unknown"}getActivityTimestamp(e){return e.type==="pick"?e.picked_at:e.type==="undo"?e.undone_at:e.type==="part_added"||e.type==="part_removed"||e.type==="order_imported"?e.created_at:e.type==="issue_created"||e.type==="issue_resolved"?e.timestamp:""}getActivityIconClass(e){switch(e){case"pick":return"bi bi-check-circle-fill text-success";case"undo":return"bi bi-arrow-counterclockwise text-danger";case"issue_created":return"bi bi-exclamation-triangle-fill text-warning";case"issue_resolved":return"bi bi-check-circle-fill text-primary";case"part_added":return"bi bi-plus-circle-fill text-success";case"part_removed":return"bi bi-dash-circle-fill text-danger";case"order_imported":return"bi bi-upload text-primary";default:return"bi bi-box text-muted"}}getActivityIconClassForRecord(e){return e.type==="pick"&&e.undone_at?"bi bi-x-circle-fill text-danger":this.getActivityIconClass(e.type)}getActivityBadgeClass(e){switch(e){case"pick":return"badge bg-success-subtle text-success border border-success-subtle";case"undo":return"badge bg-danger-subtle text-danger border border-danger-subtle";case"issue_created":return"badge bg-warning-subtle text-warning border border-warning-subtle";case"issue_resolved":return"badge bg-primary-subtle text-primary border border-primary-subtle";case"part_added":return"badge bg-success-subtle text-success border border-success-subtle";case"part_removed":return"badge bg-danger-subtle text-danger border border-danger-subtle";case"order_imported":return"badge bg-primary-subtle text-primary border border-primary-subtle";default:return"badge bg-secondary-subtle text-secondary"}}getActivityBadgeText(e){switch(e){case"pick":return"Pick";case"undo":return"Undo";case"issue_created":return"Issue";case"issue_resolved":return"Resolved";case"part_added":return"Part Added";case"part_removed":return"Part Removed";case"order_imported":return"Order Imported";default:return"Unknown"}}formatDateTimeLocal(e){let t=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0"),p=String(e.getHours()).padStart(2,"0"),v=String(e.getMinutes()).padStart(2,"0");return`${t}-${o}-${l}T${p}:${v}`}startOfDay(e){let t=new Date(e);return t.setHours(0,0,0,0),t}endOfDay(e){let t=new Date(e);return t.setHours(23,59,59,999),t}startOfWeek(e){let t=new Date(e),o=t.getDay(),l=t.getDate()-o+(o===0?-6:1);return t.setDate(l),t.setHours(0,0,0,0),t}endOfWeek(e){let t=new Date(e),o=t.getDay(),l=t.getDate()-o+(o===0?0:7);return t.setDate(l),t.setHours(23,59,59,999),t}startOfMonth(e){let t=new Date(e);return t.setDate(1),t.setHours(0,0,0,0),t}endOfMonth(e){let t=new Date(e);return t.setMonth(t.getMonth()+1,0),t.setHours(23,59,59,999),t}static{this.\u0275fac=function(t){return new(t||i)(Q(ce),Q(pe),Q(le))}}static{this.\u0275cmp=G({type:i,selectors:[["app-pick-history"]],standalone:!0,features:[Z],decls:57,vars:15,consts:[[1,"space-y-4"],[1,"page-header","d-flex","flex-column","flex-sm-row","justify-content-between","align-items-start","align-items-sm-center","gap-3"],[1,"page-title","d-flex","align-items-center","gap-2"],[1,"bi","bi-clock-history"],[1,"page-subtitle"],[1,"card"],[1,"card-header"],[1,"card-title","mb-0","d-flex","align-items-center","gap-2"],[1,"bi","bi-funnel"],[1,"card-body"],[1,"d-flex","flex-wrap","gap-2","mb-3"],["class","btn btn-outline-secondary btn-sm",3,"click",4,"ngFor","ngForOf"],[1,"row","g-3","mb-3"],[1,"col-12","col-sm-6"],["for","start-date",1,"form-label","d-flex","align-items-center","gap-1"],[1,"bi","bi-calendar"],["id","start-date","type","datetime-local",1,"form-control",3,"ngModelChange","ngModel"],["for","end-date",1,"form-label","d-flex","align-items-center","gap-1"],["id","end-date","type","datetime-local",1,"form-control",3,"ngModelChange","ngModel"],[1,"d-flex","flex-wrap","align-items-center","gap-3","mb-3"],[1,"fw-medium","small"],[1,"form-check"],["type","checkbox","id","showPicks",1,"form-check-input",3,"ngModelChange","ngModel"],["for","showPicks",1,"form-check-label"],["type","checkbox","id","showIssues",1,"form-check-input",3,"ngModelChange","ngModel"],["for","showIssues",1,"form-check-label"],["type","checkbox","id","showUndos",1,"form-check-input",3,"ngModelChange","ngModel"],["for","showUndos",1,"form-check-label"],["type","checkbox","id","showPartChanges",1,"form-check-input",3,"ngModelChange","ngModel"],["for","showPartChanges",1,"form-check-label"],["type","checkbox","id","showImports",1,"form-check-input",3,"ngModelChange","ngModel"],["for","showImports",1,"form-check-label"],[1,"d-flex","flex-column","flex-sm-row","gap-2"],[1,"btn","btn-primary",3,"click","disabled"],[1,"bi","bi-search","me-2"],["class","btn btn-outline-secondary",3,"disabled","click",4,"ngIf"],["class","alert alert-danger d-flex align-items-start gap-2","role","alert",4,"ngIf"],[4,"ngIf"],[1,"btn","btn-outline-secondary","btn-sm",3,"click"],[1,"btn","btn-outline-secondary",3,"click","disabled"],[1,"bi","bi-download","me-2"],["role","alert",1,"alert","alert-danger","d-flex","align-items-start","gap-2"],[1,"bi","bi-exclamation-triangle-fill","mt-1"],[1,"mb-0","small"],[1,"row","g-3","mb-4"],[1,"col-6","col-sm"],[1,"card","stat-card"],[1,"card-body","py-3"],[1,"stat-value",2,"font-size","1.5rem"],[1,"stat-label"],[1,"stat-value","text-danger",2,"font-size","1.5rem"],[1,"stat-value","text-primary",2,"font-size","1.5rem"],[1,"position-relative"],[1,"bi","bi-search","position-absolute","top-50","translate-middle-y",2,"left","12px"],["type","text","placeholder","Search within results by name, part number, SO number, location...",1,"form-control","ps-5",3,"ngModelChange","ngModel"],["class","btn btn-link position-absolute top-50 translate-middle-y p-0","style","right: 12px;",3,"click",4,"ngIf"],[1,"bi","bi-file-earmark-spreadsheet"],[1,"text-muted"],["class","text-center py-5",4,"ngIf"],["class","text-center py-5 text-muted",4,"ngIf"],[1,"btn","btn-link","position-absolute","top-50","translate-middle-y","p-0",2,"right","12px",3,"click"],[1,"bi","bi-x-lg","text-muted"],[1,"text-center","py-5"],[1,"bi","bi-arrow-clockwise","spin","fs-3","text-muted"],[1,"text-center","py-5","text-muted"],["class","mb-4",4,"ngFor","ngForOf"],[1,"d-flex","align-items-center","justify-content-between","pt-3","border-top"],[1,"btn","btn-outline-secondary","btn-sm",3,"click","disabled"],[1,"bi","bi-chevron-left","me-1"],[1,"text-muted","small"],[1,"bi","bi-chevron-right","ms-1"],[1,"mb-4"],[1,"text-muted","small","fw-semibold","mb-3","sticky-top","bg-body","py-1","d-flex","justify-content-between","align-items-center"],[1,"badge","bg-secondary"],[1,"d-flex","flex-column","gap-2"],["class","d-flex align-items-start gap-3 p-3 border rounded activity-item",4,"ngFor","ngForOf"],[1,"d-flex","align-items-start","gap-3","p-3","border","rounded","activity-item"],[1,"mt-1"],[1,"flex-grow-1","min-w-0"],[1,"d-flex","align-items-center","gap-2","flex-wrap"],[1,"fw-medium","d-flex","align-items-center","gap-1"],[1,"bi","bi-person","text-muted","small"],["class","badge bg-success-subtle text-success border border-success-subtle",4,"ngIf"],["class","badge bg-danger-subtle text-danger border border-danger-subtle text-decoration-line-through",4,"ngIf"],["class","badge bg-danger text-white",4,"ngIf"],["class","badge bg-danger-subtle text-danger border border-danger-subtle",4,"ngIf"],[1,"text-primary","text-decoration-none","small",3,"routerLink"],["class","badge bg-secondary-subtle text-secondary",4,"ngIf"],[1,"small","mb-0","mt-1"],["class","text-muted small mb-0 mt-1",4,"ngIf"],["class","text-muted small mb-0 mt-1 fst-italic",4,"ngIf"],[1,"text-muted","small","text-nowrap"],[1,"badge","bg-success-subtle","text-success","border","border-success-subtle"],[1,"badge","bg-danger-subtle","text-danger","border","border-danger-subtle","text-decoration-line-through"],[1,"badge","bg-danger","text-white"],[1,"badge","bg-danger-subtle","text-danger","border","border-danger-subtle"],[1,"badge","bg-secondary-subtle","text-secondary"],[1,"font-monospace","fw-medium"],["title","Copy",1,"btn","btn-sm","btn-ghost","p-0","ms-1","text-muted",3,"click"],[1,"bi"],["class","text-muted",4,"ngIf"],["class","text-danger small",4,"ngIf"],[1,"text-danger","small"],[1,"font-monospace","fw-medium","text-danger"],["class","btn btn-sm btn-ghost p-0 ms-1 text-muted","title","Copy",3,"click",4,"ngIf"],[1,"text-muted","small","mb-0","mt-1"],[1,"text-muted","small","mb-0","mt-1","fst-italic"]],template:function(t,o){t&1&&(a(0,"div",0)(1,"div",1)(2,"div")(3,"h1",2),b(4,"i",3),c(5," Activity History "),r(),a(6,"p",4),c(7,"View picks and issues by date range"),r()()(),a(8,"div",5)(9,"div",6)(10,"h5",7),b(11,"i",8),c(12," Date & Time Filter "),r()(),a(13,"div",9)(14,"div",10),h(15,xe,2,1,"button",11),r(),a(16,"div",12)(17,"div",13)(18,"label",14),b(19,"i",15),c(20," Start Date & Time "),r(),a(21,"input",16),T("ngModelChange",function(p){return E(o.startDate,p)||(o.startDate=p),p}),r()(),a(22,"div",13)(23,"label",17),b(24,"i",15),c(25," End Date & Time "),r(),a(26,"input",18),T("ngModelChange",function(p){return E(o.endDate,p)||(o.endDate=p),p}),r()()(),a(27,"div",19)(28,"span",20),c(29,"Show:"),r(),a(30,"div",21)(31,"input",22),T("ngModelChange",function(p){return E(o.showPicks,p)||(o.showPicks=p),p}),r(),a(32,"label",23),c(33,"Picks"),r()(),a(34,"div",21)(35,"input",24),T("ngModelChange",function(p){return E(o.showIssues,p)||(o.showIssues=p),p}),r(),a(36,"label",25),c(37,"Issues"),r()(),a(38,"div",21)(39,"input",26),T("ngModelChange",function(p){return E(o.showUndos,p)||(o.showUndos=p),p}),r(),a(40,"label",27),c(41,"Undos"),r()(),a(42,"div",21)(43,"input",28),T("ngModelChange",function(p){return E(o.showPartChanges,p)||(o.showPartChanges=p),p}),r(),a(44,"label",29),c(45,"Part Changes"),r()(),a(46,"div",21)(47,"input",30),T("ngModelChange",function(p){return E(o.showImports,p)||(o.showImports=p),p}),r(),a(48,"label",31),c(49,"Imports"),r()()(),a(50,"div",32)(51,"button",33),P("click",function(){return o.onSearch()}),b(52,"i",34),c(53),r(),h(54,ve,3,4,"button",35),r()()(),h(55,Ce,7,1,"div",36)(56,Ge,78,20,"ng-container",37),r()),t&2&&(n(15),m("ngForOf",o.datePresets),n(6),D("ngModel",o.startDate),n(5),D("ngModel",o.endDate),n(5),D("ngModel",o.showPicks),n(4),D("ngModel",o.showIssues),n(4),D("ngModel",o.showUndos),n(4),D("ngModel",o.showPartChanges),n(4),D("ngModel",o.showImports),n(4),m("disabled",o.loading),n(),B("spin",o.loading),n(),g(" ",o.loading?"Searching...":"Search"," "),n(),m("ngIf",o.hasSearched&&o.filteredActivities.length>0),n(),m("ngIf",o.error),n(),m("ngIf",o.hasSearched))},dependencies:[te,X,J,ee,ne,ie,de,ae,re,oe,se],styles:[".spin[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_spin 1s linear infinite}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.activity-item[_ngcontent-%COMP%]:hover{background-color:var(--bs-light)}.sticky-top[_ngcontent-%COMP%]{z-index:1}"]})}}return i})();export{ot as PickHistoryComponent};
