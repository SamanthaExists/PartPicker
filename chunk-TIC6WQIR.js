import{T as U,Y as x,ic as B}from"./chunk-2TFJQIGG.js";import{e as q}from"./chunk-DVOCWXDE.js";var H=(()=>{class E{constructor(o){this.supabase=o}parseEnhancedExcelFile(o){return q(this,null,function*(){let t=yield import("./chunk-2E7OKCGY.js");return new Promise(n=>{let i=new FileReader,a=[],r=[];i.onload=s=>{try{let l=new Uint8Array(s.target?.result),u=t.read(l,{type:"array"}),h=u.SheetNames.find(y=>y.toLowerCase().includes("order")||y.toLowerCase().includes("info")),f=u.SheetNames.find(y=>y.toLowerCase()==="parts"||y.toLowerCase()==="bom"),_="",O="",k="",d="",m="",e=1,C="";if(h){let y=u.Sheets[h],A=t.utils.sheet_to_json(y,{header:1});for(let L of A){if(!L||L.length<2)continue;let D=String(L[0]||"").toLowerCase().trim(),p=L[1];D.includes("so")&&D.includes("number")?_=String(p||"").trim():D.includes("po")&&D.includes("number")?O=String(p||"").trim():D.includes("customer")?k=String(p||"").trim():D.includes("order")&&D.includes("date")?d=this.parseDate(t,p):D.includes("due")&&D.includes("date")?m=this.parseDate(t,p):D.includes("tool")&&D.includes("qty")?e=parseInt(String(p||"1"),10)||1:D.includes("model")&&(C=String(p||"").trim())}}if(!_){let y=o.name.match(/SO[-_]?(\d+)/i);if(y)_=y[1];else{a.push("Could not determine SO number"),n({success:!1,errors:a,warnings:r});return}}let I=[];for(let y=1;y<=e;y++)I.push({tool_number:`${_}-${y}`,tool_model:C||void 0});let P=[];if(f){let y=u.Sheets[f],A=t.utils.sheet_to_json(y);P=this.processHierarchicalBOM(A,e)}else{let y=u.Sheets[u.SheetNames[0]],A=t.utils.sheet_to_json(y);P=this.processHierarchicalBOM(A,e)}P.length===0&&r.push("No line items found in the file"),n({success:!0,order:{so_number:_,po_number:O||void 0,customer_name:k||void 0,order_date:d||void 0,due_date:m||void 0,tools:I,line_items:P},errors:a,warnings:r})}catch(l){a.push(l instanceof Error?l.message:"Failed to parse Excel file"),n({success:!1,errors:a,warnings:r})}},i.onerror=()=>{a.push("Failed to read file"),n({success:!1,errors:a,warnings:r})},i.readAsArrayBuffer(o)})})}parseCsvFile(o){return q(this,null,function*(){let t=yield import("./chunk-2E7OKCGY.js");return new Promise(n=>{let i=new FileReader,a=[],r=[];i.onload=s=>{try{let l=s.target?.result,u=t.read(l,{type:"string"}),h=u.Sheets[u.SheetNames[0]],f=t.utils.sheet_to_json(h),_=o.name.match(/SO[-_]?(\d+)/i),O=_?_[1]:"Unknown";O==="Unknown"&&r.push("Could not determine SO number from filename");let k=[];for(let m of f){let e=this.findValue(m,["part","part number","part_number","partnumber","pn"]);if(!e)continue;let C=this.findValue(m,["description","desc","name"]),I=this.findValue(m,["location","loc","bin","position"]),P=parseInt(this.findValue(m,["qty","quantity","qty/unit","qty_per_unit"])||"1",10)||1,N=this.findValue(m,["classification","classification_type","type","class"]);k.push({part_number:String(e).trim(),description:C?String(C).trim():void 0,location:I?String(I).trim():void 0,qty_per_unit:P,total_qty_needed:P,classification_type:this.parseClassification(N)})}let d={so_number:O,tools:[{tool_number:`${O}-1`}],line_items:k};n({success:!0,order:d,errors:a,warnings:r})}catch(l){a.push(l instanceof Error?l.message:"Failed to parse CSV file"),n({success:!1,errors:a,warnings:r})}},i.onerror=()=>{a.push("Failed to read file"),n({success:!1,errors:a,warnings:r})},i.readAsText(o)})})}exportOrderToExcel(o,t,n,i){return q(this,null,function*(){let a=yield import("./chunk-2E7OKCGY.js"),r=a.utils.book_new(),s=[["SO Number",o.so_number],["PO Number",o.po_number||""],["Customer",o.customer_name||""],["Order Date",o.order_date||""],["Due Date",o.due_date||""],["Status",o.status],["Notes",o.notes||""]],l=a.utils.aoa_to_sheet(s);a.utils.book_append_sheet(r,l,"Order Info");let u=["Part Number","Description","Location","Qty/Unit","Total Needed","Total Picked","Remaining"],h=n.map(d=>[d.part_number,d.description||"",d.location||"",d.qty_per_unit,d.total_qty_needed,d.total_picked,d.remaining]),f=a.utils.aoa_to_sheet([u,...h]);a.utils.book_append_sheet(r,f,"Parts");let _=["Tool Number","Serial Number","Status"],O=t.map(d=>[d.tool_number,d.serial_number||"",d.status]),k=a.utils.aoa_to_sheet([_,...O]);a.utils.book_append_sheet(r,k,"Tools"),a.writeFile(r,`SO-${o.so_number}.xlsx`)})}exportOrdersSummaryToExcel(o){return q(this,null,function*(){let t=yield import("./chunk-2E7OKCGY.js"),n=t.utils.book_new(),i=["SO Number","PO Number","Customer","Status","Tools","Total Parts","Picked","Progress %","Order Date","Due Date"],a=o.map(s=>[s.so_number,s.po_number||"",s.customer_name||"",s.status,s.tools.length,s.total_items,s.picked_items,s.progress_percent,s.order_date||"",s.due_date||""]),r=t.utils.aoa_to_sheet([i,...a]);t.utils.book_append_sheet(n,r,"Orders"),t.writeFile(n,`Orders-Export-${new Date().toISOString().split("T")[0]}.xlsx`)})}exportItemsToOrderToExcel(o){return q(this,null,function*(){let t=yield import("./chunk-2E7OKCGY.js"),n=t.utils.book_new(),i=["Part Number","Description","Location","Qty Available","Total Needed","Remaining","Related Orders"],a=o.map(s=>[s.part_number,s.description||"",s.location||"",s.qty_available,s.total_needed,s.remaining,s.orders.map(l=>`SO-${l.so_number}`).join(", ")]),r=t.utils.aoa_to_sheet([i,...a]);t.utils.book_append_sheet(n,r,"Items to Order"),t.writeFile(n,`Items-To-Order-${new Date().toISOString().split("T")[0]}.xlsx`)})}exportPickHistoryToExcel(o,t,n,i,a){return q(this,null,function*(){let r=yield import("./chunk-2E7OKCGY.js"),s=r.utils.book_new(),l=["Picked At","Picked By","SO Number","Part Number","Tool Number","Qty Picked","Status","Deleted At","Deleted By","Notes"],u=o.map(c=>[new Date(c.picked_at).toLocaleString(),c.picked_by||"Unknown",`SO-${c.so_number}`,c.part_number,c.tool_number,c.qty_picked,c.status||"Active",c.undone_at?new Date(c.undone_at).toLocaleString():"",c.undone_by||"",c.notes||""]),h=r.utils.aoa_to_sheet([l,...u]);r.utils.book_append_sheet(s,h,"Pick History");let f=new Map;for(let c of o){if(c.status==="Deleted"||c.undone_at)continue;let S=f.get(c.part_number);S?(S.qty+=c.qty_picked,S.pickCount+=1,S.soNumbers.add(`SO-${c.so_number}`)):f.set(c.part_number,{qty:c.qty_picked,pickCount:1,soNumbers:new Set([`SO-${c.so_number}`])})}let _=["Part Number","Total Qty Picked","Pick Count","SO Numbers"],k=Array.from(f.entries()).sort((c,S)=>c[0].localeCompare(S[0])).map(([c,S])=>[c,S.qty,S.pickCount,Array.from(S.soNumbers).sort().join(", ")]),d=r.utils.aoa_to_sheet([_,...k]);if(r.utils.book_append_sheet(s,d,"Part Totals"),i&&i.length>0){let c=["Undone At","Undone By","Originally Picked At","Originally Picked By","SO Number","Part Number","Tool Number","Qty"],S=i.map(w=>[new Date(w.undone_at).toLocaleString(),w.undone_by||"Unknown",new Date(w.picked_at).toLocaleString(),w.picked_by||"Unknown",`SO-${w.so_number}`,w.part_number,w.tool_number,w.qty_picked]),M=r.utils.aoa_to_sheet([c,...S]);r.utils.book_append_sheet(s,M,"Undo History")}if(a&&a.length>0){let c=["Timestamp","Type","Performed By","SO Number","Part Number","Description"],S=a.map(w=>[new Date(w.created_at).toLocaleString(),w.type==="part_added"?"Part Added":w.type==="part_removed"?"Part Removed":w.type==="order_imported"?"Order Imported":w.type,w.performed_by||"",`SO-${w.so_number}`,w.part_number||"",w.description||""]),M=r.utils.aoa_to_sheet([c,...S]);r.utils.book_append_sheet(s,M,"Activity Log")}let m=o.filter(c=>!c.undone_at&&c.status!=="Deleted"),e=o.filter(c=>c.undone_at||c.status==="Deleted"),C=o.length,I=m.length,P=e.length,N=m.reduce((c,S)=>c+S.qty_picked,0),y=e.reduce((c,S)=>c+S.qty_picked,0),A=new Set(m.map(c=>c.picked_by||"Unknown")).size,L=new Set(m.map(c=>c.part_number)).size,D=i?i.length:0,p=a?a.length:0,Q=new Date(t).toLocaleDateString(),T=new Date(n).toLocaleDateString(),b=[["Pick History Report"],[],["Date Range",`${Q} - ${T}`],[],["Total Pick Records",C],["Active Picks",I],["Deleted Picks",P],[],["Total Qty Picked (Active)",N],["Total Qty Deleted",y],["Unique Users",A],["Unique Parts",L],["Total Undos (from pick_undos table)",D],["Total Activity Log Records",p],[],["Export Date",new Date().toLocaleString()]],g=r.utils.aoa_to_sheet(b);r.utils.book_append_sheet(s,g,"Summary");let F=new Date().toISOString().split("T")[0];r.writeFile(s,`Pick-History-${F}.xlsx`)})}downloadImportTemplate(o="single"){return q(this,null,function*(){let t=yield import("./chunk-2E7OKCGY.js"),n=t.utils.book_new();if(o==="single"){let a=[["Order Information",""],["",""],["SO Number","3137"],["PO Number","PO-12345"],["Customer","ACME Corporation"],["Tool Qty","5"],["Tool Model","230Q"],["Order Date","2024-01-15"],["Due Date","2024-02-15"]],r=t.utils.aoa_to_sheet(a);t.utils.book_append_sheet(n,r,"Order Info");let s=[["Part Number","Description","Location","Qty/Unit","Classification"],["ABC-123","Widget Assembly","A-01",2,"assembly"],["DEF-456","Spring Kit","B-02",1,"purchased"],["GHI-789","Gasket Set","C-03",4,"purchased"],["JKL-012","Bearing Pack","A-05",2,"manufactured"],["MNO-345","Seal Ring","D-01",3,""]],l=t.utils.aoa_to_sheet(s);l["!cols"]=[{wch:15},{wch:30},{wch:12},{wch:10},{wch:15}],t.utils.book_append_sheet(n,l,"Parts")}else if(o==="single-bom"){let a=[["Order Information",""],["",""],["SO Number","3137"],["PO Number","PO-12345"],["Customer","ACME Corporation"],["Tool Qty","5"],["Tool Model","230Q"],["Order Date","2024-01-15"],["Due Date","2024-02-15"]],r=t.utils.aoa_to_sheet(a);t.utils.book_append_sheet(n,r,"Order Info");let s=[["Level","Part Number","Description","Location","Qty/Unit","Classification"],[0,"230Q-TOOL","230Q Complete Tool Assembly","",1,"assembly"],[1,"FRAME-ASY","Frame Sub-Assembly","",1,"assembly"],[2,"ABC-123","Frame Plate","A-01",2,"manufactured"],[2,"DEF-456","Frame Bracket","B-02",4,"purchased"],[2,"GHI-789","Frame Bolt Kit","C-03",8,"purchased"],[1,"MOTOR-ASY","Motor Sub-Assembly","",1,"assembly"],[2,"JKL-012","Motor Unit","A-05",1,"purchased"],[2,"MNO-345","Motor Mount","D-01",2,"manufactured"],[2,"PQR-678","Wiring Harness","D-03",1,"purchased"],[1,"STU-901","Seal Ring (standalone leaf)","E-02",3,"purchased"]],l=t.utils.aoa_to_sheet(s);l["!cols"]=[{wch:6},{wch:18},{wch:35},{wch:12},{wch:10},{wch:15}],t.utils.book_append_sheet(n,l,"Parts")}else{let a=[["Order Information",""],["",""],["SO Number","3137"],["PO Number","PO-12345"],["Customer","ACME Corporation"],["Order Date","2024-01-15"],["Due Date","2024-02-15"],["",""],["Note: Each additional sheet represents a tool type with its own hierarchical BOM",""],["TIP: Include Level column for assembly hierarchy (0=root, 1=assembly, 2+=parts)",""]],r=t.utils.aoa_to_sheet(a);t.utils.book_append_sheet(n,r,"Order Info");let s=[["Qty","Level","Part Number","Description","Location","Qty/Unit","Classification"],[2,0,"230Q-TOOL","230Q Complete Tool Assembly","",1,"assembly"],["",1,"FRAME-230Q","230Q Frame Assembly","",1,"assembly"],["",2,"ABC-123","Frame Plate","A-01",2,"manufactured"],["",2,"DEF-456","230Q Spring Kit","B-02",1,"purchased"],["",2,"GHI-789","230Q Gasket Set","C-03",4,"purchased"],["",1,"QRS-230","230Q Motor Unit (standalone)","E-01",1,"purchased"]],l=t.utils.aoa_to_sheet(s);l["!cols"]=[{wch:6},{wch:6},{wch:18},{wch:35},{wch:12},{wch:10},{wch:15}],t.utils.book_append_sheet(n,l,"230Q");let u=[["Qty","Level","Part Number","Description","Location","Qty/Unit","Classification"],[1,0,"450Q-TOOL","450Q Complete Tool Assembly","",1,"assembly"],["",1,"HOUSING-450Q","450Q Housing Assembly","",1,"assembly"],["",2,"ABC-123","Housing Base","A-01",1,"manufactured"],["",2,"TUV-450","450Q Spring Kit","B-05",2,"purchased"],["",1,"WXY-450","450Q Electronics Module (standalone)","C-08",1,"purchased"],["",1,"ZAB-450","450Q Mounting Hardware","F-01",2,"purchased"]],h=t.utils.aoa_to_sheet(u);h["!cols"]=[{wch:6},{wch:6},{wch:18},{wch:35},{wch:12},{wch:10},{wch:15}],t.utils.book_append_sheet(n,h,"450Q")}this.createInstructionsSheet(t,n);let i;o==="single"?i="order-template-single.xlsx":o==="single-bom"?i="order-template-bom.xlsx":i="order-template-multi.xlsx",t.writeFile(n,i)})}createInstructionsSheet(o,t){let n=[["Import Template Instructions"],[""],["SINGLE TOOL TYPE FORMAT"],["========================="],["Use this format when all tools in the order have the same parts list."],[""],["Order Info Sheet:"],["- SO Number: Sales order number (required)"],["- PO Number: Customer purchase order number (optional)"],["- Customer: Customer name (optional)"],["- Tool Qty: Number of tools to create (default: 1)"],["- Tool Model: Model name for all tools (optional)"],["- Order Date: Order date in YYYY-MM-DD format (optional)"],["- Due Date: Due date in YYYY-MM-DD format (optional)"],[""],["Parts Sheet:"],["- Part Number: Part number (required)"],["- Description: Part description (optional)"],["- Location: Bin/location code (optional)"],["- Qty/Unit: Quantity needed per tool (required)"],[""],[""],["MULTIPLE TOOL TYPES FORMAT"],["==========================="],["Use this format when tools in the order have different parts lists."],[""],["Order Info Sheet:"],["- Same as single format, but no Tool Qty or Tool Model fields"],[""],['Tool Type Sheets (e.g., "230Q", "450Q"):'],["- Sheet name becomes the tool model"],['- First column "Qty" in first data row = number of tools of this type'],["- Level: (OPTIONAL) Hierarchy depth for BOM structure (0=root, 1=assembly, 2+=parts)"],["- Part Number: Part number (required)"],["- Description: Part description (optional)"],["- Location: Bin/location code (optional)"],["- Qty/Unit: Quantity needed per parent assembly (required)"],["- Classification: assembly, purchased, manufactured (optional)"],[""],['Example: Sheet "230Q" with Qty=2 creates tools 3137-1 and 3137-2'],['         Sheet "450Q" with Qty=1 creates tool 3137-3'],[""],["ASSEMBLY HIERARCHY IN MULTI-TOOL FORMAT:"],["- Include the Level column to define assembly structure"],["- Assemblies are auto-created in the Parts Catalog during import"],["- Only LEAF parts (no children) are imported for picking"],["- Quantities multiply through hierarchy (same as single-bom)"],[""],[""],["SINGLE TOOL TYPE WITH BOM HIERARCHY"],["===================================="],["Use this format when your parts list is a multi-level BOM (bill of materials)."],["The importer will extract only leaf parts and multiply quantities through the hierarchy."],[""],["Order Info Sheet:"],["- Same as the single tool type format above"],[""],["Parts Sheet:"],["- Level: Hierarchy depth (0 = root, 1 = top assembly, 2+ = sub-parts) (required for BOM)"],["- Part Number: Part number (required)"],["- Description: Part description (optional)"],["- Location: Bin/location code (optional)"],["- Qty/Unit: Quantity per parent assembly (required)"],["- Classification: assembly, purchased, manufactured (optional)"],[""],["How it works:"],["- \u2705 ASSEMBLIES ARE AUTO-CREATED in the Parts Catalog during import"],["- \u2705 Parent-child relationships are automatically established"],["- Only LEAF parts (parts with no children) are imported for picking"],["- Quantities are MULTIPLIED through the hierarchy"],["  Example: Assembly qty 2 x Child qty 3 = 6 effective parts to pick"],['- The top-level assembly (level 1) becomes the "Assembly Group" label'],["- The Level column is optional: if omitted, the sheet works as a flat parts list"],[""],["After import:"],["- View assemblies in the Unified Catalog page"],["- Order detail page shows assembly structure with diagram icon"],["- Future orders can reference the same assemblies"],[""],[""],["LEGACY FORMAT"],["============="],["The importer also supports the legacy format with tool columns:"],["- Single sheet with Part Number, Description, Location columns"],['- Tool-specific columns like "3137-1", "3137-2" for quantities'],["- Tools are created based on column headers"],[""],[""],["TIPS"],["===="],["- Delete this Instructions sheet before importing (optional)"],["- Part numbers are used to match parts across tool types"],["- Parts with the same part number will be combined"],["- Grey rows in Excel files are automatically skipped"]],i=o.utils.aoa_to_sheet(n);i["!cols"]=[{wch:70}],o.utils.book_append_sheet(t,i,"Instructions")}exportPartNumbersToExcel(o){return q(this,null,function*(){let t=yield import("./chunk-2E7OKCGY.js"),n=t.utils.book_new(),i=["Part Number"],a=o.map(l=>[l]),r=t.utils.aoa_to_sheet([i,...a]);r["!cols"]=[{wch:25}],t.utils.book_append_sheet(n,r,"Part Numbers");let s=new Date().toISOString().split("T")[0];t.writeFile(n,`part-numbers-${s}.xlsx`)})}findValue(o,t){for(let n of t)for(let i of Object.keys(o))if(i.toLowerCase().includes(n.toLowerCase()))return o[i]}parseDate(o,t){if(!t)return"";if(typeof t=="number"){let n=o.SSF.parse_date_code(t);if(n)return`${n.y}-${String(n.m).padStart(2,"0")}-${String(n.d).padStart(2,"0")}`}if(typeof t=="string"){let n=new Date(t);if(!isNaN(n.getTime()))return n.toISOString().split("T")[0]}return""}parseClassification(o){if(!o)return null;let t=String(o).toLowerCase().trim();return t==="purchased"||t==="purchase"||t==="buy"?"purchased":t==="manufactured"||t==="manufacture"||t==="make"?"manufactured":t==="assembly"||t==="assy"||t==="asm"?"assembly":t==="modified"||t==="mod"?"modified":null}processHierarchicalBOM(o,t=1){let n=[],i=[];for(let s of o){let l=this.findValue(s,["level","lvl"]);if(l===void 0)return this.processFlatBOM(o,t);let u=parseInt(String(l),10);if(isNaN(u))continue;let h=this.findValue(s,["part","part number","part_number","partnumber","pn"]);if(!h)continue;let f=this.findValue(s,["description","desc","name"]),_=this.findValue(s,["location","loc","bin","position"]),O=parseInt(this.findValue(s,["qty","quantity","qty/unit","qty_per_unit"])||"1",10)||1,k=this.findValue(s,["classification","classification_type","type","class"]),d={level:u,partNumber:String(h).trim(),description:f?String(f).trim():void 0,location:_?String(_).trim():void 0,qtyPerUnit:O,classification:k?String(k).trim():void 0,children:[]};for(;i.length>0&&i[i.length-1].level>=u;)i.pop();if(i.length>0){let m=i[i.length-1];d.parent=m,m.children.push(d)}else n.push(d);i.push(d)}let a=[],r=(s,l,u)=>{let h=u*s.qtyPerUnit,f=[...l,s.partNumber];if(s.children.length===0){let _=l.length>0?l[l.length-1]:void 0;a.push({part_number:s.partNumber,description:s.description,location:s.location,qty_per_unit:h,total_qty_needed:h*t,assembly_group:_,classification_type:this.parseClassification(s.classification)})}else for(let _ of s.children)r(_,f,h)};for(let s of n)r(s,[],1);return a}processFlatBOM(o,t){let n=[];for(let i of o){let a=this.findValue(i,["part","part number","part_number","partnumber","pn"]);if(!a)continue;let r=this.findValue(i,["description","desc","name"]),s=this.findValue(i,["location","loc","bin","position"]),l=parseInt(this.findValue(i,["qty","quantity","qty/unit","qty_per_unit"])||"1",10)||1,u=this.findValue(i,["classification","classification_type","type","class"]);n.push({part_number:String(a).trim(),description:r?String(r).trim():void 0,location:s?String(s).trim():void 0,qty_per_unit:l,total_qty_needed:l*t,classification_type:this.parseClassification(u)})}return n}exportFullBackupToExcel(){return q(this,null,function*(){let o=yield import("./chunk-2E7OKCGY.js"),t=o.utils.book_new(),n=(i,a="*")=>q(this,null,function*(){let r=[],l=0,u=!0;for(;u;){let{data:h,error:f}=yield this.supabase.from(i).select(a).range(l,l+1e3-1);if(f)throw f;h&&h.length>0?(r.push(...h),l+=1e3,u=h.length===1e3):u=!1}return r});try{let[i,a,r,s,l,u,h,f,_]=yield Promise.all([n("orders"),n("tools"),n("line_items"),n("picks"),n("issues"),n("parts_catalog"),n("bom_templates"),n("bom_template_items"),n("pick_undos")]);if(i.length>0){let d=i.map(e=>({id:e.id,so_number:e.so_number,po_number:e.po_number||"",customer_name:e.customer_name||"",tool_model:e.tool_model||"",quantity:e.quantity||"",order_date:e.order_date||"",due_date:e.due_date||"",status:e.status,notes:e.notes||"",created_at:e.created_at,updated_at:e.updated_at})),m=o.utils.json_to_sheet(d);o.utils.book_append_sheet(t,m,"Orders")}if(a.length>0){let d=a.map(e=>({id:e.id,order_id:e.order_id,tool_number:e.tool_number,serial_number:e.serial_number||"",tool_model:e.tool_model||"",status:e.status,created_at:e.created_at})),m=o.utils.json_to_sheet(d);o.utils.book_append_sheet(t,m,"Tools")}if(r.length>0){let d=r.map(e=>({id:e.id,order_id:e.order_id,part_number:e.part_number,description:e.description||"",location:e.location||"",qty_per_unit:e.qty_per_unit,total_qty_needed:e.total_qty_needed,qty_available:e.qty_available??"",tool_ids:e.tool_ids?JSON.stringify(e.tool_ids):"",created_at:e.created_at})),m=o.utils.json_to_sheet(d);o.utils.book_append_sheet(t,m,"Line Items")}if(s.length>0){let d=s.map(e=>({id:e.id,line_item_id:e.line_item_id,tool_id:e.tool_id,qty_picked:e.qty_picked,picked_by:e.picked_by||"",notes:e.notes||"",picked_at:e.picked_at,status:e.undone_at?"Deleted":"Active",undone_at:e.undone_at||"",undone_by:e.undone_by||""})),m=o.utils.json_to_sheet(d);o.utils.book_append_sheet(t,m,"Picks")}if(l.length>0){let d=l.map(e=>({id:e.id,line_item_id:e.line_item_id,order_id:e.order_id,issue_type:e.issue_type,description:e.description||"",reported_by:e.reported_by||"",status:e.status,created_at:e.created_at,resolved_at:e.resolved_at||"",resolved_by:e.resolved_by||""})),m=o.utils.json_to_sheet(d);o.utils.book_append_sheet(t,m,"Issues")}if(u.length>0){let d=u.map(e=>({id:e.id,part_number:e.part_number,description:e.description||"",default_location:e.default_location||"",created_at:e.created_at,updated_at:e.updated_at})),m=o.utils.json_to_sheet(d);o.utils.book_append_sheet(t,m,"Parts Catalog")}if(h.length>0){let d=h.map(e=>({id:e.id,name:e.name,tool_model:e.tool_model||"",created_at:e.created_at,updated_at:e.updated_at})),m=o.utils.json_to_sheet(d);o.utils.book_append_sheet(t,m,"BOM Templates")}if(f.length>0){let d=f.map(e=>({id:e.id,template_id:e.template_id,part_number:e.part_number,description:e.description||"",location:e.location||"",qty_per_unit:e.qty_per_unit})),m=o.utils.json_to_sheet(d);o.utils.book_append_sheet(t,m,"BOM Template Items")}if(_.length>0){let d=_.map(e=>({id:e.id,original_pick_id:e.original_pick_id,line_item_id:e.line_item_id,tool_id:e.tool_id,qty_picked:e.qty_picked,picked_by:e.picked_by||"",notes:e.notes||"",picked_at:e.picked_at,part_number:e.part_number,tool_number:e.tool_number,so_number:e.so_number,order_id:e.order_id,undone_by:e.undone_by,undone_at:e.undone_at})),m=o.utils.json_to_sheet(d);o.utils.book_append_sheet(t,m,"Pick Undos")}let O=o.utils.aoa_to_sheet([["Backup Date",new Date().toISOString()],["Application","Tool Pick List Tracker"],["Version","1.0"],[""],["Table","Record Count"],["Orders",i.length],["Tools",a.length],["Line Items",r.length],["Picks",s.length],["Issues",l.length],["Parts Catalog",u.length],["BOM Templates",h.length],["BOM Template Items",f.length],["Pick Undos",_.length]]);o.utils.book_append_sheet(t,O,"Metadata");let k=new Date().toISOString().split("T")[0];o.writeFile(t,`ToolPickList-Backup-${k}.xlsx`)}catch(i){throw console.error("Failed to export backup:",i),i}})}parseEnhancedExcelFileWithLegacySupport(o){return q(this,null,function*(){let t=yield import("./chunk-2E7OKCGY.js");return new Promise(n=>{let i=new FileReader,a=[],r=[];i.onload=s=>{try{let l=new Uint8Array(s.target?.result),u=t.read(l,{type:"array"}),h=u.SheetNames.find(p=>p.toLowerCase().includes("order")||p.toLowerCase().includes("info")),f=u.SheetNames.find(p=>p.toLowerCase()==="parts"||p.toLowerCase()==="bom"),_="",O="",k="",d="",m="",e=1,C="";if(h){let p=u.Sheets[h],Q=t.utils.sheet_to_json(p,{header:1});for(let T of Q){if(!T||T.length<2)continue;let b=String(T[0]||"").toLowerCase().trim(),g=T[1];b.includes("so")&&b.includes("number")?_=String(g||"").trim():b.includes("po")&&b.includes("number")?O=String(g||"").trim():b.includes("customer")?k=String(g||"").trim():b.includes("order")&&b.includes("date")?d=this.parseDate(t,g):b.includes("due")&&b.includes("date")?m=this.parseDate(t,g):b.includes("tool")&&b.includes("qty")?e=parseInt(String(g||"1"),10)||1:b.includes("model")&&(C=String(g||"").trim())}}if(!_){let p=o.name.match(/SO[-_]?(\d+)/i);if(p)_=p[1];else{a.push("Could not determine SO number"),n({success:!1,errors:a,warnings:r});return}}let I=[],P=[],N=[],y=f||u.SheetNames[0],A=u.Sheets[y],L=t.utils.sheet_to_json(A);if(L.length>0){let p=L[0],Q=Object.keys(p),T=/^(?:SO)?(\d+)-(\d+)$/i;for(let b of Q)b.match(T)&&N.push(b);if(N.length>0){r.push(`Detected legacy format with ${N.length} tool columns`),e=N.length;for(let b of N){let g=b.match(T);g&&P.push({tool_number:`${_}-${g[2]}`,tool_model:C||void 0})}}}if(P.length===0)for(let p=1;p<=e;p++)P.push({tool_number:`${_}-${p}`,tool_model:C||void 0});for(let p of L){let Q=this.findValue(p,["part","part number","part_number","partnumber","pn"]);if(!Q)continue;let T=this.findValue(p,["description","desc","name"]),b=this.findValue(p,["location","loc","bin","position"]);if(N.length>0){let g=0,F={};for(let c of N){let S=parseInt(String(p[c]||"0"),10)||0;if(S>0){g+=S;let M=c.match(/^(?:SO)?(\d+)-(\d+)$/i);M&&(F[`${_}-${M[2]}`]=S)}}g>0&&I.push({part_number:String(Q).trim(),description:T?String(T).trim():void 0,location:b?String(b).trim():void 0,qty_per_unit:1,total_qty_needed:g})}else{let g=parseInt(this.findValue(p,["qty","quantity","qty/unit","qty_per_unit"])||"1",10)||1;I.push({part_number:String(Q).trim(),description:T?String(T).trim():void 0,location:b?String(b).trim():void 0,qty_per_unit:g,total_qty_needed:g*e})}}I.length===0&&r.push("No line items found in the file"),n({success:!0,order:{so_number:_,po_number:O||void 0,customer_name:k||void 0,order_date:d||void 0,due_date:m||void 0,tools:P,line_items:I},errors:a,warnings:r})}catch(l){a.push(l instanceof Error?l.message:"Failed to parse Excel file"),n({success:!1,errors:a,warnings:r})}},i.onerror=()=>{a.push("Failed to read file"),n({success:!1,errors:a,warnings:r})},i.readAsArrayBuffer(o)})})}static{this.\u0275fac=function(t){return new(t||E)(x(B))}}static{this.\u0275prov=U({token:E,factory:E.\u0275fac,providedIn:"root"})}}return E})();export{H as a};
