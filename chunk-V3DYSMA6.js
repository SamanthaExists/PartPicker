import{T as c,Y as l,g as u,ic as h}from"./chunk-2TFJQIGG.js";import{e as r}from"./chunk-DVOCWXDE.js";var d=(()=>{class i{constructor(s){this.supabase=s,this.issuesSubject=new u([]),this.loadingSubject=new u(!0),this.errorSubject=new u(null),this.subscription=null,this.initialized=!1,this.issues$=this.issuesSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable()}ngOnDestroy(){this.cleanup()}cleanup(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}initialize(){return r(this,null,function*(){this.initialized||(this.initialized=!0,yield this.fetchIssues(),this.setupRealtimeSubscription())})}setupRealtimeSubscription(){this.subscription=this.supabase.channel("part-issues").on("postgres_changes",{event:"*",schema:"public",table:"part_issues"},()=>{this.fetchIssues()}).subscribe()}fetchIssues(){return r(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let{data:s,error:e}=yield this.supabase.from("part_issues").select("*").order("created_at",{ascending:!1});if(e)throw e;this.issuesSubject.next(s||[])}catch(s){this.errorSubject.next(s instanceof Error?s.message:"Failed to fetch part issues")}finally{this.loadingSubject.next(!1)}})}reportIssue(s,e,n,t){return r(this,null,function*(){try{let{data:a,error:o}=yield this.supabase.from("part_issues").insert({part_number:s,issue_type:e,description:n||null,reported_by:t||null,status:"open"}).select().single();if(o)throw o;return a}catch(a){return this.errorSubject.next(a instanceof Error?a.message:"Failed to report issue"),null}})}resolveIssue(s,e,n){return r(this,null,function*(){try{let{error:t}=yield this.supabase.from("part_issues").update({status:"resolved",resolved_at:new Date().toISOString(),resolved_by:e||null,resolution_notes:n||null}).eq("id",s);if(t)throw t;return!0}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to resolve issue"),!1}})}reopenIssue(s){return r(this,null,function*(){try{let{error:e}=yield this.supabase.from("part_issues").update({status:"open",resolved_at:null,resolved_by:null}).eq("id",s);if(e)throw e;return!0}catch(e){return this.errorSubject.next(e instanceof Error?e.message:"Failed to reopen issue"),!1}})}deleteIssue(s){return r(this,null,function*(){try{let{error:e}=yield this.supabase.from("part_issues").delete().eq("id",s);if(e)throw e;return!0}catch(e){return this.errorSubject.next(e instanceof Error?e.message:"Failed to delete issue"),!1}})}getIssuesForPart(s){return this.issuesSubject.getValue().filter(e=>e.part_number===s)}hasOpenIssue(s){return this.issuesSubject.getValue().some(e=>e.part_number===s&&e.status==="open")}getOpenIssue(s){return this.issuesSubject.getValue().find(e=>e.part_number===s&&e.status==="open")}static{this.\u0275fac=function(e){return new(e||i)(l(h))}}static{this.\u0275prov=c({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();export{d as a};
