import{T as h,Y as b,g as u,ic as f}from"./chunk-2TFJQIGG.js";import{a as l,b as p,e as n}from"./chunk-DVOCWXDE.js";var j=(()=>{class c{getCurrentParts(){return this.partsSubject.getValue()}constructor(e){this.supabase=e,this.partsSubject=new u([]),this.loadingSubject=new u(!0),this.errorSubject=new u(null),this.subscription=null,this.parts$=this.partsSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable(),this.fetchParts(),this.setupRealtimeSubscription()}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}setupRealtimeSubscription(){this.subscription=this.supabase.channel("parts-catalog-changes").on("postgres_changes",{event:"*",schema:"public",table:"parts_catalog"},()=>this.fetchParts()).subscribe()}fetchParts(){return n(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let e=[],t=1e3,r=0,s=!0;for(;s;){let{data:a,error:o}=yield this.supabase.from("parts_catalog").select("*").order("part_number",{ascending:!0}).range(r,r+t-1);if(o)throw o;a&&a.length>0?(e.push(...a),r+=t,s=a.length===t):s=!1}this.partsSubject.next(e)}catch(e){this.errorSubject.next(e instanceof Error?e.message:"Failed to fetch parts catalog")}finally{this.loadingSubject.next(!1)}})}checkForConflicts(e){let t=[],r=this.partsSubject.getValue(),s=new Map(r.map(a=>[a.part_number,a]));for(let a of e){let o=s.get(a.part_number);if(o){let i=o.description||"",d=a.description||"",m=o.default_location||"",g=a.location||"";(i!==d||m!==g)&&t.push({part_number:a.part_number,saved_description:o.description,import_description:a.description||null,saved_location:o.default_location,import_location:a.location||null,action:null})}}return t}applyConflictResolutions(e){return n(this,null,function*(){try{let t=e.filter(r=>r.action==="update").map(r=>this.supabase.from("parts_catalog").update({description:r.import_description,default_location:r.import_location,updated_at:new Date().toISOString()}).eq("part_number",r.part_number));return t.length>0&&(yield Promise.all(t),yield this.fetchParts()),!0}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to apply conflict resolutions"),!1}})}savePartsFromImport(e,t=!0){return n(this,null,function*(){try{let r=this.partsSubject.getValue(),s=new Map(r.map(i=>[i.part_number,i])),a=e.filter(i=>!t||!s.has(i.part_number)).map(i=>({part_number:i.part_number,description:i.description||null,default_location:i.location||null}));if(a.length===0)return!0;let{error:o}=yield this.supabase.from("parts_catalog").upsert(a,{onConflict:"part_number",ignoreDuplicates:t});if(o)throw o;return yield this.fetchParts(),!0}catch(r){return this.errorSubject.next(r instanceof Error?r.message:"Failed to save parts to catalog"),!1}})}getPart(e){return this.partsSubject.getValue().find(r=>r.part_number===e)}searchParts(e){let t=this.partsSubject.getValue(),r=e.toLowerCase();return t.filter(s=>s.part_number.toLowerCase().includes(r)||s.description?.toLowerCase().includes(r))}addPart(e,t,r){return n(this,null,function*(){try{let{data:s,error:a}=yield this.supabase.from("parts_catalog").insert({part_number:e,description:t||null,default_location:r||null}).select().single();if(a)throw a;return yield this.fetchParts(),s}catch(s){return this.errorSubject.next(s instanceof Error?s.message:"Failed to add part to catalog"),null}})}updatePart(e,t){return n(this,null,function*(){try{let{error:r}=yield this.supabase.from("parts_catalog").update(p(l({},t),{updated_at:new Date().toISOString()})).eq("part_number",e);if(r)throw r;return yield this.fetchParts(),!0}catch(r){return this.errorSubject.next(r instanceof Error?r.message:"Failed to update part"),!1}})}deletePart(e){return n(this,null,function*(){try{let{error:t}=yield this.supabase.from("parts_catalog").delete().eq("part_number",e);if(t)throw t;return yield this.fetchParts(),!0}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to delete part"),!1}})}static{this.\u0275fac=function(t){return new(t||c)(b(f))}}static{this.\u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();export{j as a};
