import{T as b,Y as d,g as o,ic as p}from"./chunk-2TFJQIGG.js";import{a as c,b as l,e as i}from"./chunk-DVOCWXDE.js";var j=(()=>{class a{constructor(e){this.supabase=e,this.issuesSubject=new o([]),this.loadingSubject=new o(!0),this.errorSubject=new o(null),this.subscription=null,this.currentOrderId=null,this.issues$=this.issuesSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable()}ngOnDestroy(){this.cleanup()}cleanup(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}loadIssuesForOrder(e){return i(this,null,function*(){this.cleanup(),this.currentOrderId=e,yield this.fetchIssues(e),this.setupRealtimeSubscription(e)})}loadAllIssues(){return i(this,null,function*(){this.cleanup(),this.currentOrderId=null,yield this.fetchAllIssues(),this.setupGlobalRealtimeSubscription()})}setupRealtimeSubscription(e){this.subscription=this.supabase.channel(`issues-${e}`).on("postgres_changes",{event:"*",schema:"public",table:"issues",filter:`order_id=eq.${e}`},()=>{this.currentOrderId&&this.fetchIssues(this.currentOrderId)}).subscribe()}setupGlobalRealtimeSubscription(){this.subscription=this.supabase.channel("all-issues").on("postgres_changes",{event:"*",schema:"public",table:"issues"},()=>{this.fetchAllIssues()}).subscribe()}fetchIssues(e){return i(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let{data:s,error:r}=yield this.supabase.from("issues").select(`
          *,
          line_items (*),
          orders (*)
        `).eq("order_id",e).order("created_at",{ascending:!1});if(r)throw r;let t=(s||[]).map(n=>l(c({},n),{line_item:n.line_items,order:n.orders}));this.issuesSubject.next(t)}catch(s){this.errorSubject.next(s instanceof Error?s.message:"Failed to fetch issues")}finally{this.loadingSubject.next(!1)}})}fetchAllIssues(){return i(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let{data:e,error:s}=yield this.supabase.from("issues").select(`
          *,
          line_items (*),
          orders (*)
        `).order("created_at",{ascending:!1});if(s)throw s;let r=(e||[]).map(t=>l(c({},t),{line_item:t.line_items,order:t.orders}));this.issuesSubject.next(r)}catch(e){this.errorSubject.next(e instanceof Error?e.message:"Failed to fetch issues")}finally{this.loadingSubject.next(!1)}})}reportIssue(e,s,r,t,n){return i(this,null,function*(){try{let{data:u,error:h}=yield this.supabase.from("issues").insert({line_item_id:e,order_id:s,issue_type:r,description:t||null,reported_by:n||null,status:"open"}).select().single();if(h)throw h;return u}catch(u){return this.errorSubject.next(u instanceof Error?u.message:"Failed to report issue"),null}})}resolveIssue(e,s,r){return i(this,null,function*(){try{let{error:t}=yield this.supabase.from("issues").update({status:"resolved",resolved_at:new Date().toISOString(),resolved_by:s||null,resolution_notes:r||null}).eq("id",e);if(t)throw t;return!0}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to resolve issue"),!1}})}reopenIssue(e){return i(this,null,function*(){try{let{error:s}=yield this.supabase.from("issues").update({status:"open",resolved_at:null,resolved_by:null}).eq("id",e);if(s)throw s;return!0}catch(s){return this.errorSubject.next(s instanceof Error?s.message:"Failed to reopen issue"),!1}})}hasOpenIssue(e){return this.issuesSubject.getValue().some(r=>r.line_item_id===e&&r.status==="open")}static{this.\u0275fac=function(s){return new(s||a)(d(p))}}static{this.\u0275prov=b({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();export{j as a};
