import{a as w}from"./chunk-XHNAPF2T.js";import{a as S}from"./chunk-FQB7FWF7.js";import{T as f,Y as _,g as b,ic as g}from"./chunk-DEIGHZUX.js";import{a as h,b as m,i as c}from"./chunk-P2VZOJAX.js";var M=(()=>{class u{constructor(e,t,r){this.supabase=e,this.demoMode=t,this.demoData=r,this.ordersSubject=new b([]),this.loadingSubject=new b(!0),this.errorSubject=new b(null),this.subscription=null,this.orders$=this.ordersSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable(),this.fetchOrders(),this.demoMode.isDemoMode()||this.setupRealtimeSubscription()}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}setupRealtimeSubscription(){this.subscription=this.supabase.channel("orders-changes").on("postgres_changes",{event:"*",schema:"public",table:"orders"},()=>this.fetchOrders()).on("postgres_changes",{event:"*",schema:"public",table:"picks"},()=>this.fetchOrders()).subscribe()}fetchOrders(){return c(this,null,function*(){try{if(this.loadingSubject.next(!0),this.errorSubject.next(null),this.demoMode.isDemoMode()){let s=this.demoData.getOrders().map(i=>{let l=this.demoData.getTools(i.id),o=this.demoData.getLineItems(i.id),n=0,d=0;o.forEach(p=>{n+=p.qty_per_unit*l.length;let j=this.demoData.getPicks(p.id);d+=j.reduce((x,D)=>x+D.qty_picked,0)});let y=n>0?Math.round(d/n*100):0;return m(h({},i),{tools:l,total_items:n,picked_items:d,progress_percent:y})});this.ordersSubject.next(s),this.loadingSubject.next(!1);return}let{data:e,error:t}=yield this.supabase.from("orders").select(`
          *,
          tools (*),
          order_progress (total_items, picked_items, progress_percent)
        `).order("created_at",{ascending:!1});if(t)throw t;let r=(e||[]).map(a=>{let s=a.order_progress?.[0];return m(h({},a),{tools:a.tools||[],total_items:s?.total_items??0,picked_items:s?.picked_items??0,progress_percent:s?.progress_percent??0})});this.ordersSubject.next(r)}catch(e){this.errorSubject.next(e instanceof Error?e.message:"Failed to fetch orders")}finally{this.loadingSubject.next(!1)}})}createOrder(e){return c(this,null,function*(){try{let{data:t,error:r}=yield this.supabase.from("orders").insert({so_number:e.so_number,po_number:e.po_number||null,customer_name:e.customer_name||null,order_date:e.order_date||null,due_date:e.due_date||null,status:e.status||"active",notes:e.notes||null}).select().single();if(r)throw r;return t}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to create order"),null}})}importOrder(e){return c(this,null,function*(){try{let{data:t,error:r}=yield this.supabase.from("orders").insert({so_number:e.so_number,po_number:e.po_number||null,customer_name:e.customer_name||null,order_date:e.order_date||null,due_date:e.due_date||null,estimated_ship_date:e.estimated_ship_date||null,status:"active"}).select().single();if(r)throw r;let a=[];if(e.tools.length>0){let s=e.tools.map(o=>({order_id:t.id,tool_number:o.tool_number,serial_number:o.serial_number||null,tool_model:o.tool_model||null,status:"pending"})),{data:i,error:l}=yield this.supabase.from("tools").insert(s).select("id, tool_number");if(l)throw l;a=i||[]}if(e.line_items.length>0){let s=new Map;for(let o of a)s.set(`temp-${o.tool_number}`,o.id);let i=e.line_items.map(o=>{let n=null;return o.tool_ids&&o.tool_ids.length>0&&(n=o.tool_ids.map(d=>s.get(d)).filter(d=>d!==void 0),n.length===0&&(n=null)),{order_id:t.id,part_number:o.part_number,description:o.description||null,location:o.location||null,qty_per_unit:o.qty_per_unit,total_qty_needed:o.total_qty_needed,tool_ids:n,assembly_group:o.assembly_group||null}}),{error:l}=yield this.supabase.from("line_items").insert(i);if(l)throw l}return yield this.fetchOrders(),t}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to import order"),null}})}updateOrder(e,t){return c(this,null,function*(){try{let{error:r}=yield this.supabase.from("orders").update(m(h({},t),{updated_at:new Date().toISOString()})).eq("id",e);if(r)throw r;return!0}catch(r){return this.errorSubject.next(r instanceof Error?r.message:"Failed to update order"),!1}})}deleteOrder(e){return c(this,null,function*(){try{let{error:t}=yield this.supabase.from("orders").delete().eq("id",e);if(t)throw t;return yield this.fetchOrders(),!0}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to delete order"),!1}})}getOrder(e){return c(this,null,function*(){try{if(this.demoMode.isDemoMode()){let i=this.demoData.getOrders().find(n=>n.id===e)||null,l=this.demoData.getTools(e),o=this.demoData.getLineItems(e);return{order:i,tools:l,lineItems:o}}let[t,r,a]=yield Promise.all([this.supabase.from("orders").select("*").eq("id",e).single(),this.supabase.from("tools").select("*").eq("order_id",e).order("tool_number"),this.supabase.from("line_items").select("*").eq("order_id",e).order("part_number")]);if(t.error)throw t.error;if(r.error)throw r.error;if(a.error)throw a.error;return{order:t.data,tools:r.data||[],lineItems:a.data||[]}}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to fetch order"),{order:null,tools:[],lineItems:[]}}})}addTool(e,t,r,a){return c(this,null,function*(){try{let{data:s,error:i}=yield this.supabase.from("tools").insert({order_id:e,tool_number:t,serial_number:r||null,tool_model:a||null,status:"pending"}).select().single();if(i)throw i;return s}catch(s){return this.errorSubject.next(s instanceof Error?s.message:"Failed to add tool"),null}})}deleteTool(e){return c(this,null,function*(){try{let{error:t}=yield this.supabase.from("tools").delete().eq("id",e);if(t)throw t;return!0}catch(t){return this.errorSubject.next(t instanceof Error?t.message:"Failed to delete tool"),!1}})}generateNextToolNumber(e,t){let r=t.map(s=>{let i=s.tool_number.match(/-(\d+)$/);return i?parseInt(i[1],10):0}).filter(s=>!isNaN(s)),a=r.length>0?Math.max(...r)+1:1;return`${e}-${a}`}static{this.\u0275fac=function(t){return new(t||u)(_(g),_(S),_(w))}}static{this.\u0275prov=f({token:u,factory:u.\u0275fac,providedIn:"root"})}}return u})();export{M as a};
