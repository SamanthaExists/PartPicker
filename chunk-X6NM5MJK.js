import{T as y,Y as w,g as m,ic as S}from"./chunk-2TFJQIGG.js";import{a as f,b as g,e as b}from"./chunk-DVOCWXDE.js";var x=(()=>{class h{constructor(t){this.supabase=t,this.picksSubject=new m([]),this.lineItemsWithPicksSubject=new m([]),this.loadingSubject=new m(!0),this.errorSubject=new m(null),this.subscription=null,this.currentOrderId=null,this.picks$=this.picksSubject.asObservable(),this.lineItemsWithPicks$=this.lineItemsWithPicksSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable()}ngOnDestroy(){this.cleanup()}cleanup(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}loadPicksForOrder(t){return b(this,null,function*(){this.cleanup(),this.currentOrderId=t,yield this.fetchPicks(t),this.setupRealtimeSubscription(t)})}setupRealtimeSubscription(t){this.subscription=this.supabase.channel(`picks-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"picks"},()=>{this.currentOrderId&&this.fetchPicks(this.currentOrderId)}).subscribe()}fetchPicks(t){return b(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let{data:s,error:r}=yield this.supabase.from("line_items").select("*").eq("order_id",t).order("part_number");if(r)throw r;let e=(s||[]).map(i=>i.id),o=[];if(e.length>0){let n=0,d=!0;for(;d;){let{data:a,error:p}=yield this.supabase.from("picks").select("*").in("line_item_id",e).order("picked_at",{ascending:!1}).range(n,n+1e3-1);if(p)throw p;a&&a.length>0?(o.push(...a),n+=1e3,d=a.length===1e3):d=!1}}this.picksSubject.next(o);let c=new Map;for(let i of o){let n=c.get(i.line_item_id)||[];n.push(i),c.set(i.line_item_id,n)}let l=(s||[]).map(i=>{let n=c.get(i.id)||[],a=n.filter(p=>!p.undone_at).reduce((p,u)=>p+u.qty_picked,0);return g(f({},i),{picks:n,total_picked:a,remaining:Math.max(0,i.total_qty_needed-a)})});this.lineItemsWithPicksSubject.next(l)}catch(s){this.errorSubject.next(s instanceof Error?s.message:"Failed to fetch picks")}finally{this.loadingSubject.next(!1)}})}recordPick(t,s,r,e,o){return b(this,null,function*(){try{let{data:c}=yield this.supabase.from("line_items").select("total_qty_needed").eq("id",t).single(),{data:l}=yield this.supabase.from("picks").select("qty_picked").eq("line_item_id",t).is("undone_at",null),n=(l||[]).reduce((u,_)=>u+_.qty_picked,0)+r,d=c?.total_qty_needed||0,{data:a,error:p}=yield this.supabase.from("picks").insert({line_item_id:t,tool_id:s,qty_picked:r,picked_by:e||null,notes:o||null}).select().single();if(p)throw p;return n>d?g(f({},a),{overPickWarning:`Over-picked! ${n} picked but only ${d} needed. Someone may have picked this item at the same time.`}):a}catch(c){return this.errorSubject.next(c instanceof Error?c.message:"Failed to record pick"),null}})}undoPick(t,s){return b(this,null,function*(){try{let e=this.picksSubject.getValue().find(u=>u.id===t);if(!e)throw new Error("Pick not found");let c=this.lineItemsWithPicksSubject.getValue().find(u=>u.id===e.line_item_id),{data:l}=yield this.supabase.from("tools").select("tool_number, order_id").eq("id",e.tool_id).single(),i="",n=c?.order_id||"";if(l){n=n||l.order_id;let{data:u}=yield this.supabase.from("orders").select("so_number").eq("id",l.order_id).single();i=u?.so_number||""}let d=s||"Unknown",{error:a}=yield this.supabase.from("pick_undos").insert({original_pick_id:e.id,line_item_id:e.line_item_id,tool_id:e.tool_id,qty_picked:e.qty_picked,picked_by:e.picked_by,notes:e.notes,picked_at:e.picked_at,part_number:c?.part_number||"",tool_number:l?.tool_number||"",so_number:i,order_id:n,undone_by:d});if(a)throw a;let{error:p}=yield this.supabase.from("picks").update({undone_at:new Date().toISOString(),undone_by:d}).eq("id",t);if(p)throw p;return!0}catch(r){return this.errorSubject.next(r instanceof Error?r.message:"Failed to undo pick"),!1}})}getPicksForTool(t){let s=this.picksSubject.getValue(),r=new Map;for(let e of s)if(e.tool_id===t&&!e.undone_at){let o=r.get(e.line_item_id)||0;r.set(e.line_item_id,o+e.qty_picked)}return r}getPickHistory(t,s){return this.picksSubject.getValue().filter(e=>e.line_item_id===t&&e.tool_id===s).sort((e,o)=>new Date(o.picked_at).getTime()-new Date(e.picked_at).getTime())}getLastPick(t,s){let e=this.getPickHistory(t,s).filter(o=>!o.undone_at);return e.length>0?e[0]:null}getPicksForAllTools(){let t=this.picksSubject.getValue(),s=new Map;for(let r of t)if(!r.undone_at){s.has(r.tool_id)||s.set(r.tool_id,new Map);let e=s.get(r.tool_id),o=e.get(r.line_item_id)||0;e.set(r.line_item_id,o+r.qty_picked)}return s}recordPickForLineItem(t,s,r,e){return b(this,null,function*(){try{let{data:o,error:c}=yield this.supabase.from("line_items").select("order_id").eq("id",t).single();if(c||!o)throw new Error("Line item not found");let{data:l,error:i}=yield this.supabase.from("tools").select("id").eq("order_id",o.order_id).order("tool_number").limit(1);if(i||!l||l.length===0)throw new Error("No tools found for order");let n=l[0].id;return this.recordPick(t,n,s,r,e)}catch(o){return this.errorSubject.next(o instanceof Error?o.message:"Failed to record pick"),null}})}batchUpdateAllocations(t,s,r,e){return b(this,null,function*(){try{let o=this.getPicksForAllTools();for(let[c,l]of s){let n=o.get(c)?.get(t)||0,d=l-n;if(d>0){let{error:a}=yield this.supabase.from("picks").insert({line_item_id:t,tool_id:c,qty_picked:d,picked_by:r||null,notes:e||null});if(a)throw a}else if(d<0){let p=this.getPickHistory(t,c).filter(_=>!_.undone_at),u=Math.abs(d);for(let _ of p){if(u<=0)break;if(_.qty_picked<=u){let{error:k}=yield this.supabase.from("picks").update({undone_at:new Date().toISOString(),undone_by:r||"System"}).eq("id",_.id);if(k)throw k;u-=_.qty_picked}else{let k=_.qty_picked-u,{error:v}=yield this.supabase.from("picks").update({undone_at:new Date().toISOString(),undone_by:r||"System"}).eq("id",_.id);if(v)throw v;let{error:j}=yield this.supabase.from("picks").insert({line_item_id:t,tool_id:c,qty_picked:k,picked_by:_.picked_by,notes:_.notes});if(j)throw j;u=0}}}}return!0}catch(o){return this.errorSubject.next(o instanceof Error?o.message:"Failed to update allocations"),!1}})}static{this.\u0275fac=function(s){return new(s||h)(w(S))}}static{this.\u0275prov=y({token:h,factory:h.\u0275fac,providedIn:"root"})}}return h})(),I=(()=>{class h{constructor(t){this.supabase=t,this.activitiesSubject=new m([]),this.loadingSubject=new m(!0),this.subscription=null,this.activities$=this.activitiesSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.fetchActivity(),this.setupRealtimeSubscription()}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}setupRealtimeSubscription(){this.subscription=this.supabase.channel("activity-feed").on("postgres_changes",{event:"INSERT",schema:"public",table:"picks"},()=>this.fetchActivity()).on("postgres_changes",{event:"INSERT",schema:"public",table:"pick_undos"},()=>this.fetchActivity()).subscribe()}fetchActivity(){return b(this,null,function*(){try{this.loadingSubject.next(!0);let{data:t,error:s}=yield this.supabase.from("picks").select(`
          id,
          qty_picked,
          picked_by,
          picked_at,
          line_items!inner (
            part_number,
            order_id,
            orders!inner (
              so_number
            )
          )
        `).is("undone_at",null).order("picked_at",{ascending:!1}).limit(20);s&&console.error("Error fetching activity:",s);let r=(t||[]).map(i=>({id:i.id,type:"pick",message:`Picked ${i.qty_picked}x ${i.line_items.part_number}`,timestamp:i.picked_at,user:i.picked_by||"Unknown",order_id:i.line_items.order_id,so_number:i.line_items.orders.so_number})),{data:e,error:o}=yield this.supabase.from("pick_undos").select("*").order("undone_at",{ascending:!1}).limit(20);o&&console.error("Error fetching undo activity:",o);let c=(e||[]).map(i=>({id:i.id,type:"pick_undo",message:`Undid ${i.qty_picked}x ${i.part_number}`,timestamp:i.undone_at,user:i.undone_by||"Unknown",order_id:i.order_id,so_number:i.so_number})),l=[...r,...c].sort((i,n)=>new Date(n.timestamp).getTime()-new Date(i.timestamp).getTime()).slice(0,20);this.activitiesSubject.next(l)}catch(t){console.error("Error fetching activity:",t),this.activitiesSubject.next([])}finally{this.loadingSubject.next(!1)}})}static{this.\u0275fac=function(s){return new(s||h)(w(S))}}static{this.\u0275prov=y({token:h,factory:h.\u0275fac,providedIn:"root"})}}return h})();export{x as a,I as b};
