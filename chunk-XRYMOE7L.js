import{T as O,Y as x,g as u,ic as M}from"./chunk-2TFJQIGG.js";import{a as C,e as k}from"./chunk-DVOCWXDE.js";var P=(()=>{class a{constructor(i){this.supabase=i,this.partsSubject=new u([]),this.loadingSubject=new u(!0),this.errorSubject=new u(null),this.subscription=null,this.parts$=this.partsSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable(),this.fetchParts(),this.setupRealtimeSubscription()}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}refresh(){this.fetchParts()}setupRealtimeSubscription(){this.subscription=this.supabase.channel("consolidated-parts").on("postgres_changes",{event:"*",schema:"public",table:"line_items"},()=>this.fetchParts()).on("postgres_changes",{event:"*",schema:"public",table:"picks"},()=>this.fetchParts()).on("postgres_changes",{event:"*",schema:"public",table:"orders"},()=>this.fetchParts()).subscribe()}fetchParts(){return k(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null),console.log("[ConsolidatedParts] Starting fetch...");let{data:i,error:l}=yield this.supabase.from("orders").select("id, so_number, order_date, tool_model").eq("status","active");if(console.log("[ConsolidatedParts] Orders query result:",{count:i?.length,error:l}),l)throw l;let p=(i||[]).map(e=>e.id),g=new Map;for(let e of i||[])g.set(e.id,{so_number:e.so_number,order_date:e.order_date,tool_model:e.tool_model});if(console.log("[ConsolidatedParts] Active order IDs:",p.length),p.length===0){console.log("[ConsolidatedParts] No active orders found"),this.partsSubject.next([]);return}let{data:m,error:y}=yield this.supabase.from("tools").select("id, order_id, tool_number, tool_model").in("order_id",p);if(console.log("[ConsolidatedParts] Tools query result:",{count:m?.length,error:y}),y)throw y;let w=new Map;for(let e of m||[])w.set(e.id,{order_id:e.order_id,tool_number:e.tool_number,tool_model:e.tool_model});let d=[];{let r=0,o=!0;for(;o;){let{data:s,error:n}=yield this.supabase.from("line_items").select("*").in("order_id",p).range(r,r+1e3-1);if(n)throw n;s&&s.length>0?(d.push(...s),r+=1e3,o=s.length===1e3):o=!1}}let q=[...new Set(d.map(e=>e.part_id).filter(Boolean))],S=new Map;if(q.length>0){let{data:e,error:r}=yield this.supabase.from("parts").select("id, classification_type, is_assembly, is_modified").in("id",q);if(r)console.warn("[ConsolidatedParts] Error fetching parts:",r);else if(e)for(let o of e)S.set(o.id,{classification_type:o.classification_type,is_assembly:o.is_assembly||!1,is_modified:o.is_modified||!1})}let f=(d||[]).map(e=>e.id),v=[];if(f.length>0){let r=[];for(let s=0;s<f.length;s+=50)r.push(f.slice(s,s+50));let o=yield Promise.all(r.map(s=>this.supabase.from("picks").select("line_item_id, tool_id, qty_picked").in("line_item_id",s).is("undone_at",null)));for(let s of o){if(s.error)throw s.error;s.data&&v.push(...s.data)}}let I=new Map;for(let e of v){let r=`${e.line_item_id}:${e.tool_id}`,o=I.get(r)||0;I.set(r,o+e.qty_picked)}let h=new Map;for(let e of d||[]){let r=g.get(e.order_id),o=Array.from(w.entries()).filter(([n,c])=>c.order_id===e.order_id).map(([n,c])=>C({toolId:n},c)),s=e.tool_ids&&e.tool_ids.length>0?o.filter(n=>e.tool_ids.includes(n.toolId)):o;for(let n of s){let c=`${e.id}:${n.toolId}`,_=I.get(c)||0,b=h.get(e.part_number),j=e.part_id?S.get(e.part_id):null;b?(b.total_needed+=e.qty_per_unit,b.total_picked+=_,b.remaining=b.total_needed-b.total_picked,b.orders.push({order_id:e.order_id,so_number:r?.so_number||"Unknown",order_date:r?.order_date||null,tool_model:n.tool_model||r?.tool_model||null,tool_id:n.toolId,tool_number:n.tool_number,needed:e.qty_per_unit,picked:_,line_item_id:e.id,assembly_group:e.assembly_group})):h.set(e.part_number,{part_number:e.part_number,description:e.description,location:e.location,qty_available:e.qty_available??null,qty_on_order:e.qty_on_order??null,total_needed:e.qty_per_unit,total_picked:_,remaining:e.qty_per_unit-_,classification_type:j?.classification_type??null,is_assembly:j?.is_assembly??!1,is_modified:j?.is_modified??!1,orders:[{order_id:e.order_id,so_number:r?.so_number||"Unknown",order_date:r?.order_date||null,tool_model:n.tool_model||r?.tool_model||null,tool_id:n.toolId,tool_number:n.tool_number,needed:e.qty_per_unit,picked:_,line_item_id:e.id,assembly_group:e.assembly_group}]})}}for(let e of h.values())e.orders.sort((r,o)=>{if(r.order_date!==null&&o.order_date!==null){let s=new Date(r.order_date).getTime()-new Date(o.order_date).getTime();if(s!==0)return s}else{if(r.order_date!==null&&o.order_date===null)return-1;if(r.order_date===null&&o.order_date!==null)return 1}return r.so_number.localeCompare(o.so_number,void 0,{numeric:!0})});let t=Array.from(h.values()).sort((e,r)=>e.part_number.localeCompare(r.part_number));this.partsSubject.next(t),console.log("[ConsolidatedParts] Successfully loaded",t.length,"parts")}catch(i){console.error("[ConsolidatedParts] Error:",i),this.errorSubject.next(i instanceof Error?i.message:"Failed to fetch parts")}finally{this.loadingSubject.next(!1)}})}static{this.\u0275fac=function(l){return new(l||a)(x(M))}}static{this.\u0275prov=O({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})(),A=(()=>{class a{constructor(i){this.supabase=i,this.itemsSubject=new u([]),this.onOrderItemsSubject=new u([]),this.loadingSubject=new u(!0),this.errorSubject=new u(null),this.subscription=null,this.items$=this.itemsSubject.asObservable(),this.onOrderItems$=this.onOrderItemsSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.error$=this.errorSubject.asObservable(),this.fetchItems(),this.setupRealtimeSubscription()}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}setupRealtimeSubscription(){this.subscription=this.supabase.channel("items-to-order").on("postgres_changes",{event:"*",schema:"public",table:"line_items"},()=>this.fetchItems()).on("postgres_changes",{event:"*",schema:"public",table:"picks"},()=>this.fetchItems()).on("postgres_changes",{event:"*",schema:"public",table:"orders"},()=>this.fetchItems()).subscribe()}fetchItems(){return k(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null),console.log("[ItemsToOrder] Starting fetch...");let{data:i,error:l}=yield this.supabase.from("orders").select("id, so_number, tool_model").eq("status","active");if(console.log("[ItemsToOrder] Orders query result:",{count:i?.length,error:l}),l)throw l;let p=(i||[]).map(t=>t.id),g=new Map;for(let t of i||[])g.set(t.id,{so_number:t.so_number,tool_model:t.tool_model});if(p.length===0){this.itemsSubject.next([]),this.onOrderItemsSubject.next([]);return}let m=[];{let e=0,r=!0;for(;r;){let{data:o,error:s}=yield this.supabase.from("line_items").select("*").in("order_id",p).range(e,e+1e3-1);if(s)throw s;o&&o.length>0?(m.push(...o),e+=1e3,r=o.length===1e3):r=!1}}let y=[...new Set(m.map(t=>t.part_id).filter(Boolean))],w=new Map;if(y.length>0){let{data:t,error:e}=yield this.supabase.from("parts").select("id, classification_type, is_assembly, is_modified").in("id",y);if(e)console.warn("[ItemsToOrder] Error fetching parts:",e);else if(t)for(let r of t)w.set(r.id,{classification_type:r.classification_type,is_assembly:r.is_assembly||!1,is_modified:r.is_modified||!1})}let d=(m||[]).map(t=>t.id),q=[];if(d.length>0){let e=[];for(let o=0;o<d.length;o+=50)e.push(d.slice(o,o+50));let r=yield Promise.all(e.map(o=>this.supabase.from("picks").select("line_item_id, qty_picked").in("line_item_id",o)));for(let o of r){if(o.error)throw o.error;o.data&&q.push(...o.data)}}let S=new Map;for(let t of q){let e=S.get(t.line_item_id)||0;S.set(t.line_item_id,e+t.qty_picked)}let f=new Map;for(let t of m||[]){let e=S.get(t.id)||0,r=t.total_qty_needed-e;if(r<=0)continue;let o=f.get(t.part_number),s=t.part_id?w.get(t.part_id):null;if(o){o.total_needed+=t.total_qty_needed,o.total_picked+=e,o.remaining=o.total_needed-o.total_picked,o.qty_on_order===null&&t.qty_on_order!==null&&(o.qty_on_order=t.qty_on_order),o.qty_to_order=Math.max(0,o.remaining-o.qty_available-(o.qty_on_order??0));let n=g.get(t.order_id);o.orders.push({order_id:t.order_id,so_number:n?.so_number||"Unknown",tool_model:n?.tool_model||null,needed:t.total_qty_needed,picked:e})}else{let n=t.qty_on_order??0,c=t.qty_available||0,_=g.get(t.order_id);f.set(t.part_number,{part_number:t.part_number,description:t.description,location:t.location,qty_available:c,qty_on_order:t.qty_on_order??null,total_needed:t.total_qty_needed,total_picked:e,remaining:r,qty_to_order:Math.max(0,r-c-n),classification_type:s?.classification_type??null,is_assembly:s?.is_assembly??!1,is_modified:s?.is_modified??!1,orders:[{order_id:t.order_id,so_number:_?.so_number||"Unknown",tool_model:_?.tool_model||null,needed:t.total_qty_needed,picked:e}]})}}let v=Array.from(f.values()),I=v.filter(t=>t.qty_to_order>0).sort((t,e)=>t.part_number.localeCompare(e.part_number)),h=v.filter(t=>t.qty_on_order!==null&&t.qty_on_order>0).sort((t,e)=>t.part_number.localeCompare(e.part_number));this.itemsSubject.next(I),this.onOrderItemsSubject.next(h),console.log("[ItemsToOrder] Successfully loaded",I.length,"items to order,",h.length,"on order")}catch(i){console.error("[ItemsToOrder] Error:",i),this.errorSubject.next(i instanceof Error?i.message:"Failed to fetch items to order")}finally{this.loadingSubject.next(!1)}})}static{this.\u0275fac=function(l){return new(l||a)(x(M))}}static{this.\u0275prov=O({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();export{P as a,A as b};
