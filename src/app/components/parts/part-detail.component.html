<div class="modal-header">
  <h5 class="modal-title">{{ isNew ? 'Create New Part' : 'Part Details' }}</h5>
  <button type="button" class="btn-close" (click)="activeModal.dismiss()"></button>
</div>

<div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="!loading">
    <!-- Edit/View Toolbar -->
    <div class="d-flex justify-content-end mb-3" *ngIf="!isNew">
      <button *ngIf="!isEditing" class="btn btn-sm btn-outline-secondary" (click)="isEditing = true">
        <i class="bi bi-pencil me-1"></i> Edit
      </button>
      <div *ngIf="isEditing" class="btn-group btn-group-sm">
        <button class="btn btn-outline-secondary" (click)="cancel()">
          <i class="bi bi-x me-1"></i> Cancel
        </button>
        <button class="btn btn-primary" (click)="save()" [disabled]="!editForm.part_number.trim()">
          <i class="bi bi-check-lg me-1"></i> Save
        </button>
      </div>
    </div>

    <!-- Part Information -->
    <div class="card mb-3">
      <div class="card-header">
        <h6 class="mb-0">Part Information</h6>
      </div>
      <div class="card-body">
        <div *ngIf="isEditing">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Part Number *</label>
              <input type="text" class="form-control" [(ngModel)]="editForm.part_number" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Classification</label>
              <select class="form-select" [(ngModel)]="editForm.classification_type">
                <option value="">Select classification</option>
                <option value="purchased">Purchased</option>
                <option value="manufactured">Manufactured</option>
                <option value="assembly">Assembly</option>
                <option value="modified">Modified</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <input type="text" class="form-control" [(ngModel)]="editForm.description" />
            </div>
            <div class="col-12">
              <label class="form-label">Default Location</label>
              <input type="text" class="form-control" [(ngModel)]="editForm.default_location" />
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea class="form-control" rows="3" [(ngModel)]="editForm.notes"></textarea>
            </div>
          </div>
        </div>

        <div *ngIf="!isEditing && part">
          <div class="d-flex align-items-center gap-2 mb-2">
            <h4 class="mb-0 font-monospace">{{ part.part_number }}</h4>
            <app-classification-badge [classification]="part.classification_type"></app-classification-badge>
          </div>
          <div *ngIf="part.description" class="mb-2">
            <span class="text-muted">Description: </span>
            <span>{{ part.description }}</span>
          </div>
          <div *ngIf="part.default_location" class="mb-2">
            <span class="text-muted">Location: </span>
            <span class="fw-medium">üìç {{ part.default_location }}</span>
          </div>
          <div *ngIf="part.notes" class="mb-2">
            <span class="text-muted">Notes: </span>
            <span>{{ part.notes }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Base Part (for modified parts) -->
    <div *ngIf="!isNew && isModified && part?.base_part" class="card mb-3">
      <div class="card-header">
        <h6 class="mb-0">Based On</h6>
      </div>
      <div class="card-body">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-box-seam text-muted"></i>
          <span class="font-monospace fw-medium">{{ part.base_part.part_number }}</span>
          <i class="bi bi-arrow-right text-muted"></i>
          <span class="font-monospace fw-medium">{{ part.part_number }}</span>
          <span *ngIf="part.base_part.description" class="text-muted small ms-2">
            ({{ part.base_part.description }})
          </span>
        </div>
      </div>
    </div>

    <!-- Modification Chain -->
    <div *ngIf="!isNew && (isModified || (part?.modifications && part.modifications.length > 0))">
      <app-modification-chain [partId]="partId!"></app-modification-chain>
    </div>

    <!-- BOM (for assemblies) -->
    <div *ngIf="!isNew && isAssembly" class="mt-3">
      <app-bom-editor [partId]="partId!" (update)="loadPart()"></app-bom-editor>
    </div>

    <!-- Where Used -->
    <div *ngIf="!isNew && part?.used_in && part.used_in.length > 0" class="card mt-3">
      <div class="card-header">
        <h6 class="mb-0">Where Used ({{ part.used_in.length }})</h6>
      </div>
      <div class="card-body">
        <div class="list-group">
          <div *ngFor="let rel of part.used_in" class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-box-seam text-muted"></i>
                <div>
                  <div class="font-monospace fw-medium">{{ rel.part.part_number }}</div>
                  <div *ngIf="rel.part.description" class="small text-muted">
                    {{ rel.part.description }}
                  </div>
                </div>
              </div>
              <div class="text-muted small">
                Qty: {{ rel.quantity }}
                <span *ngIf="rel.reference_designator" class="ms-2">({{ rel.reference_designator }})</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-footer" *ngIf="isNew">
  <button type="button" class="btn btn-secondary" (click)="activeModal.dismiss()">Cancel</button>
  <button type="button" class="btn btn-primary" (click)="save()" [disabled]="!editForm.part_number.trim()">
    Create Part
  </button>
</div>
